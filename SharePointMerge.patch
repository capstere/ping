--- /mnt/data/IPTCompile_orig/IPTCompile/zz_IPTCompile/Main.ps1	2026-02-05 09:01:05.000000000 +0000
+++ /mnt/data/IPTCompile_ex/IPTCompile/zz_IPTCompile/Main.ps1	2026-02-10 12:07:45.342094272 +0000
@@ -1,3478 +1,3602 @@
-Ôªø#region Imports & Config
-if ([Threading.Thread]::CurrentThread.ApartmentState -ne 'STA') {
-    $exe = Join-Path $PSHome 'powershell.exe'
-    $scriptPath = if ($PSCommandPath) { $PSCommandPath } else { $MyInvocation.MyCommand.Path }
-    Start-Process -FilePath $exe -ArgumentList "-NoProfile -STA -ExecutionPolicy Bypass -File `"$scriptPath`""
-    exit
-}
-
-Add-Type -AssemblyName System.Windows.Forms
-try { [System.Windows.Forms.Application]::EnableVisualStyles() } catch {}
-Add-Type -AssemblyName System.Drawing
-Add-Type -AssemblyName System.ComponentModel
-try {
-    Add-Type -AssemblyName 'Microsoft.VisualBasic' -ErrorAction SilentlyContinue
-} catch {}
-
-$scriptPath = if ($PSCommandPath) { $PSCommandPath } else { $MyInvocation.MyCommand.Path }
-$ScriptRootPath = [System.IO.Path]::GetDirectoryName([System.IO.Path]::GetFullPath($scriptPath))
-$PSScriptRoot = $ScriptRootPath
-try {
-    $cwd = (Get-Location).Path
-    Write-Host ("[EXEC] Script={0} | ScriptRoot={1} | CWD={2}" -f $scriptPath, $ScriptRootPath, $cwd)
-} catch {}
-$modulesRoot = Join-Path $ScriptRootPath 'Modules'
-
-
-# Patch: samlade layoutkonstanter
-$Layout = @{ SignatureCell = 'B47' }
-
-. (Join-Path $modulesRoot 'Config.ps1') -ScriptRoot $ScriptRootPath
-. (Join-Path $modulesRoot 'Splash.ps1')
-. (Join-Path $modulesRoot 'UiStyling.ps1')
-. (Join-Path $modulesRoot 'Logging.ps1')
-
-try {
-    $netRoot = ($env:IPT_NETWORK_ROOT + '').Trim()
-    $iptRoot = ($global:IPT_ROOT_EFFECTIVE + '').Trim()
-    $iptSrc  = ($global:IPT_ROOT_SOURCE + '').Trim()
-    $logPath = ($global:LogPath + '').Trim()
-    $jsonl   = ($global:StructuredLogPath + '').Trim()
-
-    if (-not $netRoot) { $netRoot = '<empty>' }
-    if (-not $iptRoot) { $iptRoot = '<empty>' }
-    if (-not $iptSrc)  { $iptSrc  = '<empty>' }
-    if (-not $logPath) { $logPath = '<empty>' }
-    if (-not $jsonl)   { $jsonl   = '<empty>' }
-
-    $msg = "Sanity: IPT_NETWORK_ROOT=$netRoot | IPT_ROOT_EFFECTIVE=$iptRoot | IPT_ROOT_SOURCE=$iptSrc | LogPath=$logPath | StructuredLogPath=$jsonl"
-    try { Gui-Log -Text $msg -Severity 'Info' -Category 'SANITY' } catch { Write-Host $msg }
-} catch { }
-
-. (Join-Path $modulesRoot 'DataHelpers.ps1')
-. (Join-Path $modulesRoot 'SignatureHelpers.ps1')
-. (Join-Path $modulesRoot 'RuleEngine.ps1')
-
-$global:SpEnabled = Get-ConfigFlag -Name 'EnableSharePoint' -Default $true -ConfigOverride $Config
-
-
-$global:StartupReady = $true
-$configStatus = $null
-
-try {
-
-    $configStatus = Test-Config
-    if ($configStatus) {
-        foreach ($err in $configStatus.Errors) { Gui-Log "‚ùå Konfig-fel: $err" 'Error' }
-        foreach ($warn in $configStatus.Warnings) { Gui-Log "‚ö†Ô∏è Konfig-varning: $warn" 'Warn' }
-        if (-not $configStatus.Ok) {
-            $global:StartupReady = $false
-            try { [System.Windows.Forms.MessageBox]::Show("Startkontroll misslyckades. Se logg f√∂r detaljer.","Startkontroll") | Out-Null } catch {}
-        }
-    }
-} catch { Gui-Log "‚ùå Test-Config misslyckades: $($_.Exception.Message)" 'Error'; $global:StartupReady = $false }
-
-$Host.UI.RawUI.WindowTitle = "Startar‚Ä¶"
-Show-Splash "Laddar PnP.PowerShell‚Ä¶"
-$env:PNPPOWERSHELL_UPDATECHECK = 'Off'  # st√§ng av update-check tidigt
-
-$global:SpConnected = $false
-$global:SpError     = $null
-
-try {
-    $null = Get-PackageProvider -Name "NuGet" -ForceBootstrap -ErrorAction SilentlyContinue
-} catch {}
-
-if ($global:SpEnabled) {
-    try {
-        Update-Splash "Laddar..."
-        Import-Module PnP.PowerShell -ErrorAction Stop
-    } catch {
-        try {
-            Gui-Log "‚ÑπÔ∏è PowerShell-modulen saknas, installerar modulen..." 'Info'
-            Install-Module PnP.PowerShell -MaximumVersion 1.12.0 -Scope CurrentUser -Force -AllowClobber -ErrorAction Stop
-            Update-Splash "Laddar..."
-            Import-Module PnP.PowerShell -ErrorAction Stop
-        } catch {
-            $global:SpError = "PnP-install/import misslyckades: $($_.Exception.Message)"
-        }
-    }
-} else {
-    $global:SpError = 'SharePoint avst√§ngt i Config'
-    try { Gui-Log "‚ÑπÔ∏è SharePoint √§r avst√§ngt i konfigurationen." 'Info' } catch {}
-}
-try { $null = Ensure-EPPlus -Version '4.5.3.3' } catch { Gui-Log "‚ö†Ô∏è EPPlus-f√∂rkontroll misslyckades: $($_.Exception.Message)" 'Warn' }
-
-if ($global:SpEnabled -and -not $global:SpError) {
-    try {
-        Update-Splash "Ansluter till SharePoint"
-        Connect-PnPOnline -Url $global:SP_SiteUrl `
-                          -Tenant $global:SP_Tenant `
-                          -ClientId $global:SP_ClientId `
-                          -CertificateBase64Encoded $global:SP_CertBase64 `
-                          -ErrorAction Stop
-        $global:SpConnected = $true
-    } catch {
-        $msg = "Connect-PnPOnline misslyckades: $($_.Exception.Message)"
-        Update-Splash $msg
-        $global:SpError = $msg
-    }
-}
-
-#endregion Imports & Config
-
-#region GUI Construction
-
-Update-Splash "Startar gr√§nssnitt‚Ä¶"
-Close-Splash
-$form = New-Object System.Windows.Forms.Form
-$form.Text = "$ScriptVersion"
-$form.AutoScaleMode = 'Dpi'
-$form.Size = New-Object System.Drawing.Size(860,910)
-$form.MinimumSize = New-Object System.Drawing.Size(860,910)
-$form.StartPosition = 'CenterScreen'
-$form.BackColor = [System.Drawing.Color]::WhiteSmoke
-$form.AutoScroll  = $false
-$form.MaximizeBox = $false
-$form.Padding     = New-Object System.Windows.Forms.Padding(8)
-$form.Font        = New-Object System.Drawing.Font('Segoe UI',10)
-$form.KeyPreview = $true
-$form.add_KeyDown({ if ($_.KeyCode -eq [System.Windows.Forms.Keys]::Escape) { $form.Close() } })
-
-# ---------- Menyrad ----------
-$menuStrip = New-Object System.Windows.Forms.MenuStrip
-$menuStrip.Dock='Top'; $menuStrip.GripStyle='Hidden'
-$menuStrip.ImageScalingSize = New-Object System.Drawing.Size(20,20)
-$menuStrip.Padding = New-Object System.Windows.Forms.Padding(8,6,0,6)
-$menuStrip.Font = New-Object System.Drawing.Font('Segoe UI',10)
-$miArkiv   = New-Object System.Windows.Forms.ToolStripMenuItem('üóÇÔ∏è Arkiv')
-$miVerktyg = New-Object System.Windows.Forms.ToolStripMenuItem('üõ†Ô∏è Verktyg')
-$miSettings= New-Object System.Windows.Forms.ToolStripMenuItem('‚öôÔ∏è Inst√§llningar')
-$miHelp    = New-Object System.Windows.Forms.ToolStripMenuItem('üìñ Instruktioner')
-$miAbout   = New-Object System.Windows.Forms.ToolStripMenuItem('‚ÑπÔ∏è Om')
-$miScan  = New-Object System.Windows.Forms.ToolStripMenuItem('üîç S√∂k filer')
-$miBuild = New-Object System.Windows.Forms.ToolStripMenuItem('‚úÖ Skapa rapport')
-$miExit  = New-Object System.Windows.Forms.ToolStripMenuItem('‚ùå Avsluta')
-
-# Rensa ev. gamla undermenyer
-$miArkiv.DropDownItems.Clear()
-$miVerktyg.DropDownItems.Clear()
-$miSettings.DropDownItems.Clear()
-$miHelp.DropDownItems.Clear()
-
-# ----- Arkiv -----
-$miNew         = New-Object System.Windows.Forms.ToolStripMenuItem('üÜï Nytt')
-$miOpenRecent  = New-Object System.Windows.Forms.ToolStripMenuItem('üìÇ √ñppna senaste rapport')
-$miArkiv.DropDownItems.AddRange(@(
-    $miNew,
-    $miOpenRecent,
-    (New-Object System.Windows.Forms.ToolStripSeparator),
-    $miExit
-))
-
-
-# ----- Verktyg -----
-$miScript1   = New-Object System.Windows.Forms.ToolStripMenuItem('üìú Kontrollprovsfilskript')
-$miScript2   = New-Object System.Windows.Forms.ToolStripMenuItem('üìÖ √Ñndra datum-prefix f√∂r filnamn')
-$miScript3   = New-Object System.Windows.Forms.ToolStripMenuItem('üìÖ TBD')
-$miToggleSign = New-Object System.Windows.Forms.ToolStripMenuItem('‚úÖ Aktivera Seal Test-signatur')
-$miVerktyg.DropDownItems.AddRange(@(
-    $miScript1,
-    $miScript2,
-    $miScript3,
-    $miToggleSign
-))
-
-# ----- Inst√§llningar -----
-$miTheme = New-Object System.Windows.Forms.ToolStripMenuItem('üé® Tema')
-$miLightTheme = New-Object System.Windows.Forms.ToolStripMenuItem('‚òÄÔ∏è Ljust (default)')
-$miDarkTheme  = New-Object System.Windows.Forms.ToolStripMenuItem('üåô M√∂rkt')
-$miTheme.DropDownItems.AddRange(@($miLightTheme,$miDarkTheme))
-$miSettings.DropDownItems.Add($miTheme)
-
-# ----- Instruktioner -----
-$miShowInstr   = New-Object System.Windows.Forms.ToolStripMenuItem('üìñ Visa instruktioner')
-$miFAQ         = New-Object System.Windows.Forms.ToolStripMenuItem('‚ùì Vanliga fr√•gor (FAQ)')
-$miHelpDlg     = New-Object System.Windows.Forms.ToolStripMenuItem('üÜò Hj√§lp')
-$miHelp.DropDownItems.AddRange(@($miShowInstr,$miFAQ,$miHelpDlg))
-
-$miGenvagar = New-Object System.Windows.Forms.ToolStripMenuItem('üîó Genv√§gar')
-$ShortcutGroups = Get-ConfigValue -Name 'ShortcutGroups' -Default $null -ConfigOverride $Config
-if (-not $ShortcutGroups) {
-    # Fallback om config saknar genv√§gar
-    $ShortcutGroups = @{
-        'üóÇÔ∏è IPT-mappar' = @(
-            @{ Text='üìÇ IPT - P√ÖG√ÖENDE K√ñRNINGAR';        Target='N:\QC\QC-1\IPT\2. IPT - P√ÖG√ÖENDE K√ñRNINGAR' },
-            @{ Text='üìÇ IPT - KLART F√ñR SAMMANST√ÑLLNING'; Target='N:\QC\QC-1\IPT\3. IPT - KLART F√ñR SAMMANST√ÑLLNING' },
-            @{ Text='üìÇ IPT - KLART F√ñR GRANSKNING';      Target='N:\QC\QC-1\IPT\4. IPT - KLART F√ñR GRANSKNING' },
-            @{ Text='üìÇ SPT Macro Assay';                 Target='N:\QC\QC-0\SPT\SPT macros\Assay' }
-        )
-        'üìÑ Dokument' = @(
-            @{ Text='üß∞ Utrustningslista';    Target=$UtrustningListPath },
-            @{ Text='üß™ Kontrollprovsfil';    Target=$RawDataPath }
-        )
-        'üåê L√§nkar' = @(
-            @{ Text='‚ö° IPT App';              Target='https://apps.powerapps.com/play/e/default-771c9c47-7f24-44dc-958e-34f8713a8394/a/fd340dbd-bbbf-470b-b043-d2af4cb62c83' },
-            @{ Text='üåê MES';                  Target='http://mes.cepheid.pri/camstarportal/?domain=CEPHEID.COM' },
-            @{ Text='üåê CSV Uploader';         Target='http://auw2wgxtpap01.cepaws.com/Welcome.aspx' },
-            @{ Text='üåê BMRAM';                Target='https://cepheid62468.coolbluecloud.com/' },
-            @{ Text='üåê Agile';                Target='https://agileprod.cepheid.com/Agile/default/login-cms.jsp' }
-        )
-    }
-}
-
-foreach ($grp in $ShortcutGroups.GetEnumerator()) {
-
-    $grpMenu = New-Object System.Windows.Forms.ToolStripMenuItem($grp.Key)
-    foreach ($entry in $grp.Value) { Add-ShortcutItem -Parent $grpMenu -Text $entry.Text -Target $entry.Target }
-    [void]$miGenvagar.DropDownItems.Add($grpMenu)
-
-}
-
-$miOm = New-Object System.Windows.Forms.ToolStripMenuItem('‚ÑπÔ∏è Om det h√§r verktyget'); $miAbout.DropDownItems.Add($miOm)
-$menuStrip.Items.AddRange(@($miArkiv,$miVerktyg,$miGenvagar,$miSettings,$miHelp,$miAbout))
-$form.MainMenuStrip=$menuStrip
-
-# ---------- Header ----------
-$panelHeader = New-Object System.Windows.Forms.Panel
-$panelHeader.Dock='Top'; $panelHeader.Height=64
-$panelHeader.BackColor=[System.Drawing.Color]::SteelBlue
-$panelHeader.Padding = New-Object System.Windows.Forms.Padding(10,8,10,8)
-
-$picLogo = New-Object System.Windows.Forms.PictureBox
-$picLogo.Dock='Left'; $picLogo.Width=50; $picLogo.BorderStyle='FixedSingle'
-if(Test-Path $ikonSokvag){ $picLogo.Image=[System.Drawing.Image]::FromFile($ikonSokvag); $picLogo.SizeMode='Zoom' }
-$form.add_FormClosed({ try { if ($picLogo.Image) { $picLogo.Image.Dispose() } } catch {} })
-
-$lblTitle = New-Object System.Windows.Forms.Label
-$lblTitle.Text="$ScriptVersion - Skapa excelrapport f√∂r en lot."
-$lblTitle.ForeColor=[System.Drawing.Color]::White
-$lblTitle.Font = New-Object System.Drawing.Font('Segoe UI Semibold',13)
-$lblTitle.TextAlign = [System.Drawing.ContentAlignment]::MiddleLeft
-$lblTitle.Padding = New-Object System.Windows.Forms.Padding(8,0,0,0)
-$lblTitle.Dock='Fill'
-
-$panelHeader.Controls.Add($lblTitle)
-$panelHeader.Controls.Add($picLogo)
-
-# ---------- S√∂k-rad ----------
-
-$tlSearch = New-Object System.Windows.Forms.TableLayoutPanel
-$tlSearch.Dock='Top'; $tlSearch.AutoSize=$true; $tlSearch.AutoSizeMode='GrowAndShrink'
-$tlSearch.Padding = New-Object System.Windows.Forms.Padding(0,10,0,8)
-$tlSearch.ColumnCount=3
-[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
-[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
-[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,130)))
-
-$lblLSP = New-Object System.Windows.Forms.Label
-$lblLSP.Text='LSP:'; $lblLSP.Anchor='Left'; $lblLSP.AutoSize=$true
-$lblLSP.Margin = New-Object System.Windows.Forms.Padding(0,6,8,0)
-$txtLSP = New-Object System.Windows.Forms.TextBox
-$txtLSP.Dock='Fill'
-$txtLSP.Margin = New-Object System.Windows.Forms.Padding(0,2,10,2)
-$btnScan = New-Object System.Windows.Forms.Button
-$btnScan.Text='S√∂k filer'; $btnScan.Dock='Fill'; Set-AccentButton $btnScan -Primary
-$btnScan.Margin= New-Object System.Windows.Forms.Padding(0,2,0,2)
-
-$tlSearch.Controls.Add($lblLSP,0,0)
-$tlSearch.Controls.Add($txtLSP,1,0)
-$tlSearch.Controls.Add($btnScan,2,0)
-
-$pLog = New-Object System.Windows.Forms.Panel
-$pLog.Dock='Top'; $pLog.Height=220; $pLog.Padding=New-Object System.Windows.Forms.Padding(0,0,0,8)
-
-$outputBox = New-Object System.Windows.Forms.TextBox
-$outputBox.Multiline=$true; $outputBox.ScrollBars='Vertical'; $outputBox.ReadOnly=$true
-$outputBox.BackColor='White'; $outputBox.Dock='Fill'
-$outputBox.Font = New-Object System.Drawing.Font('Segoe UI',9)
-$pLog.Controls.Add($outputBox)
-try { Set-LogOutputControl -Control $outputBox } catch {}
-
-$grpPick = New-Object System.Windows.Forms.GroupBox
-$grpPick.Text='V√§lj filer f√∂r rapport'
-$grpPick.Dock='Top'
-$grpPick.Padding = New-Object System.Windows.Forms.Padding(10,12,10,14)
-$grpPick.AutoSize=$false
-$grpPick.Height = (78*3) + $grpPick.Padding.Top + $grpPick.Padding.Bottom +15
-
-$tlPick = New-Object System.Windows.Forms.TableLayoutPanel
-$tlPick.Dock='Fill'; $tlPick.ColumnCount=3; $tlPick.RowCount=3
-$tlPick.GrowStyle=[System.Windows.Forms.TableLayoutPanelGrowStyle]::FixedSize
-[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
-[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
-[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,100)))
-for($i=0;$i -lt 3;$i++){ [void]$tlPick.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,78))) }
-
-function New-ListRow {
-    param([string]$labelText,[ref]$lbl,[ref]$clb,[ref]$btn)
-    $lbl.Value = New-Object System.Windows.Forms.Label
-    $lbl.Value.Text=$labelText
-    $lbl.Value.Anchor='Left'
-    $lbl.Value.AutoSize=$true
-    $lbl.Value.Margin=New-Object System.Windows.Forms.Padding(0,12,6,0)
-    $clb.Value = New-Object System.Windows.Forms.CheckedListBox
-    $clb.Value.Dock='Fill'
-    $clb.Value.Margin=New-Object System.Windows.Forms.Padding(0,6,8,6)
-    $clb.Value.Height=70
-    $clb.Value.IntegralHeight=$false
-    $clb.Value.CheckOnClick = $true
-    $clb.Value.DisplayMember = 'Name'
-
-    $btn.Value = New-Object System.Windows.Forms.Button
-    $btn.Value.Text='Bl√§ddra‚Ä¶'
-    $btn.Value.Dock='Fill'
-    $btn.Value.Margin=New-Object System.Windows.Forms.Padding(0,6,0,6)
-    Set-AccentButton $btn.Value
-}
-
-$lblCsv=$null;$clbCsv=$null;$btnCsvBrowse=$null
-New-ListRow -labelText 'CSV-fil:' -lbl ([ref]$lblCsv) -clb ([ref]$clbCsv) -btn ([ref]$btnCsvBrowse)
-$lblNeg=$null;$clbNeg=$null;$btnNegBrowse=$null
-New-ListRow -labelText 'Seal Test Neg:' -lbl ([ref]$lblNeg) -clb ([ref]$clbNeg) -btn ([ref]$btnNegBrowse)
-$lblPos=$null;$clbPos=$null;$btnPosBrowse=$null
-New-ListRow -labelText 'Seal Test Pos:' -lbl ([ref]$lblPos) -clb ([ref]$clbPos) -btn ([ref]$btnPosBrowse)
-
-try {
-    if ($tlPick.RowCount -lt 4) {
-        $tlPick.RowCount = 4
-        for ($i=$tlPick.RowStyles.Count; $i -lt 4; $i++) {
-            $null = $tlPick.RowStyles.Add( (New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 78)) )
-        }
-        $grpPick.Height = (78*4) + $grpPick.Padding.Top + $grpPick.Padding.Bottom + 15
-    }
-} catch {}
-
-$lblLsp = $null; $clbLsp = $null; $btnLspBrowse = $null
-New-ListRow -labelText 'Worksheet:' -lbl ([ref]$lblLsp) -clb ([ref]$clbLsp) -btn ([ref]$btnLspBrowse)
-
-$tlPick.Controls.Add($lblLsp,  0, 3)
-$tlPick.Controls.Add($clbLsp,  1, 3)
-$tlPick.Controls.Add($btnLspBrowse, 2, 3)
-
-$clbLsp.add_ItemCheck({
-    param($s,$e)
-    if ($e.NewValue -eq [System.Windows.Forms.CheckState]::Checked) {
-        for ($i=0; $i -lt $s.Items.Count; $i++) {
-            if ($i -ne $e.Index) { $s.SetItemChecked($i, $false) }
-        }
-    }
-})
-
-$btnLspBrowse.Add_Click({
-    try {
-        $dlg = New-Object System.Windows.Forms.OpenFileDialog
-        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
-        $dlg.Title  = "V√§lj LSP Worksheet"
-        if ($dlg.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
-            $f = Get-Item -LiteralPath $dlg.FileName
-            Add-CLBItems -clb $clbLsp -files @($f) -AutoCheckFirst
-            if (Get-Command Update-StatusBar -ErrorAction SilentlyContinue) { Update-StatusBar }
-        }
-    } catch {
-        Gui-Log ("‚ö†Ô∏è LSP-browse fel: " + $_.Exception.Message) 'Warn'
-    }
-})
-
-# L√§gg in i tabellen
-$tlPick.Controls.Add($lblCsv,0,0); $tlPick.Controls.Add($clbCsv,1,0); $tlPick.Controls.Add($btnCsvBrowse,2,0)
-$tlPick.Controls.Add($lblNeg,0,1); $tlPick.Controls.Add($clbNeg,1,1); $tlPick.Controls.Add($btnNegBrowse,2,1)
-$tlPick.Controls.Add($lblPos,0,2); $tlPick.Controls.Add($clbPos,1,2); $tlPick.Controls.Add($btnPosBrowse,2,2)
-$grpPick.Controls.Add($tlPick)
-
-# ---------- Signatur ----------
-$grpSign = New-Object System.Windows.Forms.GroupBox
-$grpSign.Text = "L√§gg till signatur i Seal Test-filerna"
-$grpSign.Dock='Top'
-$grpSign.Padding = New-Object System.Windows.Forms.Padding(10,8,10,10)
-$grpSign.AutoSize = $false
-$grpSign.Height = 88
-
-$tlSign = New-Object System.Windows.Forms.TableLayoutPanel
-$tlSign.Dock='Fill'; $tlSign.ColumnCount=2; $tlSign.RowCount=2
-[void]$tlSign.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
-[void]$tlSign.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
-[void]$tlSign.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,28)))
-[void]$tlSign.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,28)))
-
-$lblSigner = New-Object System.Windows.Forms.Label
-$lblSigner.Text = 'Fullst√§ndigt namn, signatur och datum:'
-$lblSigner.Anchor='Left'; $lblSigner.AutoSize=$true
-
-$txtSigner = New-Object System.Windows.Forms.TextBox
-$txtSigner.Dock='Fill'; $txtSigner.Margin = New-Object System.Windows.Forms.Padding(6,2,0,2)
-$chkWriteSign = New-Object System.Windows.Forms.CheckBox
-$chkWriteSign.Text = 'Signera Seal Test-Filerna'
-$chkWriteSign.Anchor='Left'
-$chkWriteSign.AutoSize = $true
-
-$chkOverwriteSign = New-Object System.Windows.Forms.CheckBox
-$chkOverwriteSign.Text = 'Aktivera'
-
-$chkOverwriteSign.Anchor='Left'
-$chkOverwriteSign.AutoSize = $true
-$chkOverwriteSign.Enabled = $false
-$chkWriteSign.add_CheckedChanged({ $chkOverwriteSign.Enabled = $chkWriteSign.Checked })
-
-$tlSign.Controls.Add($lblSigner,0,0); $tlSign.Controls.Add($txtSigner,1,0)
-$tlSign.Controls.Add($chkWriteSign,0,1); $tlSign.Controls.Add($chkOverwriteSign,1,1)
-$grpSign.Controls.Add($tlSign)
-
-$grpSign.Visible = $false
-$baseHeight = $form.Height
-
-# ---------- Rapport-utdata ----------
-# (GUI-val borttaget) Rapporten sparas alltid tempor√§rt och SharePoint Info inkluderas alltid.
-$grpSave = $null
-$rbSaveInLsp = $null
-$rbTempOnly = $null
-$chkSharePointInfo = $null
-
-# ---------- Prim√§rknapp ----------
-
-$btnBuild = New-Object System.Windows.Forms.Button
-$btnBuild.Text='Skapa rapport'; $btnBuild.Dock='Top'; $btnBuild.Height=40
-$btnBuild.Margin = New-Object System.Windows.Forms.Padding(0,16,0,8)
-$btnBuild.Enabled=$false; Set-AccentButton $btnBuild -Primary
-
-# ---------- Statusrad ----------
-$status = New-Object System.Windows.Forms.StatusStrip
-$status.SizingGrip=$false; $status.Dock='Bottom'; $status.Font=New-Object System.Drawing.Font('Segoe UI',9)
-$status.ShowItemToolTips = $true
-$slCount = New-Object System.Windows.Forms.ToolStripStatusLabel; $slCount.Text='0 filer valda'; $slCount.Spring=$false
-$slWork  = New-Object System.Windows.Forms.ToolStripStatusLabel
-$slWork.Text   = ''
-$slWork.Spring = $true
-
-$pbWork = New-Object System.Windows.Forms.ToolStripProgressBar
-$pbWork.Visible = $false
-$pbWork.Style   = 'Marquee'
-$pbWork.MarqueeAnimationSpeed = 30
-$pbWork.AutoSize = $false
-$pbWork.Width    = 140
-
-$slSpacer= New-Object System.Windows.Forms.ToolStripStatusLabel; $slSpacer.Spring=$true
-
-# --- Klickbar SharePoint-l√§nk ---
-$slBatchLink = New-Object System.Windows.Forms.ToolStripStatusLabel
-$slBatchLink.IsLink   = $true
-$slBatchLink.Text     = 'SharePoint: ‚Äî'
-$slBatchLink.Enabled  = $false
-$slBatchLink.Tag      = $null
-$slBatchLink.ToolTipText = 'Direktl√§nk aktiveras n√§r Batch# hittas i filer.'
-$slBatchLink.add_Click({
-    if ($this.Enabled -and $this.Tag) {
-        try { Start-Process $this.Tag } catch {
-            [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna:`n$($this.Tag)`n$($_.Exception.Message)","L√§nk") | Out-Null
-        }
-    }
-})
-
-$status.Items.AddRange(@($slCount,$slWork,$pbWork,$slBatchLink))
-$tsc = New-Object System.Windows.Forms.ToolStripContainer
-$tsc.Dock = 'Fill'
-$tsc.LeftToolStripPanelVisible  = $false
-$tsc.RightToolStripPanelVisible = $false
-
-$form.SuspendLayout()
-$form.Controls.Clear()
-$form.Controls.Add($tsc)
-
-# Meny h√∂gst upp
-$tsc.TopToolStripPanel.Controls.Add($menuStrip)
-$form.MainMenuStrip = $menuStrip
-
-# Status l√§ngst ner
-$tsc.BottomToolStripPanel.Controls.Add($status)
-
-# Content i mitten
-$content = New-Object System.Windows.Forms.Panel
-$content.Dock='Fill'
-$content.BackColor = $form.BackColor
-$tsc.ContentPanel.Controls.Add($content)
-
-# Dock=Top: nedersta f√∂rst
-$content.SuspendLayout()
-$content.Controls.Add($btnBuild)
-$content.Controls.Add($grpSign)
-$content.Controls.Add($grpPick)
-$content.Controls.Add($pLog)
-$content.Controls.Add($tlSearch)
-$content.Controls.Add($panelHeader)
-$content.ResumeLayout()
-$form.ResumeLayout()
-$form.PerformLayout()
-$form.AcceptButton = $btnScan
-
-#endregion GUI Construction
-
-function Add-CLBItems {
-    param([System.Windows.Forms.CheckedListBox]$clb,[System.IO.FileInfo[]]$files,[switch]$AutoCheckFirst)
-    $clb.BeginUpdate()
-    $clb.Items.Clear()
-    foreach($f in $files){
-        if ($f -isnot [System.IO.FileInfo]) { try { $f = Get-Item -LiteralPath $f } catch { continue } }
-        [void]$clb.Items.Add($f, $false)
-    }
-    $clb.EndUpdate()
-    if ($AutoCheckFirst -and $clb.Items.Count -gt 0) { $clb.SetItemChecked(0,$true) }
-    Update-StatusBar
-}
-
-function Get-CheckedFilePath { param([System.Windows.Forms.CheckedListBox]$clb)
-    for($i=0;$i -lt $clb.Items.Count;$i++){
-        if ($clb.GetItemChecked($i)) {
-            $fi = [System.IO.FileInfo]$clb.Items[$i]
-            return $fi.FullName
-        }
-    }
-    return $null
-}
-
-function Clear-GUI {
-    $txtLSP.Text = ''
-    $txtSigner.Text = ''
-    $chkWriteSign.Checked = $false
-    $chkOverwriteSign.Checked = $false
-    Add-CLBItems -clb $clbCsv -files @()
-    Add-CLBItems -clb $clbNeg -files @()
-    Add-CLBItems -clb $clbPos -files @()
-    Add-CLBItems -clb $clbLsp -files @()
-    $outputBox.Clear()
-    Update-BuildEnabled
-    Gui-Log "üßπ GUI rensat." 'Info'
-    Update-BatchLink
-}
-
-$onExclusive = {
-    $clb = $this
-    if ($_.NewValue -eq [System.Windows.Forms.CheckState]::Checked) {
-        for ($i=0; $i -lt $clb.Items.Count; $i++) {
-            if ($i -ne $_.Index -and $clb.GetItemChecked($i)) { $clb.SetItemChecked($i, $false) }
-        }
-    }
-    $clb.BeginInvoke([Action]{ Update-BuildEnabled }) | Out-Null
-}
-$clbCsv.add_ItemCheck($onExclusive)
-$clbNeg.add_ItemCheck($onExclusive)
-$clbPos.add_ItemCheck($onExclusive)
-
-function Get-SelectedFileCount {
-    $n=0
-    if (Get-CheckedFilePath $clbCsv) { $n++ }
-    if (Get-CheckedFilePath $clbNeg) { $n++ }
-    if (Get-CheckedFilePath $clbPos) { $n++ }
-    if (Get-CheckedFilePath $clbLsp) { $n++ }
-    return $n
-}
-
-function Update-StatusBar { $slCount.Text = "$(Get-SelectedFileCount) filer valda" }
-
-function Invoke-UiPump {
-    try { [System.Windows.Forms.Application]::DoEvents() } catch {}
-}
-
-function Set-UiBusy {
-    param(
-        [Parameter(Mandatory)][bool]$Busy,
-        [string]$Message = ''
-    )
-    try {
-        if ($Busy) {
-            $slWork.Text = $Message
-            $pbWork.Visible = $true
-            $pbWork.Style   = 'Marquee'
-            $form.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
-            $btnScan.Enabled  = $false
-            $btnBuild.Enabled = $false
-        } else {
-            $pbWork.Visible = $false
-            $pbWork.Style   = 'Blocks'
-            $pbWork.Value   = 0
-            $slWork.Text = ''
-            $form.Cursor = [System.Windows.Forms.Cursors]::Default
-            $btnScan.Enabled = $true
-            Update-BuildEnabled
-        }
-        $status.Refresh()
-        $form.Refresh()
-        Invoke-UiPump
-    } catch {}
-}
-
-function Set-UiStep {
-    param(
-        [Parameter(Mandatory)][int]$Percent,
-        [string]$Message = ''
-    )
-    try {
-        if ($Percent -lt 0) { $Percent = 0 }
-        if ($Percent -gt 100) { $Percent = 100 }
-        $slWork.Text = $Message
-        $pbWork.Visible = $true
-        $pbWork.Style   = 'Blocks'
-        $pbWork.Minimum = 0
-        $pbWork.Maximum = 100
-        if ($pbWork.Value -ne $Percent) { $pbWork.Value = $Percent }
-        $status.Refresh()
-        $form.Refresh()
-        Invoke-UiPump
-    } catch {}
-}
-
-
-function Update-BuildEnabled {
-    $btnBuild.Enabled = ((Get-CheckedFilePath $clbNeg) -and (Get-CheckedFilePath $clbPos))
-    Update-StatusBar
-}
-
-$script:LastScanResult = $null
-
-# Reentrancy guards (DoEvents can otherwise allow nested clicks)
-$script:ScanInProgress  = $false
-$script:BuildInProgress = $false
-
-function Get-BatchLinkInfo {
-    param(
-        [string]$SealPosPath,
-        [string]$SealNegPath,
-        [string]$Lsp
-    )
-
-    $batch = $null
-    try { if ($SealPosPath) { $batch = Get-BatchNumberFromSealFile $SealPosPath } } catch {}
-    if (-not $batch) {
-        try { if ($SealNegPath) { $batch = Get-BatchNumberFromSealFile $SealNegPath } } catch {}
-    }
-
-    $batchEsc = if ($batch) { [uri]::EscapeDataString($batch) } else { '' }
-    $lspEsc   = if ($Lsp)   { [uri]::EscapeDataString($Lsp) }   else { '' }
-
-    $url = if ($SharePointBatchLinkTemplate) {
-        ($SharePointBatchLinkTemplate -replace '\{BatchNumber\}', $batchEsc) -replace '\{LSP\}', $lspEsc
-    } else {
-        "https://danaher.sharepoint.com/sites/CEP-Sweden-Production-Management/Lists/Cepheid%20%20Production%20orders/AllItems.aspx?view=7&q=$batchEsc"
-    }
-    $linkText = if ($batch) { "√ñppna $batch" } else { 'Ingen batch funnen' }
-
-    return [pscustomobject]@{
-        Batch    = $batch
-        Url      = $url
-        LinkText = $linkText
-    }
-}
-
-function Assert-StartupReady {
-    if ($global:StartupReady) { return $true }
-    Gui-Log "‚ùå Startkontroll misslyckades. √Ötg√§rda konfigurationsfel innan du forts√§tter." 'Error'
-    return $false
-}
-
-function Find-LspFolder {
-    [CmdletBinding()]
-    param(
-        [Parameter(Mandatory)] [string]$Lsp,
-        [Parameter(Mandatory)] [string[]]$Roots
-    )
-
-    $lspRaw = ($Lsp + '').Trim()
-    if (-not $lspRaw) { return $null }
-
-    # Till√•t att anv√§ndaren skriver t.ex. "#38401" eller "38401" eller "LSP 38401".
-    # Vi extraherar bara siffrorna f√∂r s√∂kning.
-    $lspDigits = ($lspRaw -replace '\D', '')
-    if (-not $lspDigits) { return $null }
-
-    # Matcha som "eget tal": undvik att 3840 matchar 38401 osv.
-    # Till√•t valfritt '#' i mappnamn/filnamn.
-    $rxToken = "(?<!\d)#?\s*$lspDigits(?!\d)"
-
-    # Snabb v√§g: anv√§nd -Filter f√∂rst (fil-systemet kan optimera) + matcha med rxToken f√∂r att undvika falska tr√§ffar.
-    $filters = @("*$lspDigits*", "*#$lspDigits*")
-
-    foreach ($root in $Roots) {
-        if (-not $root) { continue }
-        if (-not (Test-Path -LiteralPath $root)) { continue }
-
-        # 1) F√∂rs√∂k hitta i √∂versta niv√•n (vanligaste fallet)
-        foreach ($f in $filters) {
-            try {
-                $hit = Get-ChildItem -LiteralPath $root -Directory -Filter $f -ErrorAction SilentlyContinue |
-                       Where-Object { $_.Name -match $rxToken } |
-                       Select-Object -First 1
-                if ($hit) { return $hit }
-            } catch {}
-        }
-
-        # 2) F√∂rs√∂k med -Recurse + -Filter (snabbare √§n full enumerering)
-        foreach ($f in $filters) {
-            try {
-                $hit = Get-ChildItem -LiteralPath $root -Directory -Recurse -Filter $f -ErrorAction SilentlyContinue |
-                       Where-Object { $_.Name -match $rxToken } |
-                       Select-Object -First 1
-                if ($hit) { return $hit }
-            } catch {}
-        }
-
-        # 3) Fallback: full enumerering (dyrt) men mest tolerant
-        try {
-            $hit = Get-ChildItem -LiteralPath $root -Directory -Recurse -ErrorAction SilentlyContinue |
-                   Where-Object { $_.Name -match $rxToken } |
-                   Select-Object -First 1
-            if ($hit) { return $hit }
-        } catch {}
-    }
-
-    return $null
-}
-
-
-
-#region Event Handlers
-$miScan.add_Click({ $btnScan.PerformClick() })
-$miBuild.add_Click({ if ($btnBuild.Enabled) { $btnBuild.PerformClick() } })
-$miExit.add_Click({ $form.Close() })
-$miNew.add_Click({ Clear-GUI })
-
-$miOpenRecent.add_Click({
-    if ($global:LastReportPath -and (Test-Path -LiteralPath $global:LastReportPath)) {
-        try { Start-Process -FilePath $global:LastReportPath } catch {
-            [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna rapporten:\n$($_.Exception.Message)","√ñppna senaste rapport") | Out-Null
-        }
-    } else {
-        [System.Windows.Forms.MessageBox]::Show("Ingen rapport har genererats i denna session.","√ñppna senaste rapport") | Out-Null
-    }
-})
-
-# Skript1..3
-$miScript1.add_Click({
-    $p = $Script1Path
-    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("Ange s√∂kv√§gen till Skript1 i variabeln `$Script1Path.","Skript1") | Out-Null; return }
-    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("Filen hittades inte:\n$Script1Path","Skript1") | Out-Null; return }
-    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
-    switch ($ext) {
-        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
-        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
-        '.lnk' { Start-Process -FilePath $p }
-        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript1") | Out-Null } }
-    }
-})
-
-$miScript2.add_Click({
-    $p = $Script2Path
-    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("Ange s√∂kv√§gen till Skript2 i variabeln `$Script2Path.","Skript2") | Out-Null; return }
-    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("Filen hittades inte:\n$Script2Path","Skript2") | Out-Null; return }
-    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
-    switch ($ext) {
-        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
-        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
-        '.lnk' { Start-Process -FilePath $p }
-        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript2") | Out-Null } }
-    }
-})
-
-$miScript3.add_Click({
-    $p = $Script3Path
-    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("...","Skript3") | Out-Null; return }
-    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("...","Skript3") | Out-Null; return }
-    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
-    switch ($ext) {
-        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
-        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
-        '.lnk' { Start-Process -FilePath $p }
-        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript3") | Out-Null } }
-    }
-})
-
-$miToggleSign.add_Click({
-    $lsp = $txtLSP.Text.Trim()
-    if (-not $lsp) {
-        Gui-Log "‚ö†Ô∏è Ange och s√∂k ett LSP f√∂rst innan du aktiverar Seal Test-signatur." 'Warn'
-        return
-    }
-    $selNeg = Get-CheckedFilePath $clbNeg
-    $selPos = Get-CheckedFilePath $clbPos
-    if (-not $selNeg -or -not $selPos) {
-        Gui-Log "‚ö†Ô∏è Du m√•ste f√∂rst v√§lja b√•de Seal Test NEG och POS innan Seal Test-signatur kan aktiveras." 'Warn'
-        return
-    }
-    $grpSign.Visible = -not $grpSign.Visible
-    if ($grpSign.Visible) {
-        $form.Height = $baseHeight + $grpSign.Height + 40
-        $miToggleSign.Text  = '‚ùå D√∂lj Seal Test-signatur'
-    }
-    else {
-        $form.Height = $baseHeight
-        $miToggleSign.Text  = '‚úÖ Aktivera Seal Test-signatur'
-    }
-})
-
-function Set-Theme {
-    param([string]$Theme)
-    if ($Theme -eq 'dark') {
-        $global:CurrentTheme = 'dark'
-        $form.BackColor        = [System.Drawing.Color]::FromArgb(35,35,35)
-        $content.BackColor     = $form.BackColor
-        $panelHeader.BackColor = [System.Drawing.Color]::DarkSlateBlue
-        $pLog.BackColor        = [System.Drawing.Color]::FromArgb(45,45,45)
-        $grpPick.BackColor     = $form.BackColor  
-        $grpSign.BackColor     = $form.BackColor
-        if ($grpSave) { $grpSave.BackColor = $form.BackColor }
-        $tlSearch.BackColor    = $form.BackColor
-        $outputBox.BackColor   = [System.Drawing.Color]::FromArgb(55,55,55)
-        $outputBox.ForeColor   = [System.Drawing.Color]::White
-        $lblLSP.ForeColor      = [System.Drawing.Color]::White
-        $lblCsv.ForeColor      = [System.Drawing.Color]::White
-        $lblNeg.ForeColor      = [System.Drawing.Color]::White
-        $lblPos.ForeColor      = [System.Drawing.Color]::White
-        if ($lblLsp) { $lblLsp.ForeColor = [System.Drawing.Color]::White }
-        $grpPick.ForeColor     = [System.Drawing.Color]::White
-        $grpSign.ForeColor     = [System.Drawing.Color]::White
-        if ($grpSave) { $grpSave.ForeColor = [System.Drawing.Color]::White }
-        $pLog.ForeColor        = [System.Drawing.Color]::White
-        $tlSearch.ForeColor    = [System.Drawing.Color]::White
-    } else {
-        $global:CurrentTheme = 'light'
-        $form.BackColor        = [System.Drawing.Color]::WhiteSmoke
-        $content.BackColor     = $form.BackColor
-        $panelHeader.BackColor = [System.Drawing.Color]::SteelBlue
-        $pLog.BackColor        = [System.Drawing.Color]::White
-        $grpPick.BackColor     = $form.BackColor
-        $grpSign.BackColor     = $form.BackColor
-        if ($grpSave) { $grpSave.BackColor = $form.BackColor }
-        $tlSearch.BackColor    = $form.BackColor
-        $outputBox.BackColor   = [System.Drawing.Color]::White
-        $outputBox.ForeColor   = [System.Drawing.Color]::Black
-        $lblLSP.ForeColor      = [System.Drawing.Color]::Black
-        $lblCsv.ForeColor      = [System.Drawing.Color]::Black
-        $lblNeg.ForeColor      = [System.Drawing.Color]::Black
-        $lblPos.ForeColor      = [System.Drawing.Color]::Black
-        if ($lblLsp) { $lblLsp.ForeColor = [System.Drawing.Color]::Black }
-        $grpPick.ForeColor     = [System.Drawing.Color]::Black
-        $grpSign.ForeColor     = [System.Drawing.Color]::Black
-        if ($grpSave) { $grpSave.ForeColor = [System.Drawing.Color]::Black }
-        $pLog.ForeColor        = [System.Drawing.Color]::Black
-        $tlSearch.ForeColor    = [System.Drawing.Color]::Black
-    }
-}
-
-$miLightTheme.add_Click({ Set-Theme 'light' })
-$miDarkTheme.add_Click({ Set-Theme 'dark' })
-
-# Instruktioner
-
-$miShowInstr.add_Click({
-    $msg = @"
-Snabbguide
-
-1. Skriv in ditt LSP och klicka "S√∂k Filer eller anv√§nd Bl√§ddra..."
-
-2. V√§lj fil:
-   ‚Ä¢ 1x CSV
-   ‚Ä¢ 1x Seal Test NEG
-   ‚Ä¢ 1x Seal Test POS
-   ‚Ä¢ 1x Worksheet
-
-3. Rapporten sparas i tempor√§rt l√§ge och inkluderar SharePoint Info (automatiskt).
-
-4. Klicka p√• "Skapa rapport"
-
-Excelrapport √∂ppnas med f√∂ljande flikar beroende p√• valda filer:
-   ‚Ä¢ Information (generell)
-   ‚Ä¢ Seal Test Info
-   ‚Ä¢ STF Sum (och minusv√§rden)
-   ‚Ä¢ Infinity/GX
-   ‚Ä¢ Kontrollmaterial
-   ‚Ä¢ SharePoint Info
-
-Fels√∂kning:
-   ‚Ä¢ Filen l√•st ‚Üí St√§ng Excelfiler.
-"@
-    [System.Windows.Forms.MessageBox]::Show($msg,"Instruktioner") | Out-Null
-})
-
-$miFAQ.add_Click({
-    $faq = @"
-Vad g√∂r skriptet?
-
-Det skapar en excel-rapport som j√§mf√∂r s√∂kt LSP f√∂r Seal Test-Filer,
-h√§mtar utrustningslista, r√§tt kontrollmaterial och SharePoint Info f√∂r s√∂kt LSP.
-
-1) Varf√∂r ser jag inte fliken "SharePoint Info"?
-   ‚Ä¢ Kryssrutan "SharePoint Info" m√•ste vara ibockad.
-   ‚Ä¢ Inloggning kan saknas eller SharePoint-listan inneh√•ller inte batchnumret.
-
-2) UI fryser ibland ‚Äì √§r det normalt?
-   ‚Ä¢ Nej. PnP-kopplingen och l√§sningen g√∂rs i bakgrunden. Om det √§nd√• k√§nns segt:
-     - Testa utan SharePoint f√∂rst (avbocka) f√∂r att isolera.
-     - St√§ng tunga Excel-instans(er) i bakgrunden.
-
-3) "Filen √§r l√•st/kan inte spara"
-   ‚Ä¢ St√§ng k√§llfilen i Excel.
-   ‚Ä¢ Kontrollera att OneDrive/SharePoint Sync inte h√•ller filen exklusivt l√•st.
-   ‚Ä¢ Spara till TEMP f√∂r att testa att genereringen fungerar.
-
-4) Var sparas rapporten?
-   ‚Ä¢ V√§lj "LSP-mapp" (samma mapp som ditt LSP) eller "TEMP" = sparas inte.
-"@
-    [System.Windows.Forms.MessageBox]::Show($faq,"Vanliga fr√•gor") | Out-Null
-})
-
-$miHelpDlg.add_Click({
-    $helpForm = New-Object System.Windows.Forms.Form
-    $helpForm.Text = 'Skicka meddelande'
-    $helpForm.Size = New-Object System.Drawing.Size(400,300)
-    $helpForm.StartPosition = 'CenterParent'
-    $helpForm.Font = $form.Font
-    $helpBox = New-Object System.Windows.Forms.TextBox
-    $helpBox.Multiline = $true
-    $helpBox.ScrollBars = 'Vertical'
-    $helpBox.Dock = 'Fill'
-    $helpBox.Font = New-Object System.Drawing.Font('Segoe UI',9)
-    $helpBox.Margin = New-Object System.Windows.Forms.Padding(10)
-    $panelButtons = New-Object System.Windows.Forms.FlowLayoutPanel
-    $panelButtons.Dock = 'Bottom'
-    $panelButtons.FlowDirection = 'RightToLeft'
-    $panelButtons.Padding = New-Object System.Windows.Forms.Padding(10)
-    $btnSend = New-Object System.Windows.Forms.Button
-    $btnSend.Text = 'Skicka'
-    $btnCancel = New-Object System.Windows.Forms.Button
-    $btnCancel.Text = 'Avbryt'
-    $panelButtons.Controls.Add($btnSend)
-    $panelButtons.Controls.Add($btnCancel)
-    $helpForm.Controls.Add($helpBox)
-    $helpForm.Controls.Add($panelButtons)
-    $btnSend.Add_Click({
-        $msg = $helpBox.Text.Trim()
-        if (-not $msg) { [System.Windows.Forms.MessageBox]::Show('Ange ett meddelande innan du skickar.','Hj√§lp') | Out-Null; return }
-        try {
-            $helpDir = Join-Path $PSScriptRoot 'help'
-            if (-not (Test-Path $helpDir)) { New-Item -ItemType Directory -Path $helpDir -Force | Out-Null }
-            $ts = (Get-Date).ToString('yyyyMMdd_HHmmss')
-            $file = Join-Path $helpDir "help_${ts}.txt"
-            Set-Content -Path $file -Value $msg -Encoding UTF8
-            [System.Windows.Forms.MessageBox]::Show('Meddelandet sparades. Tack!','Hj√§lp') | Out-Null
-            $helpForm.Close()
-        } catch {
-            [System.Windows.Forms.MessageBox]::Show("Kunde inte spara meddelandet:\n$($_.Exception.Message)",'Hj√§lp') | Out-Null
-        }
-    })
-    $btnCancel.Add_Click({ $helpForm.Close() })
-    $helpForm.ShowDialog() | Out-Null
-})
-
-# Om
-$miOm.add_Click({ [System.Windows.Forms.MessageBox]::Show("OBS! Detta verktyg √§r endast ett hj√§lpmedel och ers√§tter inte n√•gon process hos PQC.`n $ScriptVersion`nav Jesper","Om") | Out-Null })
-
-$btnScan.Add_Click({
-    if (-not (Assert-StartupReady)) { return }
-
-    $lspInput = ($txtLSP.Text + '').Trim()
-    if (-not $lspInput) { Gui-Log "‚ö†Ô∏è Ange ett LSP-nummer" 'Warn'; return }
-
-    # Normalisera: anv√§nd endast siffrorna som nyckel (till√•t '#38401', 'LSP 38401' osv.)
-    $lsp = ($lspInput -replace '\D', '')
-    if (-not $lsp) { Gui-Log "‚ö†Ô∏è Ange ett giltigt LSP-nummer (siffror)" 'Warn'; return }
-
-    if ($script:BuildInProgress) { Gui-Log "‚ö†Ô∏è Rapportgenerering p√•g√•r ‚Äì v√§nta tills den √§r klar." 'Warn'; return }
-    if ($script:ScanInProgress)  { Gui-Log "‚ö†Ô∏è S√∂kning p√•g√•r redan ‚Äì v√§nta." 'Warn'; return }
-    $script:ScanInProgress = $true
-
-
-    Gui-Log -Text ("üîé S√∂ker filer f√∂r {0}‚Ä¶" -f $lsp) -Severity Info -Category USER -Immediate
-
-    try {
-        # √Öteranv√§nd cache om LSP + mapp fortfarande finns
-        if ($script:LastScanResult -and $script:LastScanResult.Lsp -eq $lsp -and
-            $script:LastScanResult.Folder -and (Test-Path -LiteralPath $script:LastScanResult.Folder)) {
-
-            Gui-Log -Text ("‚ôªÔ∏è √Öteranv√§nder senaste s√∂kresultatet f√∂r {0}." -f $lsp) -Severity Info -Category USER
-            Add-CLBItems -clb $clbCsv -files $script:LastScanResult.Csv -AutoCheckFirst
-            Add-CLBItems -clb $clbNeg -files $script:LastScanResult.Neg -AutoCheckFirst
-            Add-CLBItems -clb $clbPos -files $script:LastScanResult.Pos -AutoCheckFirst
-            Add-CLBItems -clb $clbLsp -files $script:LastScanResult.LspFiles -AutoCheckFirst
-            Update-BuildEnabled
-            Update-BatchLink
-            return
-        }
-       
-$folder = Find-LspFolder -Lsp $lsp -Roots $RootPaths
-if (-not $folder) {
-    Gui-Log "‚ùå Ingen LSP-mapp hittad f√∂r $lsp" 'Warn'
-    if ($env:IPT_ROOT) { Gui-Log "‚ÑπÔ∏è IPT_ROOT=$($env:IPT_ROOT)" 'Info' 'DEBUG' }
-    $rootInfo = $RootPaths | ForEach-Object { "{0} ({1})" -f $_, $(if (Test-Path -LiteralPath $_) { "OK" } else { "MISSING" }) }
-    Gui-Log -Text ("S√∂kv√§gar som provats: " + ($rootInfo -join " | ")) -Severity Info -Category USER
-    return
-}
-
-if (-not (Test-Path -LiteralPath $folder.FullName)) {
-    Gui-Log "‚ùå LSP-mappen hittades men finns inte l√§ngre: $($folder.FullName)" 'Warn'
-    $rootInfo = $RootPaths | ForEach-Object { "{0} ({1})" -f $_, $(if (Test-Path -LiteralPath $_) { "OK" } else { "MISSING" }) }
-    Gui-Log -Text ("S√∂kv√§gar som provats: " + ($rootInfo -join " | ")) -Severity Info -Category USER
-    return
-}
-        Gui-Log -Text ("üìÇ Hittad mapp: {0}" -f $folder.FullName) -Severity Info -Category USER
-
-        # Plocka filer EN g√•ng
-        $files = Get-ChildItem -LiteralPath $folder.FullName -File -ErrorAction SilentlyContinue
-
-        $candCsv = $files | Where-Object { $_.Extension -ieq '.csv' -and ( $_.Name -match [regex]::Escape($lsp) -or $_.Length -gt 100kb ) } | Sort-Object LastWriteTime -Descending
-        $candNeg = $files | Where-Object { $_.Name -match '(?i)Neg.*\.xls[xm]$' -and $_.Name -match [regex]::Escape($lsp) } | Sort-Object LastWriteTime -Descending
-        $candPos = $files | Where-Object { $_.Name -match '(?i)Pos.*\.xls[xm]$' -and $_.Name -match [regex]::Escape($lsp) } | Sort-Object LastWriteTime -Descending
-        $candLsp = $files | Where-Object {
-            ($_.Name -match '(?i)worksheet') -and ($_.Name -match [regex]::Escape($lsp)) -and ($_.Extension -match '^(\.xlsx|\.xlsm|\.xls)$')
-        } | Sort-Object LastWriteTime -Descending
-
-        Add-CLBItems -clb $clbCsv -files $candCsv -AutoCheckFirst
-        Add-CLBItems -clb $clbNeg -files $candNeg -AutoCheckFirst
-        Add-CLBItems -clb $clbPos -files $candPos -AutoCheckFirst
-        Add-CLBItems -clb $clbLsp -files $candLsp -AutoCheckFirst
-
-        if ($candCsv.Count -eq 0) { Gui-Log "‚ÑπÔ∏è Ingen CSV hittad (endast .csv visas)." 'Info' }
-        if ($candNeg.Count -eq 0) { Gui-Log "‚ö†Ô∏è Ingen Seal NEG hittad." 'Warn' }
-        if ($candPos.Count -eq 0) { Gui-Log "‚ö†Ô∏è Ingen Seal POS hittad." 'Warn' }
-        if ($candLsp.Count -eq 0) { Gui-Log "‚ÑπÔ∏è Ingen LSP Worksheet hittad." 'Info' }
-
-        Update-BuildEnabled
-        Update-BatchLink
-
-        # Cachea FileInfo-objekt (snabbare √§n att cachea str√§ngar)
-        $script:LastScanResult = [pscustomobject]@{
-            Lsp      = $lsp
-            Folder   = $folder.FullName
-            Csv      = @($candCsv)
-            Neg      = @($candNeg)
-            Pos      = @($candPos)
-            LspFiles = @($candLsp)
-        }
-
-        Gui-Log -Text "‚úÖ Filer laddade." -Severity Info -Category USER
-    }
-    catch {
-        Gui-Log ("‚ùå Fils√∂kning misslyckades: " + $_.Exception.Message) 'Error'
-    }
-    finally {
-        $script:ScanInProgress = $false
-    }
-})
-
-$btnCsvBrowse.Add_Click({
-        $dlg = $null
-    try {
-        $dlg = New-Object System.Windows.Forms.OpenFileDialog
-        $dlg.Filter = "CSV|*.csv|Alla filer|*.*"
-        if ($dlg.ShowDialog() -eq 'OK') {
-            $f = Get-Item -LiteralPath $dlg.FileName
-            Add-CLBItems -clb $clbCsv -files @($f) -AutoCheckFirst
-            Update-BuildEnabled
-            Update-BatchLink
-        }
-    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
-})
-
-$btnNegBrowse.Add_Click({
-        $dlg = $null
-    try {
-        $dlg = New-Object System.Windows.Forms.OpenFileDialog
-        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
-        if ($dlg.ShowDialog() -eq 'OK') {
-            $f = Get-Item -LiteralPath $dlg.FileName
-            Add-CLBItems -clb $clbNeg -files @($f) -AutoCheckFirst
-            Update-BuildEnabled
-            Update-BatchLink
-        }
-    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
-})
-
-$btnPosBrowse.Add_Click({
-        $dlg = $null
-    try {
-        $dlg = New-Object System.Windows.Forms.OpenFileDialog
-        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
-        if ($dlg.ShowDialog() -eq 'OK') {
-            $f = Get-Item -LiteralPath $dlg.FileName
-            Add-CLBItems -clb $clbPos -files @($f) -AutoCheckFirst
-            Update-BuildEnabled
-            Update-BatchLink
-        }
-    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
-})
-
-
-
-if (-not (Get-Command Write-SPSheet-Safe -ErrorAction SilentlyContinue)) {
-    function Write-SPSheet-Safe {
-        param(
-            [OfficeOpenXml.ExcelPackage]$Pkg,
-            [object]$Rows,                    
-            [string[]]$DesiredOrder,            
-            [string]$Batch
-        )
-        if (-not $Pkg) { return $false }
-        $Rows = @($Rows)
-        $name = "SharePoint Info"
-        $wsOld = $Pkg.Workbook.Worksheets[$name]
-        if ($wsOld) { $Pkg.Workbook.Worksheets.Delete($wsOld) }
-        $ws = $Pkg.Workbook.Worksheets.Add($name)
-
-        # ==========================================
-        # Harmoniserade f√§rger (matchar CSV Sammanfattning)
-        # ==========================================
-        $HeaderBg   = [System.Drawing.Color]::FromArgb(68, 84, 106)    # M√∂rkbl√• (#44546A)
-        $HeaderFg   = [System.Drawing.Color]::White
-        $SectionBg  = [System.Drawing.Color]::FromArgb(217, 225, 242)  # Ljusbl√• (#D9E1F2)
-        $SectionFg  = [System.Drawing.Color]::FromArgb(0, 32, 96)      # M√∂rkbl√• text
-        $ValueBg    = [System.Drawing.Color]::White
-        $BorderColor = [System.Drawing.Color]::FromArgb(68, 84, 106)   # M√∂rkbl√• border
-
-        if ($Rows.Count -eq 0 -or $Rows[0] -eq $null) {
-            # Tom data - visa meddelande med harmoniserad stil
-            $ws.Cells[1,1].Value = "SharePoint Info"
-            $ws.Cells["A1:B1"].Merge = $true
-            $ws.Cells["A1"].Style.Font.Bold = $true
-            $ws.Cells["A1"].Style.Font.Size = 14
-            $ws.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
-            $ws.Cells["A1"].Style.Fill.PatternType = "Solid"
-            $ws.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
-            $ws.Cells["A1"].Style.HorizontalAlignment = "Left"
-            $ws.Cells[2,1].Value = "Batch"
-            $ws.Cells[2,2].Value = $Batch
-            $ws.Cells[3,1].Value = "Status"
-            $ws.Cells[3,2].Value = "Ingen data hittad"
-            $ws.Cells["A2:A3"].Style.Fill.PatternType = "Solid"
-            $ws.Cells["A2:A3"].Style.Fill.BackgroundColor.SetColor($SectionBg)
-            $ws.Cells["A2:A3"].Style.Font.Bold = $true
-            return $true
-        }
-        $isKV = ($Rows[0].psobject.Properties.Name -contains 'Rubrik') -and `
-                ($Rows[0].psobject.Properties.Name -contains 'V√§rde')
-        if ($isKV) {
-            # ==========================================
-            # RUBRIK-V√ÑRDE FORMAT (Harmoniserad layout)
-            # ==========================================
-            
-            # Huvudrubrik (rad 1) - m√∂rkbl√• bakgrund
-            $ws.Cells[1,1].Value = "SharePoint Info"
-            $ws.Cells[1,2].Value = ""
-            $ws.Cells["A1:B1"].Merge = $true
-            $ws.Cells["A1"].Style.Font.Bold = $true
-            $ws.Cells["A1"].Style.Font.Size = 14
-            $ws.Cells["A1"].Style.Font.Name = "Arial"
-            $ws.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
-            $ws.Cells["A1"].Style.Fill.PatternType = "Solid"
-            $ws.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
-            $ws.Cells["A1"].Style.HorizontalAlignment = "Left"
-            $ws.Cells["A1"].Style.VerticalAlignment   = "Center"
-            $ws.Row(1).Height = 22
-
-            # Datarader b√∂rjar p√• rad 2
-            $r = 2
-            foreach ($row in $Rows) {
-                $ws.Cells[$r,1].Value = $row.Rubrik
-                $ws.Cells[$r,2].Value = $row.'V√§rde'
-                $r++
-            }
-            $lastRow = $r-1
-
-            # Styling f√∂r rubrik-kolumnen (A) - ljusbl√• bakgrund
-            $labelRange = $ws.Cells["A2:A$lastRow"]
-            $labelRange.Style.Font.Bold = $true
-            $labelRange.Style.Font.Name = "Arial"
-            $labelRange.Style.Font.Size = 10
-            $labelRange.Style.Font.Color.SetColor($SectionFg)
-            $labelRange.Style.Fill.PatternType = "Solid"
-            $labelRange.Style.Fill.BackgroundColor.SetColor($SectionBg)
-            $labelRange.Style.HorizontalAlignment = "Left"
-            $labelRange.Style.VerticalAlignment   = "Center"
-
-            # Styling f√∂r v√§rde-kolumnen (B) - vit bakgrund
-            $valueRange = $ws.Cells["B2:B$lastRow"]
-            $valueRange.Style.Font.Name = "Arial"
-            $valueRange.Style.Font.Size = 10
-            $valueRange.Style.Fill.PatternType = "Solid"
-            $valueRange.Style.Fill.BackgroundColor.SetColor($ValueBg)
-            $valueRange.Style.HorizontalAlignment = "Left"
-            $valueRange.Style.VerticalAlignment   = "Center"
-
-            # Borders f√∂r hela tabellen
-            $rng = $ws.Cells["A1:B$lastRow"]
-            $rng.Style.Border.Top.Style    = "Thin"
-            $rng.Style.Border.Bottom.Style = "Thin"
-            $rng.Style.Border.Left.Style   = "Thin"
-            $rng.Style.Border.Right.Style  = "Thin"
-            $rng.Style.Border.Top.Color.SetColor($BorderColor)
-            $rng.Style.Border.Bottom.Color.SetColor($BorderColor)
-            $rng.Style.Border.Left.Color.SetColor($BorderColor)
-            $rng.Style.Border.Right.Color.SetColor($BorderColor)
-
-            # Yttre ram - tjockare
-            $rng.Style.Border.BorderAround([OfficeOpenXml.Style.ExcelBorderStyle]::Medium, $BorderColor)
-
-            # Kolumnbredder
-            $ws.Column(1).Width = 35
-            $ws.Column(2).Width = 50
-
-            # AutoFit f√∂r b√§ttre anpassning
-            try {
-                if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                    Safe-AutoFitColumns -Ws $ws -Context 'SharePointInfo'
-                } else {
-                    $ws.Cells[$ws.Dimension.Address].AutoFitColumns() | Out-Null
-                }
-                # S√§kerst√§ll minsta bredd
-                if ($ws.Column(1).Width -lt 30) { $ws.Column(1).Width = 30 }
-                if ($ws.Column(2).Width -lt 40) { $ws.Column(2).Width = 40 }
-            } catch {}
-        }
-        else {
-            # ==========================================
-            # TABELL-FORMAT (flera kolumner)
-            # ==========================================
-            $cols = @()
-            if ($DesiredOrder) { $cols += $DesiredOrder }
-            foreach ($k in $Rows[0].psobject.Properties.Name) {
-                if ($cols -notcontains $k) { $cols += $k }
-            }
-
-            # Header-rad
-            for ($c=0; $c -lt $cols.Count; $c++) {
-                $ws.Cells[1,$c+1].Value = $cols[$c]
-            }
-            $headerRange = $ws.Cells[1,1,1,$cols.Count]
-            $headerRange.Style.Font.Bold = $true
-            $headerRange.Style.Font.Name = "Arial"
-            $headerRange.Style.Font.Size = 10
-            $headerRange.Style.Font.Color.SetColor($HeaderFg)
-            $headerRange.Style.Fill.PatternType = "Solid"
-            $headerRange.Style.Fill.BackgroundColor.SetColor($HeaderBg)
-            $headerRange.Style.HorizontalAlignment = "Left"
-
-            # Datarader
-            $r = 2
-            foreach ($row in $Rows) {
-                for ($c=0; $c -lt $cols.Count; $c++) {
-                    $ws.Cells[$r,$c+1].Value = $row.$($cols[$c])
-                }
-                $r++
-            }
-            $lastRow = $r-1
-
-            # Styling f√∂r datarader
-            if ($lastRow -ge 2) {
-                $dataRange = $ws.Cells[2,1,$lastRow,$cols.Count]
-                $dataRange.Style.Font.Name = "Arial"
-                $dataRange.Style.Font.Size = 10
-
-                # Borders
-                $fullRange = $ws.Cells[1,1,$lastRow,$cols.Count]
-                $fullRange.Style.Border.Top.Style    = "Thin"
-                $fullRange.Style.Border.Bottom.Style = "Thin"
-                $fullRange.Style.Border.Left.Style   = "Thin"
-                $fullRange.Style.Border.Right.Style  = "Thin"
-                $fullRange.Style.Border.Top.Color.SetColor($BorderColor)
-                $fullRange.Style.Border.Bottom.Color.SetColor($BorderColor)
-                $fullRange.Style.Border.Left.Color.SetColor($BorderColor)
-                $fullRange.Style.Border.Right.Color.SetColor($BorderColor)
-            }
-
-            try {
-                if ($ws.Dimension) {
-                    $maxR = [Math]::Min($ws.Dimension.End.Row, 2000)
-                    $rAF = $ws.Cells[$ws.Dimension.Start.Row,$ws.Dimension.Start.Column,$maxR,$ws.Dimension.End.Column]
-                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                        Safe-AutoFitColumns -Ws $ws -Range $rAF -Context 'TableSheet'
-                    } else {
-                        $rAF.AutoFitColumns() | Out-Null
-                    }
-                }
-            } catch {}
-        }
-        return $true
-    }
-}‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ
-
-# ============================
-# ===== RAPPORTLOGIK =========
-# ============================
-        
-$btnBuild.Add_Click({
-    if (-not (Assert-StartupReady)) { return }
-
-    if ($script:ScanInProgress) { Gui-Log "‚ö†Ô∏è S√∂kning p√•g√•r ‚Äì v√§nta innan du skapar rapport." 'Warn'; return }
-    if ($script:BuildInProgress) { Gui-Log "‚ö†Ô∏è Rapportgenerering k√∂r redan ‚Äì v√§nta." 'Warn'; return }
-    $script:BuildInProgress = $true
-
-    Gui-Log -Text 'Skapar rapport‚Ä¶' -Severity Info -Category USER -Immediate
-    Set-UiBusy -Busy $true -Message 'Skapar rapport‚Ä¶'
-    Set-UiStep 5 'Initierar‚Ä¶'
-
-    $pkgNeg = $null
-    $pkgPos = $null
-    $pkgOut = $null
-
-    # RuleEngine caches (per-k√∂rning)
-    $script:RuleEngineShadow  = $null
-    $script:RuleEngineCsvObjs = $null
-    $script:RuleBankCache     = $null
-
-    try {
-        if (-not (Load-EPPlus)) { Gui-Log "‚ùå EPPlus kunde inte laddas ‚Äì avbryter." 'Error'; return }
-
-        Set-UiStep 10 'L√§ser in Seal-filer‚Ä¶'
-
-        $selCsv = Get-CheckedFilePath $clbCsv
-        $selNeg = Get-CheckedFilePath $clbNeg
-        $selPos = Get-CheckedFilePath $clbPos
-
-        if (-not $selNeg -or -not $selPos) { Gui-Log "‚ùå Du m√•ste v√§lja en Seal NEG och en Seal POS." 'Error'; return }
-
-        $lspRaw    = ($txtLSP.Text + '').Trim()
-        $lspDigits = ($lspRaw -replace '\D','')
-        $hasLsp    = -not [string]::IsNullOrWhiteSpace($lspDigits)
-
-        if ($hasLsp) {
-            $lsp = $lspDigits
-        } else {
-            $lsp = 'MANUELL'
-            Gui-Log "‚ÑπÔ∏è Ingen LSP angiven ‚Äì k√∂r manuellt l√§ge (filval via Bl√§ddra). Rapporten m√§rks som '$lsp' och SharePoint/LSP-koppling hoppas √∂ver." 'Warn'
-        }
-
-        $lspForLinks = if ($hasLsp) { $lsp } else { '' }
-
-        # ---- Local staging for network files (N:\ or UNC) ----
-        # Speeds up runs when the project and inputs are stored on a shared drive.
-        $stageDir = $null
-        $enableStaging = Get-ConfigFlag -Name 'EnableLocalStaging' -Default $true -ConfigOverride $Config
-        if ($enableStaging) {
-            try {
-                $stageDir = Join-Path ([IO.Path]::GetTempPath()) ("QC_Stage_" + $lsp + "_" + (Get-Date -Format 'yyyyMMdd_HHmmss'))
-                New-Item -ItemType Directory -Path $stageDir -Force | Out-Null
-
-                $selNeg = Stage-InputFile -Path $selNeg -StageDir $stageDir
-                $selPos = Stage-InputFile -Path $selPos -StageDir $stageDir
-                if ($selCsv) { $selCsv = Stage-InputFile -Path $selCsv -StageDir $stageDir }
-            } catch {
-                # Best-effort only; continue with original paths on any error.
-            }
-        }
-
-
-        Gui-Log "üìÑ Neg-fil: $(Split-Path $selNeg -Leaf)" 'Info'
-        Gui-Log "üìÑ Pos-fil: $(Split-Path $selPos -Leaf)" 'Info'
-        if ($selCsv) { Gui-Log "üìÑ CSV: $(Split-Path $selCsv -Leaf)" 'Info' } else { Gui-Log "‚ÑπÔ∏è Ingen CSV vald." 'Info' }
-
-        $negWritable = $true; $posWritable = $true
-        if ($chkWriteSign.Checked) {
-            $negWritable = -not (Test-FileLocked $selNeg); if (-not $negWritable) { Gui-Log "üîí NEG √§r l√•st (√∂ppen i Excel?)." 'Warn' }
-            $posWritable = -not (Test-FileLocked $selPos); if (-not $posWritable) { Gui-Log "üîí POS √§r l√•st (√∂ppen i Excel?)." 'Warn' }
-        }
-
-        # ----------------------------
-        # Open packages
-        # ----------------------------
-        try {
-            $pkgNeg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selNeg))
-            $pkgPos = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selPos))
-        } catch {
-            Gui-Log "‚ùå Kunde inte √∂ppna NEG/POS: $($_.Exception.Message)" 'Error'
-            return
-        }
-
-        $templatePath = Join-Path $PSScriptRoot "output_template-v4.xlsx"
-        if (-not (Test-Path -LiteralPath $templatePath)) { Gui-Log "‚ùå Mallfilen 'output_template-v4.xlsx' saknas!" 'Error'; return }
-        try {
-            $pkgOut = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($templatePath))
-        } catch {
-            Gui-Log "‚ùå Kunde inte l√§sa mall: $($_.Exception.Message)" 'Error'
-            return
-        }
-
-        # ============================
-        # === SIGNATUR I NEG/POS  ====
-        # ============================
-
-        $signToWrite = ($txtSigner.Text + '').Trim()
-        if ($chkWriteSign.Checked) {
-            if (-not $signToWrite) { Gui-Log "‚ùå Ingen signatur angiven (B47). Avbryter."; return }
-            if (-not (Confirm-SignatureInput -Text $signToWrite)) { Gui-Log "üõë Signatur ej bekr√§ftad. Avbryter."; return }
-
-            $negWritten = 0; $posWritten = 0; $negSkipped = 0; $posSkipped = 0
-
-            foreach ($ws in $pkgNeg.Workbook.Worksheets) {
-                if ($ws.Name -eq 'Worksheet Instructions') { continue }
-                $h3 = ($ws.Cells['H3'].Text + '').Trim()
-
-                if ($h3 -match '^[0-9]') {
-                    $existing = ($ws.Cells[$Layout.SignatureCell].Text + '').Trim()
-                    if ($existing -and -not $chkOverwriteSign.Checked) { $negSkipped++; continue }
-                    $ws.Cells[$Layout.SignatureCell].Style.Numberformat.Format = '@'
-                    $ws.Cells[$Layout.SignatureCell].Value = $signToWrite
-                    $negWritten++
-                }
-                elseif ([string]::IsNullOrWhiteSpace($h3) -or $h3 -match '^(?i)(N\/\?A|NA|Tomt( inneh√•ll)?)$') {
-                    break
-                }
-            }
-
-            foreach ($ws in $pkgPos.Workbook.Worksheets) {
-                if ($ws.Name -eq 'Worksheet Instructions') { continue }
-                $h3 = ($ws.Cells['H3'].Text + '').Trim()
-
-                if ($h3 -match '^[0-9]') {
-                    $existing = ($ws.Cells[$Layout.SignatureCell].Text + '').Trim()
-                    if ($existing -and -not $chkOverwriteSign.Checked) { $posSkipped++; continue }
-                    $ws.Cells[$Layout.SignatureCell].Style.Numberformat.Format = '@'
-                    $ws.Cells[$Layout.SignatureCell].Value = $signToWrite
-                    $posWritten++
-                }
-                elseif ([string]::IsNullOrWhiteSpace($h3) -or $h3 -match '^(?i)(N\/\?A|NA|Tomt( inneh√•ll)?)$') {
-                    break
-                }
-            }
-
-            try {
-                if ($negWritten -eq 0 -and $negSkipped -eq 0 -and $posWritten -eq 0 -and $posSkipped -eq 0) {
-                    Gui-Log "‚ÑπÔ∏è Inga databladsflikar efter flik 1 att s√§tta signatur i (ingen √•tg√§rd)."
-                } else {
-                    if ($negWritten -gt 0 -and $negWritable) { $pkgNeg.Save() } elseif ($negWritten -gt 0) { Gui-Log "üîí Kunde inte spara NEG (l√•st)." 'Warn' }
-                    if ($posWritten -gt 0 -and $posWritable) { $pkgPos.Save() } elseif ($posWritten -gt 0) { Gui-Log "üîí Kunde inte spara POS (l√•st)." 'Warn' }
-                    Gui-Log "üñäÔ∏è Signatur satt: NEG $negWritten blad (√∂verhoppade $negSkipped), POS $posWritten blad (√∂verhoppade $posSkipped)."
-                }
-            } catch {
-                Gui-Log "‚ö†Ô∏è Kunde inte spara signatur i NEG/POS: $($_.Exception.Message)" 'Warn'
-            }
-        }
-
-        # ============================
-        # === CSV (Info/Control)  ====
-        # ============================
-
-        $csvRows = @()
-        $runAssay = $null
-
-        if ($selCsv) {
-            try {
-                $csvInfo = Get-Item -LiteralPath $selCsv -ErrorAction Stop
-                $thresholdMb = 25
-                try {
-                    if ($Config -and ($Config -is [System.Collections.IDictionary]) -and $Config.Contains('CsvStreamingThresholdMB')) {
-                        $thresholdMb = [int]$Config['CsvStreamingThresholdMB']
-                    }
-                } catch {}
-
-                $useStreaming = ($csvInfo.Length -ge ($thresholdMb * 1MB))
-                if ($useStreaming) {
-                    Gui-Log ("‚è≥ CSV √§r stor ({0:N1} MB) ‚Äì anv√§nder streaming-import‚Ä¶" -f ($csvInfo.Length / 1MB)) 'Info'
-                    Set-UiStep 35 "L√§ser CSV (streaming)‚Ä¶"
-                    $list = New-Object System.Collections.Generic.List[object]
-                    Import-CsvRowsStreaming -Path $selCsv -StartRow 10 -ProcessRow {
-                        param($Fields,$RowIndex)
-                        [void]$list.Add($Fields)
-                        if (($RowIndex % 2000) -eq 0) { Invoke-UiPump }
-                    }
-                    $csvRows = @($list.ToArray())
-                } else {
-                    Set-UiStep 35 "L√§ser CSV‚Ä¶"
-                    $csvRows = Import-CsvRows -Path $selCsv -StartRow 10
-                }
-
-                # --- Robusthet: Sortera p√• kolumn C (Sample ID) innan vidare bearbetning.
-                # M√•nga downstream-steg (gruppering/skrivning) f√∂ruts√§tter att raderna √§r konsekvent sorterade.
-                try {
-                    if ($csvRows -and $csvRows.Count -gt 1) {
-                        if ($csvRows[0] -is [object[]]) {
-                            # Import-CsvRows* returnerar f√§lt-arrayer: kolumn C = index 2
-                            $csvRows = @($csvRows | Sort-Object { [string]($_[2]) })
-                        } else {
-                            # Om vi i framtiden f√•r PSCustomObject-rader
-                            $csvRows = @($csvRows | Sort-Object { [string]($_.'Sample ID') })
-                        }
-                        Gui-Log ("üîÉ CSV sorterad p√• kolumn C (Sample ID). Rader: {0}" -f $csvRows.Count) 'Info'
-                    }
-                } catch {
-                    Gui-Log "‚ö†Ô∏è Kunde inte sortera CSV p√• kolumn C (Sample ID)." 'Warn'
-                }
-            } catch {
-                Gui-Log "‚ö†Ô∏è CSV-import misslyckades: $($_.Exception.Message)" 'Warn'
-                $csvRows = @()
-            }
-            try { $runAssay = Get-AssayFromCsv -Path $selCsv -StartRow 10 } catch {}
-            if ($runAssay) { Gui-Log "üîé Assay fr√•n CSV: $runAssay" }
-        }
-
-        # ============================
-        # === RuleEngine (shadow)  ===
-        # ============================
-        try {
-            if ((Get-ConfigFlag -Name 'EnableRuleEngine' -Default $false -ConfigOverride $Config) -and
-                $selCsv -and (Test-Path -LiteralPath $selCsv)) {
-
-                # Load rulebank once
-                $rb = Load-RuleBank -RuleBankDir $Config.RuleBankDir
-                try { $rb = Compile-RuleBank -RuleBank $rb } catch {}
-                $script:RuleBankCache = $rb
-
-                # Build csvObjs once (prefer Import-CsvRows, else raw fallback)
-                $csvObjs = @()
-                if ($csvRows -and $csvRows.Count -gt 0) {
-                    $csvObjs = @($csvRows)
-                    Gui-Log ("üß† RuleEngine (shadow): CSV-k√§lla: Import-CsvRows ({0})" -f $csvObjs.Count) 'Info'
-                } else {
-                    try {
-                        $all = Get-Content -LiteralPath $selCsv
-                        if ($all -and $all.Count -gt 9) {
-                            $del = Get-CsvDelimiter -Path $selCsv
-                            $hdr = ConvertTo-CsvFields $all[7]
-                            $dl  = $all[9..($all.Count-1)] | Where-Object { $_ -and $_.Trim() }
-                            $csvObjs = @(ConvertFrom-Csv -InputObject ($dl -join "`n") -Delimiter $del -Header $hdr)
-                        }
-                    } catch {
-                        $csvObjs = @()
-                    }
-                    Gui-Log ("üß† RuleEngine (shadow): CSV-k√§lla: Fallback-raw ({0})" -f ($csvObjs.Count)) 'Info'
-                }
-
-                $script:RuleEngineCsvObjs = $csvObjs
-
-                if (-not $csvObjs -or $csvObjs.Count -eq 0) {
-                    Gui-Log "‚ö†Ô∏è RuleEngine (shadow): CSV-objekt saknas (0 rader) ‚Äì hoppar √∂ver." 'Warn'
-                    $script:RuleEngineShadow = $null
-                } else {
-                    $re = Invoke-RuleEngine -CsvObjects $csvObjs -RuleBank $rb -CsvPath $selCsv
-                    $script:RuleEngineShadow = $re
-
-                    if ($re -and $re.Summary) {
-                        $pairs = @()
-                        foreach ($k in $re.Summary.ObservedCounts.Keys) { $pairs += ("$k=$($re.Summary.ObservedCounts[$k])") }
-                        if ($pairs.Count -gt 0) { Gui-Log -Text ("üß† RuleEngine (shadow): ObservedCall counts: " + ($pairs -join ', ')) -Severity Info -Category RuleEngineStats }
-
-                        $dpairs = @()
-                        foreach ($k2 in $re.Summary.DeviationCounts.Keys) { $dpairs += ("$k2=$($re.Summary.DeviationCounts[$k2])") }
-                        if ($dpairs.Count -gt 0) { Gui-Log -Text ("üß† RuleEngine (shadow): Deviations: " + ($dpairs -join ', ')) -Severity Info -Category RuleEngineStats }
-
-                        if ($re.Summary.RetestYes -gt 0) { Gui-Log -Text ("üß† RuleEngine (shadow): Retest=YES count: " + $re.Summary.RetestYes) -Severity Info -Category RuleEngineStats }
-
-                        # Single user-facing summary line (keeps GUI clean)
-                        if (Get-ConfigFlag -Name 'EnableRuleEngineSummaryLog' -Default $false -ConfigOverride $Config) {
-                            try {
-                                $pos = 0; $neg = 0; $err = 0
-                                if ($re.Summary.ObservedCounts) {
-                                    if ($re.Summary.ObservedCounts.ContainsKey('POS'))   { $pos = [int]$re.Summary.ObservedCounts['POS'] }
-                                    if ($re.Summary.ObservedCounts.ContainsKey('NEG'))   { $neg = [int]$re.Summary.ObservedCounts['NEG'] }
-                                    if ($re.Summary.ObservedCounts.ContainsKey('ERROR')) { $err = [int]$re.Summary.ObservedCounts['ERROR'] }
-                                }
-
-                                # Deviations: OK / FP / ERROR (match your log labels)
-                                $ok = 0; $fp = 0; $fn = 0; $derr = 0
-                                if ($re.Summary.DeviationCounts) {
-                                    if ($re.Summary.DeviationCounts.ContainsKey('OK'))    { $ok   = [int]$re.Summary.DeviationCounts['OK'] }
-                                    if ($re.Summary.DeviationCounts.ContainsKey('FP'))    { $fp   = [int]$re.Summary.DeviationCounts['FP'] }
-                                    if ($re.Summary.DeviationCounts.ContainsKey('FN'))    { $fn   = [int]$re.Summary.DeviationCounts['FN'] }
-                                    if ($re.Summary.DeviationCounts.ContainsKey('ERROR')) { $derr = [int]$re.Summary.DeviationCounts['ERROR'] }
-                                }
-
-                                $rt = [int]$re.Summary.RetestYes
-                                $sum = "üß† Regelkontroll: POS=$pos, NEG=$neg, FEL=$err | OK=$ok, FP=$fp, FN=$fn, FEL=$derr | Omtest=$rt"
-                                Gui-Log -Text $sum -Severity Info -Category SUMMARY
-                            } catch { }
-                        }
-
-                        if ((Get-ConfigFlag -Name 'EnableShadowCompare' -Default $false -ConfigOverride $Config) -and $re.TopDeviations) {
-                            $n = 0
-                            foreach ($d in $re.TopDeviations) {
-                                $n++; if ($n -gt 20) { break }
-                                $msg = "‚ö†Ô∏è RuleEngine dev: " + ($d.Deviation + '') + " | " + ($d.SampleId + '') + " | Exp=" + ($d.ExpectedCall + '') + " | Obs=" + ($d.ObservedCall + '')
-                                if (($d.ErrorCode + '').Trim()) { $msg += " | Err=" + ($d.ErrorCode + '') }
-                                Gui-Log -Text $msg -Severity Info -Category RuleEngineDev
-                            }
-                        }
-                    }
-                }
-            }
-        } catch {
-            Gui-Log ("‚ö†Ô∏è RuleEngine (shadow) fel: " + $_.Exception.Message) 'Warn'
-        }
-
-        $controlTab = $null
-        if ($runAssay) { $controlTab = Get-ControlTabName -AssayName $runAssay }
-        if ($controlTab) { Gui-Log "üß™ Control Material-flik: $controlTab" } else { Gui-Log "‚ÑπÔ∏è Ingen control-mappning (forts√§tter utan)." }
-
-        # ============================
-        # === L√§s avvikelser       ===
-        # ============================
-
-        $violationsNeg = @(); $violationsPos = @(); $failNegCount = 0; $failPosCount = 0
-
-        foreach ($ws in $pkgNeg.Workbook.Worksheets) {
-            if ($ws.Name -eq "Worksheet Instructions") { continue }
-            if (-not $ws.Dimension) { continue }
-            $obsC = Find-ObservationCol $ws
-
-            for ($r = 3; $r -le 45; $r++) {
-                $valK = $ws.Cells["K$r"].Value
-                $textL = $ws.Cells["L$r"].Text
-
-                if ($valK -ne $null -and $valK -is [double]) {
-                    if ($textL -eq "FAIL" -or $valK -le -3.0) {
-                        $obsTxt = $ws.Cells[$r, $obsC].Text
-                        $violationsNeg += [PSCustomObject]@{
-                            Sheet      = $ws.Name
-                            Cartridge  = $ws.Cells["H$r"].Text
-                            InitialW   = $ws.Cells["I$r"].Value
-                            FinalW     = $ws.Cells["J$r"].Value
-                            WeightLoss = $valK
-                            Status     = if ($textL -eq "FAIL") { "FAIL" } else { "Minusv√§rde" }
-                            Obs        = $obsTxt
-                        }
-                        if ($textL -eq "FAIL") { $failNegCount++ }
-                    }
-                }
-            }
-        }
-
-        foreach ($ws in $pkgPos.Workbook.Worksheets) {
-            if ($ws.Name -eq "Worksheet Instructions") { continue }
-            if (-not $ws.Dimension) { continue }
-            $obsC = Find-ObservationCol $ws
-
-            for ($r = 3; $r -le 45; $r++) {
-                $valK = $ws.Cells["K$r"].Value
-                $textL = $ws.Cells["L$r"].Text
-
-                if ($valK -ne $null -and $valK -is [double]) {
-                    if ($textL -eq "FAIL" -or $valK -le -3.0) {
-                        $obsTxt = $ws.Cells[$r, $obsC].Text
-                        $violationsPos += [PSCustomObject]@{
-                            Sheet      = $ws.Name
-                            Cartridge  = $ws.Cells["H$r"].Text
-                            InitialW   = $ws.Cells["I$r"].Value
-                            FinalW     = $ws.Cells["J$r"].Value
-                            WeightLoss = $valK
-                            Status     = if ($textL -eq "FAIL") { "FAIL" } else { "Minusv√§rde" }
-                            Obs        = $obsTxt
-                        }
-                        if ($textL -eq "FAIL") { $failPosCount++ }
-                    }
-                }
-            }
-        }
-
-        # ============================
-        # === Seal Test Info (blad) ==
-        # ============================
-
-        $wsOut1 = $pkgOut.Workbook.Worksheets["Seal Test Info"]
-        if (-not $wsOut1) { Gui-Log "‚ùå Fliken 'Seal Test Info' saknas i mallen"; return }
-
-        for ($row = 3; $row -le 15; $row++) {
-            $wsOut1.Cells["D$row"].Value = $null
-            try { $wsOut1.Cells["D$row"].Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::None } catch {}
-        }
-
-        $fields = @(
-            @{ Label = "ROBAL";                         Cell = "F2"  }
-            @{ Label = "Part Number";                   Cell = "B2"  }
-            @{ Label = "Batch Number";                  Cell = "D2"  }
-            @{ Label = "Cartridge Number (LSP)";        Cell = "B6"  }
-            @{ Label = "PO Number";                     Cell = "B10" }
-            @{ Label = "Assay Family";                  Cell = "D10" }
-            @{ Label = "Weight Loss Spec";              Cell = "F10" }
-            @{ Label = "Balance ID Number";             Cell = "B14" }
-            @{ Label = "Balance Cal Due Date";          Cell = "D14" }
-            @{ Label = "Vacuum Oven ID Number";         Cell = "B20" }
-            @{ Label = "Vacuum Oven Cal Due Date";      Cell = "D20" }
-            @{ Label = "Timer ID Number";               Cell = "B25" }
-            @{ Label = "Timer Cal Due Date";            Cell = "D25" }
-        )
-
-        $forceText = @("ROBAL","Part Number","Batch Number","Cartridge Number (LSP)","PO Number","Assay Family","Balance ID Number","Vacuum Oven ID Number","Timer ID Number")
-        $mismatchFields = $fields[0..6] | ForEach-Object { $_.Label }
-
-        $row = 3
-        foreach ($f in $fields) {
-            $valNeg=''; $valPos=''
-
-            foreach ($wsN in $pkgNeg.Workbook.Worksheets) {
-                if ($wsN.Name -eq "Worksheet Instructions") { continue }
-                $cell = $wsN.Cells[$f.Cell]
-                if ($cell.Value -ne $null) {
-                    if ($cell.Value -is [datetime]) { $valNeg = $cell.Value.ToString('MMM-yy') } else { $valNeg = $cell.Text }
-                    break
-                }
-            }
-
-            foreach ($wsP in $pkgPos.Workbook.Worksheets) {
-                if ($wsP.Name -eq "Worksheet Instructions") { continue }
-                $cell = $wsP.Cells[$f.Cell]
-                if ($cell.Value -ne $null) {
-                    if ($cell.Value -is [datetime]) { $valPos = $cell.Value.ToString('MMM-yy') } else { $valPos = $cell.Text }
-                    break
-                }
-            }
-
-            if ($forceText -contains $f.Label) {
-                $wsOut1.Cells["B$row"].Style.Numberformat.Format = '@'
-                $wsOut1.Cells["C$row"].Style.Numberformat.Format = '@'
-            }
-
-            $wsOut1.Cells["B$row"].Value = $valNeg
-            $wsOut1.Cells["C$row"].Value = $valPos
-            $wsOut1.Cells["B$row"].Style.Border.Right.Style = "Medium"
-            $wsOut1.Cells["C$row"].Style.Border.Left.Style  = "Medium"
-
-        if ($mismatchFields -contains $f.Label) {
-                # D3:D9: visa tydlig Match/Mismatch med symboler
-                if ($valNeg -and $valPos) {
-                    if ($valNeg -ne $valPos) {
-                        $wsOut1.Cells["D$row"].Value = "‚ö† Mismatch"
-                        Style-Cell $wsOut1.Cells["D$row"] $true "FF0000" "Medium" "FFFFFF"
-                        Gui-Log "‚ö†Ô∏è Avvikelse: $($f.Label) (NEG='$valNeg' vs POS='$valPos')"
-                    } else {
-                        $wsOut1.Cells["D$row"].Value = "‚úì Match"
-                        Style-Cell $wsOut1.Cells["D$row"] $true "C6EFCE" "Medium" "006100"
-                    }
-                } elseif ($valNeg -or $valPos) {
-                    # Bara en av filerna har v√§rde - markera som varning
-                    $wsOut1.Cells["D$row"].Value = "‚ö† Saknas"
-                    Style-Cell $wsOut1.Cells["D$row"] $true "FFE699" "Medium" "806000"
-                }
-            }
-            $row++
-        }
-
-        $wsOut1.Cells["D:D"].Style.WrapText = $false
-        $wsOut1.Column(4).AutoFit()
-        $wsOut1.Column(4).Width += 1.5
-        $wsOut1.Column(4).BestFit = $true
-
-        # ============================
-        # === Testare (B43)        ===
-        # ============================
-
-        $testersNeg = @(); $testersPos = @()
-        foreach ($s in $pkgNeg.Workbook.Worksheets | Where-Object { $_.Name -ne "Worksheet Instructions" }) {
-            $t=$s.Cells["B43"].Text
-            if ($t) { $testersNeg += ($t -split ",") }
-        }
-        foreach ($s in $pkgPos.Workbook.Worksheets | Where-Object { $_.Name -ne "Worksheet Instructions" }) {
-            $t=$s.Cells["B43"].Text
-            if ($t) { $testersPos += ($t -split ",") }
-        }
-        $testersNeg = $testersNeg | ForEach-Object { $_.Trim() } | Where-Object { $_ } | Sort-Object -Unique
-        $testersPos = $testersPos | ForEach-Object { $_.Trim() } | Where-Object { $_ } | Sort-Object -Unique
-
-        $wsOut1.Cells["B16"].Value = "Name of Tester"
-        $wsOut1.Cells["B16:C16"].Merge = $true
-        $wsOut1.Cells["B16"].Style.HorizontalAlignment = "Center"
-
-        $maxTesters = [Math]::Max($testersNeg.Count, $testersPos.Count)
-        $initialRows = 11
-        if ($maxTesters -lt $initialRows) { $wsOut1.DeleteRow(17 + $maxTesters, $initialRows - $maxTesters) }
-        if ($maxTesters -gt $initialRows) {
-            $rowsToAdd = $maxTesters - $initialRows
-            $lastRow = 16 + $initialRows
-            for ($i = 1; $i -le $rowsToAdd; $i++) { $wsOut1.InsertRow($lastRow + 1, 1, $lastRow) }
-        }
-
-        for ($i = 0; $i -lt $maxTesters; $i++) {
-            $rowIndex = 17 + $i
-            $wsOut1.Cells["A$rowIndex"].Value = $null
-            $wsOut1.Cells["B$rowIndex"].Value = if ($i -lt $testersNeg.Count) { $testersNeg[$i] } else { "N/A" }
-            $wsOut1.Cells["C$rowIndex"].Value = if ($i -lt $testersPos.Count) { $testersPos[$i] } else { "N/A" }
-
-            $topStyle    = if ($i -eq 0) { "Medium" } else { "Thin" }
-            $bottomStyle = if ($i -eq $maxTesters - 1) { "Medium" } else { "Thin" }
-
-            foreach ($col in @("B","C")) {
-                $cell = $wsOut1.Cells["$col$rowIndex"]
-                $cell.Style.Border.Top.Style    = $topStyle
-                $cell.Style.Border.Bottom.Style = $bottomStyle
-                $cell.Style.Border.Left.Style   = "Medium"
-                $cell.Style.Border.Right.Style  = "Medium"
-                $cell.Style.Fill.PatternType = "Solid"
-                $cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
-            }
-        }
-
-        # ============================
-        # === Signatur-j√§mf√∂relse  ===
-        # ============================
-
-        $negSigSet = Get-SignatureSetForDataSheets -Pkg $pkgNeg
-        $posSigSet = Get-SignatureSetForDataSheets -Pkg $pkgPos
-
-        $negSet = New-Object 'System.Collections.Generic.HashSet[string]'
-        $posSet = New-Object 'System.Collections.Generic.HashSet[string]'
-        foreach ($n in $negSigSet.NormSet) { [void]$negSet.Add($n) }
-        foreach ($p in $posSigSet.NormSet) { [void]$posSet.Add($p) }
-
-        $hasNeg = ($negSet.Count -gt 0)
-        $hasPos = ($posSet.Count -gt 0)
-
-        $onlyNeg = @(); $onlyPos = @(); $sigMismatch = $false
-        if ($hasNeg -and $hasPos) {
-            foreach ($n in $negSet) { if (-not $posSet.Contains($n)) { $onlyNeg += $n } }
-            foreach ($p in $posSet) { if (-not $negSet.Contains($p)) { $onlyPos += $p } }
-            $sigMismatch = ($onlyNeg.Count -gt 0 -or $onlyPos.Count -gt 0)
-        } else {
-            $sigMismatch = $false
-        }
-
-        $mismatchSheets = @()
-        if ($sigMismatch) {
-            foreach ($k in $onlyNeg) {
-                $raw = if ($negSigSet.RawByNorm.ContainsKey($k)) { $negSigSet.RawByNorm[$k] } else { $k }
-                $where = if ($negSigSet.Occ.ContainsKey($k)) { ($negSigSet.Occ[$k] -join ', ') } else { '‚Äî' }
-                $mismatchSheets += ("NEG: " + $raw + "  [Blad: " + $where + "]")
-            }
-            foreach ($k in $onlyPos) {
-                $raw = if ($posSigSet.RawByNorm.ContainsKey($k)) { $posSigSet.RawByNorm[$k] } else { $k }
-                $where = if ($posSigSet.Occ.ContainsKey($k)) { ($posSigSet.Occ[$k] -join ', ') } else { '‚Äî' }
-                $mismatchSheets += ("POS: " + $raw + "  [Blad: " + $where + "]")
-            }
-            Gui-Log "‚ö†Ô∏è Avvikelse: Print Full Name, Sign, and Date (NEG vs POS)"
-        }
-
-        if (-not (Get-Command Set-MergedWrapAutoHeight -ErrorAction SilentlyContinue)) {
-            function Set-MergedWrapAutoHeight {
-                param([OfficeOpenXml.ExcelWorksheet]$Sheet,[int]$RowIndex,[int]$ColStart=2,[int]$ColEnd=3,[string]$Text)
-                $rng = $Sheet.Cells[$RowIndex, $ColStart, $RowIndex, $ColEnd]
-                $rng.Style.WrapText = $true
-                $rng.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::None
-                $Sheet.Row($RowIndex).CustomHeight = $false
-                try {
-                    $wChars = [Math]::Floor(($Sheet.Column($ColStart).Width + $Sheet.Column($ColEnd).Width) - 2); if ($wChars -lt 1) { $wChars = 1 }
-                    $segments = $Text -split "(\r\n|\n|\r)"; $lineCount = 0
-                    foreach ($seg in $segments) { if (-not $seg) { $lineCount++ } else { $lineCount += [Math]::Ceiling($seg.Length / $wChars) } }
-                    if ($lineCount -lt 1) { $lineCount = 1 }
-                    $targetHeight = [Math]::Max(15, [Math]::Ceiling(15 * $lineCount * 2.15))
-                    if ($Sheet.Row($RowIndex).Height -lt $targetHeight) {
-                        $Sheet.Row($RowIndex).Height = $targetHeight
-                        $Sheet.Row($RowIndex).CustomHeight = $true
-                    }
-                } catch { $Sheet.Row($RowIndex).CustomHeight = $false }
-            }
-        }
-
-        $signRow = 17 + $maxTesters + 3
-        $displaySignNeg = $null; $displaySignPos = $null
-
-        if ($signToWrite) {
-            $displaySignNeg = $signToWrite
-            $displaySignPos = $signToWrite
-        } else {
-            $displaySignNeg = if ($negSigSet.RawFirst) { $negSigSet.RawFirst } else { '‚Äî' }
-            $displaySignPos = if ($posSigSet.RawFirst) { $posSigSet.RawFirst } else { '‚Äî' }
-        }
-
-        $wsOut1.Cells["B$signRow"].Style.Numberformat.Format = '@'
-        $wsOut1.Cells["C$signRow"].Style.Numberformat.Format = '@'
-        $wsOut1.Cells["B$signRow"].Value = $displaySignNeg
-        $wsOut1.Cells["C$signRow"].Value = $displaySignPos
-
-        foreach ($col in @('B','C')) {
-            $cell = $wsOut1.Cells["${col}$signRow"]
-            Style-Cell $cell $false 'CCFFFF' 'Medium' $null
-            $cell.Style.HorizontalAlignment = 'Center'
-        }
-
-        try { $wsOut1.Column(2).Width = 40; $wsOut1.Column(3).Width = 40 } catch {}
-        try { $wsOut1.Column(4).Width = 10 } catch {}
-
-        if ($sigMismatch) {
-            # === MISMATCH: R√∂d markering och detaljerad tabell med fet border ===
-            $mismatchCell = $wsOut1.Cells["D$signRow"]
-            $mismatchCell.Value = '‚ö† Mismatch'
-            Style-Cell $mismatchCell $true 'FF0000' 'Medium' 'FFFFFF'
-
-            if ($mismatchSheets.Count -gt 0) {
-                # Rubrikrad f√∂r mismatch-detaljer
-                $headerRow = $signRow + 1
-                $wsOut1.Cells["A$headerRow"].Value = 'Fil'
-                $wsOut1.Cells["B$headerRow"].Value = 'Signatur'
-                $wsOut1.Cells["C$headerRow"].Value = 'Blad'
-                foreach ($col in @('A','B','C')) {
-                    $hdrCell = $wsOut1.Cells["$col$headerRow"]
-                    $hdrCell.Style.Font.Bold = $true
-                    $hdrCell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
-                    $hdrCell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#FFE699'))
-                    $hdrCell.Style.HorizontalAlignment = [OfficeOpenXml.Style.ExcelHorizontalAlignment]::Center
-                }
-
-                $lastDataRow = $headerRow
-                for ($j = 0; $j -lt $mismatchSheets.Count; $j++) {
-                    $rowIdx = $headerRow + 1 + $j
-                    $lastDataRow = $rowIdx
-                    $text = $mismatchSheets[$j]
-
-                    # Parsa "NEG: signatur  [Blad: namn]" eller "POS: signatur  [Blad: namn]"
-                    $filType = ''; $sigVal = ''; $bladVal = ''
-                    if ($text -match '^(NEG|POS):\s*(.+?)\s*\[Blad:\s*(.+?)\]$') {
-                        $filType = $matches[1]
-                        $sigVal  = $matches[2].Trim()
-                        $bladVal = $matches[3].Trim()
-                    } else {
-                        $sigVal = $text
-                    }
-
-                    $wsOut1.Cells["A$rowIdx"].Value = $filType
-                    $wsOut1.Cells["B$rowIdx"].Value = $sigVal
-                    $wsOut1.Cells["C$rowIdx"].Value = $bladVal
-
-                    # F√§rgkoda per fil
-                    $bgColor = if ($filType -eq 'NEG') { '#B5E6A2' } else { '#FFB3B3' }
-                    foreach ($col in @('A','B','C')) {
-                        $dataCell = $wsOut1.Cells["$col$rowIdx"]
-                        $dataCell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
-                        $dataCell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml($bgColor))
-                    }
-                }
-                
-                # === FET YTTRE BORDER runt hela mismatch-tabellen ===
-                try {
-                    $borderColor = [System.Drawing.Color]::FromArgb(0, 0, 0) # SVART
-                    
-                    # Topp-border p√• header-raden
-                    for ($c = 1; $c -le 3; $c++) {
-                        $wsOut1.Cells[$headerRow, $c].Style.Border.Top.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
-                        $wsOut1.Cells[$headerRow, $c].Style.Border.Top.Color.SetColor($borderColor)
-                    }
-                    
-                    # Botten-border p√• sista data-raden
-                    for ($c = 1; $c -le 3; $c++) {
-                        $wsOut1.Cells[$lastDataRow, $c].Style.Border.Bottom.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
-                        $wsOut1.Cells[$lastDataRow, $c].Style.Border.Bottom.Color.SetColor($borderColor)
-                    }
-                    
-                    # V√§nster-border p√• kolumn A (alla rader)
-                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
-                        $wsOut1.Cells[$r, 1].Style.Border.Left.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
-                        $wsOut1.Cells[$r, 1].Style.Border.Left.Color.SetColor($borderColor)
-                    }
-                    
-                    # H√∂ger-border p√• kolumn C (alla rader)
-                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
-                        $wsOut1.Cells[$r, 3].Style.Border.Right.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
-                        $wsOut1.Cells[$r, 3].Style.Border.Right.Color.SetColor($borderColor)
-                    }
-                    
-                    # Inre tunna borders
-                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
-                        for ($c = 1; $c -le 3; $c++) {
-                            if ($r -lt $lastDataRow) {
-                                $wsOut1.Cells[$r, $c].Style.Border.Bottom.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
-                            }
-                            if ($c -lt 3) {
-                                $wsOut1.Cells[$r, $c].Style.Border.Right.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
-                            }
-                        }
-                    }
-                } catch {}
-            }
-        } else {
-            # === MATCH: Gr√∂n markering n√§r signaturer st√§mmer ===
-            if ($hasNeg -and $hasPos) {
-                $matchCell = $wsOut1.Cells["D$signRow"]
-                $matchCell.Value = '‚úì Match'
-                Style-Cell $matchCell $true 'C6EFCE' 'Medium' '006100'
-            }
-        }
-
-        # ============================
-        # === STF Sum              ===
-        # ============================
-
-        $wsOut2 = $pkgOut.Workbook.Worksheets["STF Sum"]
-        if (-not $wsOut2) { Gui-Log "‚ùå Fliken 'STF Sum' saknas i mallen!"; return }
-
-        $totalRows = $violationsNeg.Count + $violationsPos.Count
-        $currentRow = 2
-
-        if ($totalRows -eq 0) {
-            Gui-Log "‚úÖ Seal Test hittades"
-            $wsOut2.Cells["B1:H1"].Value = $null
-            $wsOut2.Cells["A1"].Value = "Inga STF hittades!"
-            Style-Cell $wsOut2.Cells["A1"] $true "D9EAD3" "Medium" "006100"
-            $wsOut2.Cells["A1"].Style.HorizontalAlignment = "Left"
-            if ($wsOut2.Dimension -and $wsOut2.Dimension.End.Row -gt 1) { $wsOut2.DeleteRow(2, $wsOut2.Dimension.End.Row - 1) }
-        }
-        else {
-            Gui-Log "‚ùó $failNegCount avvikelser i NEG, $failPosCount i POS"
-
-            $oldDataRows = 0
-            if ($wsOut2.Dimension) {
-                $oldDataRows = $wsOut2.Dimension.End.Row - 1
-                if ($oldDataRows -lt 0) { $oldDataRows = 0 }
-            }
-
-            if ($totalRows -lt $oldDataRows) {
-                $wsOut2.DeleteRow(2 + $totalRows, $oldDataRows - $totalRows)
-            }
-            elseif ($totalRows -gt $oldDataRows) {
-                $wsOut2.InsertRow(2 + $oldDataRows, $totalRows - $oldDataRows, 1 + $oldDataRows)
-            }
-
-            $currentRow = 2
-            foreach ($v in $violationsNeg) {
-                $wsOut2.Cells["A$currentRow"].Value = "NEG"
-                $wsOut2.Cells["B$currentRow"].Value = $v.Sheet
-                $wsOut2.Cells["C$currentRow"].Value = $v.Cartridge
-                $wsOut2.Cells["D$currentRow"].Value = $v.InitialW
-                $wsOut2.Cells["E$currentRow"].Value = $v.FinalW
-                $wsOut2.Cells["F$currentRow"].Value = [Math]::Round($v.WeightLoss, 1)
-                $wsOut2.Cells["G$currentRow"].Value = $v.Status
-                $wsOut2.Cells["H$currentRow"].Value = if ([string]::IsNullOrWhiteSpace($v.Obs)) { 'NA' } else { $v.Obs }
-
-                Style-Cell $wsOut2.Cells["A$currentRow"] $true "B5E6A2" "Medium" $null
-                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
-                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#FFFF99"))
-                $wsOut2.Cells["H$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["H$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#D9D9D9"))
-
-                if ($v.Status -in @("FAIL","Minusv√§rde")) {
-                    $wsOut2.Cells["F$currentRow"].Style.Font.Bold = $true
-                    $wsOut2.Cells["F$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
-                    $wsOut2.Cells["G$currentRow"].Style.Font.Bold = $true
-                    $wsOut2.Cells["G$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
-                }
-
-                Set-RowBorder -ws $wsOut2 -row $currentRow -firstRow 2 -lastRow ($totalRows + 1)
-                $currentRow++
-            }
-
-            foreach ($v in $violationsPos) {
-                $wsOut2.Cells["A$currentRow"].Value = "POS"
-                $wsOut2.Cells["B$currentRow"].Value = $v.Sheet
-                $wsOut2.Cells["C$currentRow"].Value = $v.Cartridge
-                $wsOut2.Cells["D$currentRow"].Value = $v.InitialW
-                $wsOut2.Cells["E$currentRow"].Value = $v.FinalW
-                $wsOut2.Cells["F$currentRow"].Value = [Math]::Round($v.WeightLoss, 1)
-                $wsOut2.Cells["G$currentRow"].Value = $v.Status
-                $wsOut2.Cells["H$currentRow"].Value = if ($v.Obs) { $v.Obs } else { 'NA' }
-
-                Style-Cell $wsOut2.Cells["A$currentRow"] $true "FFB3B3" "Medium" $null
-                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
-                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#FFFF99"))
-                $wsOut2.Cells["H$currentRow"].Style.Fill.PatternType = "Solid"
-                $wsOut2.Cells["H$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#D9D9D9"))
-
-                if ($v.Status -in @("FAIL","Minusv√§rde")) {
-                    $wsOut2.Cells["F$currentRow"].Style.Font.Bold = $true
-                    $wsOut2.Cells["F$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
-                    $wsOut2.Cells["G$currentRow"].Style.Font.Bold = $true
-                    $wsOut2.Cells["G$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
-                }
-
-                Set-RowBorder -ws $wsOut2 -row $currentRow -firstRow 2 -lastRow ($totalRows + 1)
-                $currentRow++
-            }
-
-            $wsOut2.Cells.Style.WrapText = $false
-            $wsOut2.Cells["A1"].Style.HorizontalAlignment = "Left"
-            try { $wsOut2.Cells[2,6,([Math]::Max($currentRow-1,2)),6].Style.Numberformat.Format = '0.0' } catch {}
-            if ($wsOut2.Dimension) {
-                try {
-                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                        Safe-AutoFitColumns -Ws $wsOut2 -Context 'OutputSheet'
-                    } else {
-                        $wsOut2.Cells[$wsOut2.Dimension.Address].AutoFitColumns() | Out-Null
-                    }
-                } catch {}
-            }
-        }
-
-
-‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ# ============================
-# === Information-blad     ===
-# ============================
-
-try {
-    if (-not (Get-Command Add-Hyperlink -ErrorAction SilentlyContinue)) {
-        function Add-Hyperlink {
-            param(
-                [OfficeOpenXml.ExcelRange]$Cell,
-                [string]$Text,
-                [string]$Url
-            )
-            try {
-                $Cell.Value = $Text
-                $Cell.Hyperlink = [Uri]$Url
-                $Cell.Style.Font.UnderLine = $true
-                $Cell.Style.Font.Color.SetColor([System.Drawing.Color]::FromArgb(0,102,204))
-            } catch {}
-        }
-    }
-
-    if (-not (Get-Command Find-RegexCell -ErrorAction SilentlyContinue)) {
-        function Find-RegexCell {
-            param(
-                [OfficeOpenXml.ExcelWorksheet]$Ws,
-                [regex]$Rx,
-                [int]$MaxRows = 200,
-                [int]$MaxCols = 40
-            )
-            if (-not $Ws -or -not $Ws.Dimension) { return $null }
-
-            $rMax = [Math]::Min($Ws.Dimension.End.Row, $MaxRows)
-            $cMax = [Math]::Min($Ws.Dimension.End.Column, $MaxCols)
-
-            for ($r = 1; $r -le $rMax; $r++) {
-                for ($c = 1; $c -le $cMax; $c++) {
-                    $t = Normalize-HeaderText ($Ws.Cells[$r,$c].Text + '')
-                    if ($t -and $Rx.IsMatch($t)) {
-                        return @{ Row = $r; Col = $c; Text = $t }
-                    }
-                }
-            }
-            return $null
-        }
-    }
-
-    if (-not (Get-Command Get-SealHeaderDocInfo -ErrorAction SilentlyContinue)) {
-        function Get-SealHeaderDocInfo {
-            param([OfficeOpenXml.ExcelPackage]$Pkg)
-
-            $result = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' }
-            if (-not $Pkg) { return $result }
-
-            $ws = $Pkg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
-            if (-not $ws) { return $result }
-
-            try {
-                $lt = ($ws.HeaderFooter.OddHeader.LeftAlignedText + '').Trim()
-                if (-not $lt) { $lt = ($ws.HeaderFooter.EvenHeader.LeftAlignedText + '').Trim() }
-
-                $result.Raw = $lt
-
-                $rx = [regex]'(?i)(?:document\s*(?:no|nr|#|number)\s*[:#]?\s*([A-Z0-9\-_\.\/]+))?.*?(?:rev(?:ision)?\.?\s*[:#]?\s*([A-Z0-9\-_\.]+))?'
-                $m = $rx.Match($lt)
-                if ($m.Success) {
-                    if ($m.Groups[1].Value) { $result.DocNo = $m.Groups[1].Value.Trim() }
-                    if ($m.Groups[2].Value) { $result.Rev   = $m.Groups[2].Value.Trim() }
-                }
-            } catch {}
-
-            return $result
-        }
-    }
-
-    $wsInfo = $pkgOut.Workbook.Worksheets['Information']
-    if (-not $wsInfo) { $wsInfo = $pkgOut.Workbook.Worksheets.Add('Information') }
-
-    try { $wsInfo.Cells.Style.Font.Name = 'Arial'; $wsInfo.Cells.Style.Font.Size = 11 } catch {}
-
-    try {
-        $csvLines = $null
-        $csvStats = $null
-
-        # ‚úÖ Viktigt: initiera alltid, √§ven om ingen CSV √§r vald
-        $csvInstrumentSerials = @()
-
-        if ($selCsv -and (Test-Path -LiteralPath $selCsv)) {
-            try { $csvLines = Get-Content -LiteralPath $selCsv } catch { Gui-Log ("‚ö†Ô∏è Kunde inte l√§sa CSV: " + $_.Exception.Message) 'Warn' }
-            try { $csvStats = Get-CsvStats -Path $selCsv -Lines $csvLines } catch { Gui-Log ("‚ö†Ô∏è Get-CsvStats: " + $_.Exception.Message) 'Warn' }
-
-            # Extract exact Instrument S/N list from CSV (for Equipment sheet when WS scan is disabled)
-            try {
-                if ($csvLines -and $csvLines.Count -gt 8) {
-                    $hdr = ConvertTo-CsvFields $csvLines[7]
-
-                    $idx = -1
-                    for ($ii=0; $ii -lt $hdr.Count; $ii++) {
-                        $h = (($hdr[$ii] + '').Trim('\"').ToLower())
-                        if ($h -eq 'instrument s/n' -or $h -match 'instrument') { $idx = $ii; break }
-                    }
-
-                    if ($idx -ge 0) {
-                        $set = New-Object System.Collections.Generic.HashSet[string]
-                        for ($rr=9; $rr -lt $csvLines.Count; $rr++) {
-                            $ln = $csvLines[$rr]
-                            if (-not $ln -or -not $ln.Trim()) { continue }
-                            $f = ConvertTo-CsvFields $ln
-                            if ($f.Count -gt $idx) {
-                                $v = ($f[$idx] + '').Trim().Trim('\"')
-                                if ($v) { $null = $set.Add($v) }
-                            }
-                        }
-
-                        # HashSet[T] enumerate (PS 5.1 safe)
-                        $csvInstrumentSerials = @($set | Sort-Object)
-                    }
-                }
-            } catch {
-                Gui-Log ("‚ö†Ô∏è Kunde inte extrahera Instrument S/N fr√•n CSV: " + $_.Exception.Message) 'Warn'
-                $csvInstrumentSerials = @()
-            }
-        }
-
-        if (-not $csvStats) {
-            $csvStats = [pscustomobject]@{
-                TestCount    = 0
-                DupCount     = 0
-                Duplicates   = @()
-                LspValues    = @()
-                LspOK        = $null
-                InstrumentByType = [ordered]@{}
-            }
-        }
-
-        $infSN = @()
-        if ($script:GXINF_Map) {
-            foreach ($k in $script:GXINF_Map.Keys) {
-                if ($k -like 'Infinity-*') {
-                    $infSN += ($script:GXINF_Map[$k].Split(',') | ForEach-Object { ($_ + '').Trim() } | Where-Object { $_ })
-                }
-            }
-        }
-        $infSN = $infSN | Select-Object -Unique
-
-        $infSummary = '‚Äî'
-        try {
-            if ($selCsv -and (Test-Path -LiteralPath $selCsv) -and $infSN.Count -gt 0) {
-                $infSummary = Get-InfinitySpFromCsvStrict -Path $selCsv -InfinitySerials $infSN -Lines $csvLines
-            }
-        } catch {
-            Gui-Log ("Infinity SP fel: " + $_.Exception.Message) 'Warn'
-        }
-
-        # --- Dubbletter Sample ID ---
-        $dupSampleCount = 0
-        $dupSampleList  = @()
-        if ($csvLines -and $csvLines.Count -gt 8) {
-            try {
-                $headerFields = ConvertTo-CsvFields $csvLines[7]
-                $sampleIdx = -1
-                for ($i=0; $i -lt $headerFields.Count; $i++) {
-                    $hf = ($headerFields[$i] + '').Trim().ToLower()
-                    if ($hf -match 'sample') { $sampleIdx = $i; break }
-                }
-                if ($sampleIdx -ge 0) {
-                    $samples = @()
-                    for ($r=9; $r -lt $csvLines.Count; $r++) {
-                        $line = $csvLines[$r]
-                        if (-not $line -or -not $line.Trim()) { continue }
-                        $fields = ConvertTo-CsvFields $line
-                        if ($fields.Count -gt $sampleIdx) {
-                            $val = ($fields[$sampleIdx] + '').Trim()
-                            if ($val) { $samples += $val }
-                        }
-                    }
-                    if ($samples.Count -gt 0) {
-                        $counts = @{}
-                        foreach ($s in $samples) { if (-not $counts.ContainsKey($s)) { $counts[$s] = 0 }; $counts[$s]++ }
-                        foreach ($entry in $counts.GetEnumerator()) {
-                            if ($entry.Value -gt 1) { $dupSampleList += ("$($entry.Key) x$($entry.Value)") }
-                        }
-                        $dupSampleCount = $dupSampleList.Count
-                    }
-                }
-            } catch {
-                Gui-Log ("‚ö†Ô∏è Fel vid analys av Sample ID: " + $_.Exception.Message) 'Warn'
-            }
-        }
-
-        $dupSampleText = if ($dupSampleCount -gt 0) {
-            $show = ($dupSampleList | Select-Object -First 8) -join ', '
-            "$dupSampleCount ($show)"
-        } else { 'N/A' }
-
-        $dupCartText = if ($csvStats.DupCount -gt 0) {
-            $show = ($csvStats.Duplicates | Select-Object -First 8) -join ', '
-            "$($csvStats.DupCount) ($show)"
-        } else { 'N/A' }
-
-        # --- LSP summary ---
-        $lspSummary = ''
-        try {
-            if ($csvLines -and $csvLines.Count -gt 8) {
-                $counts = @{}
-                for ($rr = 9; $rr -lt $csvLines.Count; $rr++) {
-                    $ln = $csvLines[$rr]
-                    if (-not $ln -or -not $ln.Trim()) { continue }
-                    $fs = ConvertTo-CsvFields $ln
-                    if ($fs.Count -gt 4) {
-                        $raw = ($fs[4] + '').Trim()
-                        if ($raw) {
-                            $mLsp = [regex]::Match($raw,'(\d{5})')
-                            $code = if ($mLsp.Success) { $mLsp.Groups[1].Value } else { $raw }
-                            if (-not $counts.ContainsKey($code)) { $counts[$code] = 0 }
-                            $counts[$code]++
-                        }
-                    }
-                }
-
-                if ($counts.Count -gt 0) {
-                    $sorted = $counts.GetEnumerator() | Sort-Object Key
-                    $parts = @()
-                    foreach ($kvp in $sorted) {
-                        $parts += $(if ($kvp.Value -gt 1) { "$($kvp.Key) x$($kvp.Value)" } else { $kvp.Key })
-                    }
-                    if ($sorted.Count -eq 1) { $lspSummary = $sorted[0].Key }
-                    else { $lspSummary = "$($sorted.Count) (" + ($parts -join ', ') + ")" }
-                }
-            }
-        } catch {
-            Gui-Log ("‚ö†Ô∏è Fel vid extraktion av LSP fr√•n CSV: " + $_.Exception.Message) 'Warn'
-            $lspSummary = ''
-        }
-
-        $instText = if ($csvStats.InstrumentByType.Keys.Count -gt 0) {
-            ($csvStats.InstrumentByType.GetEnumerator() | ForEach-Object { "$($_.Key)" } | Sort-Object) -join '; '
-        } else { '' }
-
-        function Find-InfoRow {
-            param([OfficeOpenXml.ExcelWorksheet]$Ws, [string]$Label)
-            if (-not $Ws -or -not $Ws.Dimension) { return $null }
-            $maxRow = [Math]::Min($Ws.Dimension.End.Row, 300)
-            for ($ri=1; $ri -le $maxRow; $ri++) {
-                $txt = (($Ws.Cells[$ri,1].Text) + '').Trim()
-                if (-not $txt) { continue }
-                if ($txt.ToLowerInvariant() -eq $Label.ToLowerInvariant()) { return $ri }
-            }
-            return $null
-        }
-
-        # ‚úÖ Default: anta INTE new layout om vi inte hittar ankaret
-        $isNewLayout = $false
-        try {
-            $tmpRow = Find-InfoRow -Ws $wsInfo -Label 'CSV-Info'
-            if ($tmpRow) { $isNewLayout = $true }
-        } catch {}
-
-        $rowCsvFile    = Find-InfoRow -Ws $wsInfo -Label 'CSV'
-        $rowLsp        = Find-InfoRow -Ws $wsInfo -Label 'LSP'
-        $rowAntal      = Find-InfoRow -Ws $wsInfo -Label 'Antal tester'
-        $rowDupSample  = Find-InfoRow -Ws $wsInfo -Label 'Dubblett Sample ID'
-        if (-not $rowDupSample) { $rowDupSample = Find-InfoRow -Ws $wsInfo -Label 'Dublett Sample ID' }
-
-        $rowDupCart    = Find-InfoRow -Ws $wsInfo -Label 'Dubblett Cartridge S/N'
-        if (-not $rowDupCart) { $rowDupCart = Find-InfoRow -Ws $wsInfo -Label 'Dublett Cartridge S/N' }
-
-        $rowInst = Find-InfoRow -Ws $wsInfo -Label 'Anv√§nda INF/GX'
-
-        $rowBag = Find-InfoRow -Ws $wsInfo -Label 'Bag Numbers Tested Using Infinity'
-        if (-not $rowBag) { $rowBag = Find-InfoRow -Ws $wsInfo -Label 'Bag Numbers Tested Using Infinity:' }
-        if (-not $rowBag) { $rowBag = 14 }
-
-        $wsInfo.Cells["B$rowBag"].Style.Numberformat.Format = '@'
-        $wsInfo.Cells["B$rowBag"].Value = $infSummary
-
-        if ($isNewLayout) {
-            if (-not $rowCsvFile)   { $rowCsvFile   = 8 }
-            if (-not $rowLsp)       { $rowLsp       = 9 }
-            if (-not $rowAntal)     { $rowAntal     = 10 }
-            if (-not $rowDupSample) { $rowDupSample = 11 }
-            if (-not $rowDupCart)   { $rowDupCart   = 12 }
-            if (-not $rowInst)      { $rowInst      = 13 }
-        }
-
-        if ($selCsv) {
-            $wsInfo.Cells["B$rowCsvFile"].Style.Numberformat.Format = '@'
-            $wsInfo.Cells["B$rowCsvFile"].Value = (Split-Path $selCsv -Leaf)
-        } else {
-            $wsInfo.Cells["B$rowCsvFile"].Value = ''
-        }
-
-        $wsInfo.Cells["B$rowLsp"].Style.Numberformat.Format = '@'
-        $wsInfo.Cells["B$rowLsp"].Value = $(if ($lspSummary) { $lspSummary } else { $lsp })
-
-        # ‚úÖ Skriv Antal tester EN g√•ng (som text f√∂r att inte bli 1.00E+3 etc)
-        $wsInfo.Cells["B$rowAntal"].Style.Numberformat.Format = '@'
-        $wsInfo.Cells["B$rowAntal"].Value = "$($csvStats.TestCount)"
-
-        if ($rowDupSample) { $wsInfo.Cells["B$rowDupSample"].Value = $dupSampleText }
-        if ($rowDupCart)   { $wsInfo.Cells["B$rowDupCart"].Value   = $dupCartText }
-
-        if ($rowInst) { $wsInfo.Cells["B$rowInst"].Value = $instText }
-
-    } catch {
-        Gui-Log ("‚ö†Ô∏è CSV data-fel: " + $_.Exception.Message) 'Warn'
-    }
-
-    # --- Macro / docinfo ---
-    $assayForMacro = ''
-    if ($runAssay) { $assayForMacro = $runAssay }
-    elseif ($wsOut1) { $assayForMacro = ($wsOut1.Cells['D10'].Text + '').Trim() }
-
-    $miniVal = ''
-    if (Get-Command Get-MinitabMacro -ErrorAction SilentlyContinue) {
-        $miniVal = Get-MinitabMacro -AssayName $assayForMacro
-    }
-    if (-not $miniVal) { $miniVal = 'N/A' }
-
-    $hdNeg = $null; $hdPos = $null
-    try { $hdNeg = Get-SealHeaderDocInfo -Pkg $pkgNeg } catch {}
-    try { $hdPos = Get-SealHeaderDocInfo -Pkg $pkgPos } catch {}
-    if (-not $hdNeg) { $hdNeg = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' } }
-    if (-not $hdPos) { $hdPos = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' } }
-
-    $wsInfo.Cells['B2'].Value = $ScriptVersion
-    $wsInfo.Cells['B3'].Value = $env:USERNAME
-    $wsInfo.Cells['B4'].Value = (Get-Date).ToString('yyyy-MM-dd HH:mm')
-    $wsInfo.Cells['B5'].Value = $miniVal
-
-    # --- Batch + l√§nkar ---
-    $selLsp = $null
-    try {
-        if (Get-Variable -Name clbLsp -ErrorAction SilentlyContinue) {
-            $selLsp = Get-CheckedFilePath $clbLsp
-        }
-    } catch {}
-
-    $batchInfo = Get-BatchLinkInfo -SealPosPath $selPos -SealNegPath $selNeg -Lsp $lspForLinks
-    $batch     = $batchInfo.Batch
-
-    $wsInfo.Cells['A34'].Value = 'SharePoint Batch'
-    $wsInfo.Cells['A34'].Style.Font.Bold = $true
-    Add-Hyperlink -Cell $wsInfo.Cells['B34'] -Text $batchInfo.LinkText -Url $batchInfo.Url
-
-    $linkMap = [ordered]@{
-        'IPT App'      = 'https://apps.powerapps.com/play/e/default-771c9c47-7f24-44dc-958e-34f8713a8394/a/fd340dbd-bbbf-470b-b043-d2af4cb62c83'
-        'MES Login'    = 'http://mes.cepheid.pri/camstarportal/?domain=CEPHEID.COM'
-        'CSV Uploader' = 'http://auw2wgxtpap01.cepaws.com/Welcome.aspx'
-        'BMRAM'        = 'https://cepheid62468.coolbluecloud.com/'
-        'Agile'        = 'https://agileprod.cepheid.com/Agile/default/login-cms.jsp'
-    }
-
-    $rowLink = 35
-    foreach ($key in $linkMap.Keys) {
-        $wsInfo.Cells["A$rowLink"].Value = $key
-        Add-Hyperlink -Cell $wsInfo.Cells["B$rowLink"] -Text 'L√ÑNK' -Url $linkMap[$key]
-        $rowLink++
-    }
-
-} catch {
-    Gui-Log ("‚ö†Ô∏è Information-blad fel: " + $_.Exception.Message) 'Warn'
-}
-‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ
-# ----------------------------------------------------------------
-# WS (LSP Worksheet): hitta fil och skriv in i Information-bladet
-# ----------------------------------------------------------------
-try {
-    if (-not $selLsp) {
-        $probeDir = $null
-        if ($selPos) { $probeDir = Split-Path -Parent $selPos }
-        if (-not $probeDir -and $selNeg) { $probeDir = Split-Path -Parent $selNeg }
-
-        if ($probeDir -and (Test-Path -LiteralPath $probeDir)) {
-            $cand = Get-ChildItem -LiteralPath $probeDir -File -ErrorAction SilentlyContinue |
-                    Where-Object {
-                        ($_.Name -match '(?i)worksheet') -and
-                        ($_.Name -match [regex]::Escape($lsp)) -and
-                        ($_.Extension -match '^\.(xlsx|xlsm|xls)$')
-                    } |
-                    Sort-Object LastWriteTime -Descending |
-                    Select-Object -First 1
-
-            if ($cand) { $selLsp = $cand.FullName }
-        }
-    }
-
-    if (-not (Get-Command Find-LabelValueRightward -ErrorAction SilentlyContinue)) {
-        function Find-LabelValueRightward {
-            param(
-                [OfficeOpenXml.ExcelWorksheet]$Ws,
-                [string]$Label,
-                [int]$MaxRows = 200,
-                [int]$MaxCols = 40
-            )
-            if (-not $Ws -or -not $Ws.Dimension) { return $null }
-
-            $normLbl = Normalize-HeaderText $Label
-            $pat = '^(?i)\s*' + [regex]::Escape($normLbl).Replace('\ ', '\s*') + '\s*[:\.]*\s*$'
-            $rx  = [regex]::new($pat, [Text.RegularExpressions.RegexOptions]::IgnoreCase)
-
-            $hit = Find-RegexCell -Ws $Ws -Rx $rx -MaxRows $MaxRows -MaxCols $MaxCols
-            if (-not $hit) { return $null }
-
-            $cMax = [Math]::Min($Ws.Dimension.End.Column, $MaxCols)
-            for ($c = $hit.Col + 1; $c -le $cMax; $c++) {
-                $t = Normalize-HeaderText ($Ws.Cells[$hit.Row,$c].Text + '')
-                if ($t) { return $t }
-            }
-            return $null
-        }
-    }
-
-    if ($selLsp -and (Test-Path -LiteralPath $selLsp)) {
-        Gui-Log ("üîé WS hittad: " + (Split-Path $selLsp -Leaf)) 'Info'
-    } else {
-        Gui-Log "‚ÑπÔ∏è Ingen WS-fil vald/hittad (LSP Worksheet). Hoppar √∂ver WS-extraktion." 'Info'
-    }
-} catch {
-    Gui-Log ("‚ö†Ô∏è WS-block fel: " + $_.Exception.Message) 'Warn'
-}
-
-try {
-    # ‚úÖ Se till att dessa alltid finns (de anv√§nds senare)
-    $headerWs  = $null
-    $headerNeg = $null
-    $headerPos = $null
-    # OBS: $eqInfo anv√§nds senare vid Equipment-blad ‚Üí init h√§r
-    if (-not (Get-Variable -Name eqInfo -Scope 1 -ErrorAction SilentlyContinue)) {
-        $eqInfo = $null
-    }
-
-    # --- WS √∂ppnas EN g√•ng och dispose:as alltid ---
-    $tmpPkg = $null
-    try {
-        if ($selLsp -and (Test-Path -LiteralPath $selLsp)) {
-            try {
-                $tmpPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selLsp))
-
-                # ==============================
-                # ==============================
-                # Equipment / TestSummary
-                # ==============================
-                try {
-                    # NOTE (2026-02): "EquipmentSheet" ska endast generera sj√§lva BLADET/mallen.
-                    # Det ska *inte* automatiskt h√§mta pipetter/instrument fr√•n Test Summary/CSV h√§r,
-                    # annars blir det en blandning (auto + manuellt) som f√∂rvirrar anv√§ndaren.
-                    if ($Config -and $Config.Contains('EnableEquipmentSheet') -and -not $Config.EnableEquipmentSheet) {
-                        $eqInfo = $null
-                        Gui-Log '‚ÑπÔ∏è Equipment-blad avst√§ngt. Hoppar √∂ver utrustning.' 'Info'
-                    } else {
-                        $eqInfo = $null
-                        Gui-Log '‚ÑπÔ∏è Equipment-blad: mall√§ge (ingen h√§mtning av pipetter/instrument).' 'Info'
-                    }
-                } catch {
-                    # Utrustning ska aldrig f√• stoppa rapporten
-                    try { Gui-Log ("‚ö†Ô∏è Equipment-blad: kunde inte initiera mall√§ge: " + $_.Exception.Message) 'Warn' } catch {}
-                    $eqInfo = $null
-                }
-
-                # Worksheet header (Extract + Compare)
-                # ==============================
-                try {
-                    $headerWs = Extract-WorksheetHeader -Pkg $tmpPkg
-                } catch {
-                    $headerWs = $null
-                }
-
-                # ‚úÖ Fallback om Extract gav null: skapa tomt objekt s√• .PartNo osv aldrig kraschar
-                if (-not $headerWs) {
-                    $headerWs = [pscustomobject]@{
-                        WorksheetName   = ''
-                        PartNo          = ''
-                        BatchNo         = ''
-                        CartridgeNo     = ''
-                        DocumentNumber  = ''
-                        Rev             = ''
-                        Effective       = ''
-                        Attachment      = ''
-                    }
-                }
-
-                try {
-                    $wsHeaderRows  = Get-WorksheetHeaderPerSheet -Pkg $tmpPkg
-                    $wsHeaderCheck = Compare-WorksheetHeaderSet   -Rows $wsHeaderRows
-                    try {
-                        if ($wsHeaderCheck.Issues -gt 0 -and $wsHeaderCheck.Summary) {
-                            Gui-Log ("Worksheet header-avvikelser: {0} ‚Äì se Information!" -f $wsHeaderCheck.Summary) 'Warn'
-                        } else {
-                            Gui-Log "‚úÖ Worksheet header korrekt" 'Info'
-                        }
-                    } catch {}
-                } catch {
-                    # Beh√•ll tyst/robust; wsHeaderCheck anv√§nds senare om den finns
-                }
-
-                # ==============================
-                # F√∂rst√§rk headerWs via labels (om Extract missade)
-                # ==============================
-                try {
-                    $wsLsp = $tmpPkg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
-                    if ($wsLsp) {
-
-                        if (-not $headerWs.PartNo) {
-                            $val = $null
-                            $labels = @('Part No.','Part No.:','Part No','Part Number','Part Number:','Part Number.','Part Number.:')
-                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
-                            if ($val) { $headerWs.PartNo = $val }
-                        }
-
-                        if (-not $headerWs.BatchNo) {
-                            $val = $null
-                            $labels = @(
-                                'Batch No(s)','Batch No(s).','Batch No(s):','Batch No(s).:',
-                                'Batch No','Batch No.','Batch No:','Batch No.:',
-                                'Batch Number','Batch Number.','Batch Number:','Batch Number.:'
-                            )
-                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
-                            if ($val) { $headerWs.BatchNo = $val }
-                        }
-
-                        if (-not $headerWs.CartridgeNo -or $headerWs.CartridgeNo -eq '.') {
-                            $val = $null
-                            $labels = @(
-                                'Cartridge No. (LSP)','Cartridge No. (LSP):','Cartridge No. (LSP) :',
-                                'Cartridge No (LSP)','Cartridge No (LSP):','Cartridge No (LSP) :',
-                                'Cartridge Number (LSP)','Cartridge Number (LSP):','Cartridge Number (LSP) :',
-                                'Cartridge No.','Cartridge No.:','Cartridge No. :','Cartridge No :',
-                                'Cartridge Number','Cartridge Number:','Cartridge Number :',
-                                'Cartridge No','Cartridge No:','Cartridge No :'
-                            )
-                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
-
-                            if (-not $val) {
-                                $rxCart = [regex]::new('(?i)Cartridge.*\(LSP\)')
-                                $maxCols = [Math]::Min($wsLsp.Dimension.End.Column, 100)
-                                $hitCart = Find-RegexCell -Ws $wsLsp -Rx $rxCart -MaxRows 200 -MaxCols $maxCols
-                                if ($hitCart) {
-                                    for ($c = $hitCart.Col + 1; $c -le $wsLsp.Dimension.End.Column; $c++) {
-                                        $cellVal = ($wsLsp.Cells[$hitCart.Row, $c].Text + '').Trim()
-                                        if ($cellVal) { $val = $cellVal; break }
-                                    }
-                                }
-                            }
-
-                            if ($val) { $headerWs.CartridgeNo = $val }
-                        }
-
-                        if (-not $headerWs.Effective) {
-                            $val = Find-LabelValueRightward -Ws $wsLsp -Label 'Effective'
-                            if (-not $val) { $val = Find-LabelValueRightward -Ws $wsLsp -Label 'Effective Date' }
-                            if ($val) { $headerWs.Effective = $val }
-                        }
-                    }
-                } catch {}
-
-                # Filename fallback f√∂r CartridgeNo om fortfarande tomt
-                try {
-                    if ($selLsp -and (-not $headerWs.CartridgeNo -or $headerWs.CartridgeNo -eq '.' -or $headerWs.CartridgeNo -eq '')) {
-                        $fn = Split-Path $selLsp -Leaf
-                        $m = [regex]::Matches($fn, '(?<!\d)(\d{5,7})(?!\d)')
-                        if ($m.Count -gt 0) { $headerWs.CartridgeNo = $m[0].Groups[1].Value }
-                    }
-                } catch {}
-
-            } catch {
-                # Om WS √∂ppnas men n√•got inne fallerar: l√•t det inte d√∂da hela rapporten
-                Gui-Log ("‚ö†Ô∏è WS-parse fel: " + $_.Exception.Message) 'Warn'
-            }
-        }
-    } finally {
-        if ($tmpPkg) { try { $tmpPkg.Dispose() } catch {} }
-    }
-
-    # SealTest headers (beh√•ll som du hade)
-    try { $headerNeg = Extract-SealTestHeader -Pkg $pkgNeg } catch {}
-    try { $headerPos = Extract-SealTestHeader -Pkg $pkgPos } catch {}
-
-    # Effective fallback f√∂r Seal POS/NEG om saknas (din logik, of√∂r√§ndrad)
-    try {
-        if ($pkgPos -and $headerPos -and -not $headerPos.Effective) {
-            $wsPos = $pkgPos.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
-            if ($wsPos) {
-                $val = Find-LabelValueRightward -Ws $wsPos -Label 'Effective'
-                if (-not $val) { $val = Find-LabelValueRightward -Ws $wsPos -Label 'Effective Date' }
-                if ($val) { $headerPos.Effective = $val }
-            }
-        }
-    } catch {}
-
-    try {
-        if ($pkgNeg -and $headerNeg -and -not $headerNeg.Effective) {
-            $wsNeg = $pkgNeg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
-            if ($wsNeg) {
-                $val = Find-LabelValueRightward -Ws $wsNeg -Label 'Effective'
-                if (-not $val) { $val = Find-LabelValueRightward -Ws $wsNeg -Label 'Effective Date' }
-                if ($val) { $headerNeg.Effective = $val }
-            }
-        }
-    } catch {}
-
-    # --------------------------
-    # Header summary ‚Üí Information
-    # --------------------------
-    try {
-        $wsBatch   = if ($headerWs -and $headerWs.BatchNo) { $headerWs.BatchNo } else { $null }
-        $sealBatch = $batch
-        if (-not $sealBatch) {
-            try { if ($selPos) { $sealBatch = Get-BatchNumberFromSealFile $selPos } } catch {}
-            if (-not $sealBatch) { try { if ($selNeg) { $sealBatch = Get-BatchNumberFromSealFile $selNeg } } catch {} }
-        }
-
-        $rowWsFile = Find-InfoRow -Ws $wsInfo -Label 'Worksheet'
-        if (-not $rowWsFile) { $rowWsFile = 17 }
-        $rowPart  = $rowWsFile + 1
-        $rowBatch = $rowWsFile + 2
-        $rowCart  = $rowWsFile + 3
-        $rowDoc   = $rowWsFile + 4
-        $rowRev   = $rowWsFile + 5
-        $rowEff   = $rowWsFile + 6
-
-        $rowPosFile = Find-InfoRow -Ws $wsInfo -Label 'Seal Test POS'
-        if (-not $rowPosFile) { $rowPosFile = $rowWsFile + 7 }
-        $rowPosDoc = $rowPosFile + 1
-        $rowPosRev = $rowPosFile + 2
-        $rowPosEff = $rowPosFile + 3
-
-        $rowNegFile = Find-InfoRow -Ws $wsInfo -Label 'Seal Test NEG'
-        if (-not $rowNegFile) { $rowNegFile = $rowPosFile + 4 }
-        $rowNegDoc = $rowNegFile + 1
-        $rowNegRev = $rowNegFile + 2
-        $rowNegEff = $rowNegFile + 3
-
-        if ($selLsp) {
-            $wsInfo.Cells["B$rowWsFile"].Style.Numberformat.Format = '@'
-            $wsInfo.Cells["B$rowWsFile"].Value = (Split-Path $selLsp -Leaf)
-        } else {
-            $wsInfo.Cells["B$rowWsFile"].Value = ''
-        }
-
-        $consPart  = Get-ConsensusValue -Type 'Part'      -Ws $headerWs.PartNo      -Pos $headerPos.PartNumber   -Neg $headerNeg.PartNumber
-        $consBatch = Get-ConsensusValue -Type 'Batch'     -Ws $headerWs.BatchNo     -Pos $headerPos.BatchNumber  -Neg $headerNeg.BatchNumber
-        $consCart  = Get-ConsensusValue -Type 'Cartridge' -Ws $headerWs.CartridgeNo -Pos $headerPos.CartridgeNo  -Neg $headerNeg.CartridgeNo
-
-        if (-not $consCart.Value -and $selLsp) {
-            $fnCart = Split-Path $selLsp -Leaf
-            $mCart  = [regex]::Match($fnCart,'(?<!\d)(\d{5,7})(?!\d)')
-            if ($mCart.Success) {
-                $consCart = @{ Value=$mCart.Groups[1].Value; Source='FILENAME'; Note='Filename fallback' }
-            }
-        }
-
-        $wsInfo.Cells["B$rowPart"].Value  = if ($consPart.Value)  { $consPart.Value }  else { '' }
-        $wsInfo.Cells["B$rowBatch"].Value = if ($consBatch.Value) { $consBatch.Value } else { '' }
-        $wsInfo.Cells["B$rowCart"].Value  = if ($consCart.Value)  { $consCart.Value }  else { '' }
-
-        # wsHeaderCheck ‚Üí skriv Match/Mismatch i C-kolumn f√∂r Part/Batch/Cartridge
-        try {
-            # Helper f√∂r att styla mismatch-cell med r√∂d bakgrund
-            $StyleMismatchCell = {
-                param($Cell, $Text)
-                $Cell.Style.Numberformat.Format = '@'
-                $Cell.Value = '‚ö† ' + $Text
-                $Cell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
-                $Cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#FFCCCC'))
-                $Cell.Style.Font.Bold = $true
-                $Cell.Style.Font.Color.SetColor([System.Drawing.Color]::DarkRed)
-            }
-
-            # Helper f√∂r att styla match-cell med gr√∂n bakgrund
-            $StyleMatchCell = {
-                param($Cell)
-                $Cell.Style.Numberformat.Format = '@'
-                $Cell.Value = '‚úì Alla flikar matchar'
-                $Cell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
-                $Cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#C6EFCE'))
-                $Cell.Style.Font.Bold = $true
-                $Cell.Style.Font.Color.SetColor([System.Drawing.ColorTranslator]::FromHtml('#006100'))
-            }
-
-            $devPart = $null; $devBatch = $null; $devCart = $null
-
-            # Parsa eventuella avvikelser fr√•n wsHeaderCheck
-            if ($wsHeaderCheck -and $wsHeaderCheck.Details) {
-                $linesDev = ($wsHeaderCheck.Details -split "`r?`n")
-                foreach ($ln in $linesDev) {
-                    if ($ln -match '^-\s*PartNo[^:]*:\s*(.+)$')      { $devPart  = $matches[1].Trim() }
-                    elseif ($ln -match '^-\s*BatchNo[^:]*:\s*(.+)$') { $devBatch = $matches[1].Trim() }
-                    elseif ($ln -match '^-\s*CartridgeNo[^:]*:\s*(.+)$') { $devCart = $matches[1].Trim() }
-                }
-            }
-
-            # Visa Match eller Mismatch f√∂r varje f√§lt (endast om wsHeaderCheck k√∂rdes)
-            if ($wsHeaderCheck) {
-                if ($devPart)  { & $StyleMismatchCell $wsInfo.Cells["C$rowPart"]  ('Avvikande: ' + $devPart) }
-                else           { & $StyleMatchCell $wsInfo.Cells["C$rowPart"] }
-                
-                if ($devBatch) { & $StyleMismatchCell $wsInfo.Cells["C$rowBatch"] ('Avvikande: ' + $devBatch) }
-                else           { & $StyleMatchCell $wsInfo.Cells["C$rowBatch"] }
-                
-                if ($devCart)  { & $StyleMismatchCell $wsInfo.Cells["C$rowCart"]  ('Avvikande: ' + $devCart) }
-                else           { & $StyleMatchCell $wsInfo.Cells["C$rowCart"] }
-            }
-        } catch {}
-
-        # WS metadata + Match-kontroll
-        if ($headerWs) {
-            $doc = $headerWs.DocumentNumber
-            if ($doc) { $doc = ($doc -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$', '').Trim() }
-            if ($headerWs.Attachment -and ($doc -notmatch '(?i)\bAttachment\s+\w+\b')) {
-                $doc = "$doc Attachment $($headerWs.Attachment)"
-            }
-            $wsInfo.Cells["B$rowDoc"].Value = $doc
-            $wsInfo.Cells["B$rowRev"].Value = $headerWs.Rev
-            $wsInfo.Cells["B$rowEff"].Value = $headerWs.Effective
-            
-            # Visa "‚úì Alla flikar matchar" f√∂r WS-f√§lt (om wsHeaderCheck k√∂rdes och f√§lten finns)
-            if ($wsHeaderCheck -and $doc) { & $StyleMatchCell $wsInfo.Cells["C$rowDoc"] }
-            if ($wsHeaderCheck -and $headerWs.Rev) { & $StyleMatchCell $wsInfo.Cells["C$rowRev"] }
-            if ($wsHeaderCheck -and $headerWs.Effective) { & $StyleMatchCell $wsInfo.Cells["C$rowEff"] }
-        } else {
-            $wsInfo.Cells["B$rowDoc"].Value = ''
-            $wsInfo.Cells["B$rowRev"].Value = ''
-            $wsInfo.Cells["B$rowEff"].Value = ''
-        }
-
-        # POS file + metadata + Match-kontroll
-        if ($selPos) {
-            $wsInfo.Cells["B$rowPosFile"].Style.Numberformat.Format = '@'
-            $wsInfo.Cells["B$rowPosFile"].Value = (Split-Path $selPos -Leaf)
-        } else { $wsInfo.Cells["B$rowPosFile"].Value = '' }
-
-        if ($headerPos) {
-            $docPos = $headerPos.DocumentNumber
-            if ($docPos) { $docPos = ($docPos -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$','').Trim() }
-            $wsInfo.Cells["B$rowPosDoc"].Value = $docPos
-            $wsInfo.Cells["B$rowPosRev"].Value = $headerPos.Rev
-            $wsInfo.Cells["B$rowPosEff"].Value = $headerPos.Effective
-            
-            # Visa "‚úì Alla flikar matchar" f√∂r POS-f√§lt (alla flikar i POS-filen har samma v√§rde)
-            if ($docPos) { & $StyleMatchCell $wsInfo.Cells["C$rowPosDoc"] }
-            if ($headerPos.Rev) { & $StyleMatchCell $wsInfo.Cells["C$rowPosRev"] }
-            if ($headerPos.Effective) { & $StyleMatchCell $wsInfo.Cells["C$rowPosEff"] }
-        } else {
-            $wsInfo.Cells["B$rowPosDoc"].Value = ''
-            $wsInfo.Cells["B$rowPosRev"].Value = ''
-            $wsInfo.Cells["B$rowPosEff"].Value = ''
-        }
-
-        # NEG file + metadata + Match-kontroll
-        if ($selNeg) {
-            $wsInfo.Cells["B$rowNegFile"].Style.Numberformat.Format = '@'
-            $wsInfo.Cells["B$rowNegFile"].Value = (Split-Path $selNeg -Leaf)
-        } else { $wsInfo.Cells["B$rowNegFile"].Value = '' }
-
-        if ($headerNeg) {
-            $docNeg = $headerNeg.DocumentNumber
-            if ($docNeg) { $docNeg = ($docNeg -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$','').Trim() }
-            $wsInfo.Cells["B$rowNegDoc"].Value = $docNeg
-            $wsInfo.Cells["B$rowNegRev"].Value = $headerNeg.Rev
-            $wsInfo.Cells["B$rowNegEff"].Value = $headerNeg.Effective
-            
-            # Visa "‚úì Alla flikar matchar" f√∂r NEG-f√§lt (alla flikar i NEG-filen har samma v√§rde)
-            if ($docNeg) { & $StyleMatchCell $wsInfo.Cells["C$rowNegDoc"] }
-            if ($headerNeg.Rev) { & $StyleMatchCell $wsInfo.Cells["C$rowNegRev"] }
-            if ($headerNeg.Effective) { & $StyleMatchCell $wsInfo.Cells["C$rowNegEff"] }
-        } else {
-            $wsInfo.Cells["B$rowNegDoc"].Value = ''
-            $wsInfo.Cells["B$rowNegRev"].Value = ''
-            $wsInfo.Cells["B$rowNegEff"].Value = ''
-        }
-
-    } catch {
-        Gui-Log ("‚ö†Ô∏è Header summary fel: " + $_.Exception.Message) 'Warn'
-    }
-
-} catch {
-    Gui-Log "‚ö†Ô∏è Information-blad fel: $($_.Exception.Message)" 'Warn'
-}
-
-# ============================
-# === SharePoint / Equipment / Control / Watermark / Tabs / Save & Audit
-# ============================
-
-# ============================
-# === Equipment-blad       ===
-# ============================
-# OBS: Endast mall kopieras - ingen automatisk ifyllning av pipetter/instrument.
-# Anv√§ndaren fyller i manuellt i output-filen.
-if ($Config -and $Config.Contains('EnableEquipmentSheet') -and -not $Config.EnableEquipmentSheet) {
-    Gui-Log '‚ÑπÔ∏è Equipment-blad avst√§ngt. Hoppar √∂ver Infinity/GX.' 'Info'
-} else {
-    try {
-        if (Test-Path -LiteralPath $UtrustningListPath) {
-            $srcPkg = $null
-            try {
-                $srcPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($UtrustningListPath))
-
-                $srcWs = $srcPkg.Workbook.Worksheets['Sheet1']
-                if (-not $srcWs) { $srcWs = $srcPkg.Workbook.Worksheets[1] }
-
-                if ($srcWs) {
-                    # Ta bort befintlig flik om den finns
-                    $wsEq = $pkgOut.Workbook.Worksheets['Infinity/GX']
-                    if ($wsEq) { $pkgOut.Workbook.Worksheets.Delete($wsEq) }
-
-                    # Kopiera mallen som en ny flik
-                    $wsEq = $pkgOut.Workbook.Worksheets.Add('Infinity/GX', $srcWs)
-
-                    # Ta bort formler och beh√•ll bara v√§rden
-                    if ($wsEq.Dimension) {
-                        foreach ($cell in $wsEq.Cells[$wsEq.Dimension.Address]) {
-                            if ($cell.Formula -or $cell.FormulaR1C1) {
-                                $val = $cell.Value
-                                $cell.Formula     = $null
-                                $cell.FormulaR1C1 = $null
-                                $cell.Value       = $val
-                            }
-                        }
-                        # Kopiera kolumnbredder
-                        $colCount = $srcWs.Dimension.End.Column
-                        for ($c = 1; $c -le $colCount; $c++) {
-                            try { $wsEq.Column($c).Width = $srcWs.Column($c).Width } catch {}
-                        }
-                    }
-                    Gui-Log "‚úÖ Infinity/GX-mall kopierad (fyll i manuellt)." 'Info'
-                }
-            } finally {
-                if ($srcPkg) { try { $srcPkg.Dispose() } catch {} }
-            }
-        } else {
-            Gui-Log ("‚ÑπÔ∏è Infinity/GX mall saknas: $UtrustningListPath") 'Info'
-        }
-    } catch {
-        Gui-Log "‚ö†Ô∏è Kunde inte skapa 'Infinity/GX'-flik: $($_.Exception.Message)" 'Warn'
-    }
-}
-
-# === Control Material     ===
-# ============================
-try {
-    if ($controlTab -and (Test-Path -LiteralPath $RawDataPath)) {
-        $srcPkg = $null
-        try {
-            $srcPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($RawDataPath))
-            try { $srcPkg.Workbook.Calculate() } catch {}
-
-            $candidates = if ($controlTab -match '\|') {
-                $controlTab -split '\|' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
-            } else { @($controlTab) }
-
-            $srcWs = $null
-            foreach ($cand in $candidates) {
-                $srcWs = $srcPkg.Workbook.Worksheets | Where-Object { $_.Name -eq $cand } | Select-Object -First 1
-                if ($srcWs) { break }
-                $srcWs = $srcPkg.Workbook.Worksheets | Where-Object { $_.Name -like "*$cand*" } | Select-Object -First 1
-                if ($srcWs) { break }
-            }
-
-            if ($srcWs) {
-                $safeName = if ($srcWs.Name.Length -gt 31) { $srcWs.Name.Substring(0,31) } else { $srcWs.Name }
-                $destName = $safeName; $n = 1
-                while ($pkgOut.Workbook.Worksheets[$destName]) {
-                    $base = if ($safeName.Length -gt 27) { $safeName.Substring(0,27) } else { $safeName }
-                    $destName = "$base($n)"; $n++
-                }
-
-                $wsCM = $pkgOut.Workbook.Worksheets.Add($destName, $srcWs)
-                if ($wsCM.Dimension) {
-                    foreach ($cell in $wsCM.Cells[$wsCM.Dimension.Address]) {
-                        if ($cell.Formula -or $cell.FormulaR1C1) {
-                            $v = $cell.Value
-                            $cell.Formula = $null
-                            $cell.FormulaR1C1 = $null
-                            $cell.Value = $v
-                        }
-                    }
-                    try {
-                        if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                            Safe-AutoFitColumns -Ws $wsCM -Context 'ControlMaterial'
-                        } else {
-                            $wsCM.Cells[$wsCM.Dimension.Address].AutoFitColumns() | Out-Null
-                        }
-                    } catch {}
-                }
-
-                Gui-Log "‚úÖ Control Material kopierad: '$($srcWs.Name)' ‚Üí '$destName'" 'Info'
-            } else {
-                Gui-Log "‚ÑπÔ∏è Hittade inget blad i kontrollfilen som matchar '$controlTab'." 'Info'
-            }
-        } finally {
-            if ($srcPkg) { try { $srcPkg.Dispose() } catch {} }
-        }
-    } else {
-        Gui-Log "‚ÑπÔ∏è Ingen Control-flik skapad (saknar mappning eller kontrollfil)." 'Info'
-    }
-} catch {
-    Gui-Log "‚ö†Ô∏è Control Material-fel: $($_.Exception.Message)" 'Warn'
-}
-
-# ============================
-# === SharePoint Info      ===
-# ============================
-try {
-    $skipSpInfo = -not $global:SpEnabled  # Always include SharePoint Info unless disabled in config
-
-    if ($skipSpInfo) {
-        Gui-Log "‚ÑπÔ∏è SharePoint Info avst√§ngt i konfigurationen ‚Äì hoppar √∂ver." 'Info'
-        try {
-            $old = $pkgOut.Workbook.Worksheets["SharePoint Info"]
-            if ($old) { $pkgOut.Workbook.Worksheets.Delete($old) }
-        } catch {}
-    } else {
-
-        $spOk = $false
-        if ($global:SpConnected) { $spOk = $true }
-        elseif (Get-Command Get-PnPConnection -ErrorAction SilentlyContinue) {
-            try { $null = Get-PnPConnection; $spOk = $true } catch { $spOk = $false }
-        }
-
-        if (-not $spOk) {
-            $errMsg = if ($global:SpError) { $global:SpError } else { 'Ok√§nt fel' }
-            Gui-Log ("‚ö†Ô∏è SharePoint ej tillg√§ngligt: $errMsg") 'Warn'
-        }
-
-        $batchInfo = Get-BatchLinkInfo -SealPosPath $selPos -SealNegPath $selNeg -Lsp $lspForLinks
-        $batch = $batchInfo.Batch
-
-        if (-not $batch) {
-            Gui-Log "‚ÑπÔ∏è Inget Batch # i POS/NEG ‚Äì skriver tom SharePoint Info." 'Info'
-            if (Get-Command Write-SPSheet-Safe -ErrorAction SilentlyContinue) {
-                [void](Write-SPSheet-Safe -Pkg $pkgOut -Rows @() -DesiredOrder @() -Batch '‚Äî')
-            } else {
-                # Harmoniserade f√§rger (matchar CSV Sammanfattning)
-                $HeaderBg   = [System.Drawing.Color]::FromArgb(68, 84, 106)
-                $HeaderFg   = [System.Drawing.Color]::White
-                $SectionBg  = [System.Drawing.Color]::FromArgb(217, 225, 242)
-                $SectionFg  = [System.Drawing.Color]::FromArgb(0, 32, 96)
-                $BorderColor = [System.Drawing.Color]::FromArgb(68, 84, 106)
-
-                $wsSp = $pkgOut.Workbook.Worksheets["SharePoint Info"]; if ($wsSp) { $pkgOut.Workbook.Worksheets.Delete($wsSp) }
-                $wsSp = $pkgOut.Workbook.Worksheets.Add("SharePoint Info")
-                
-                # Huvudrubrik
-                $wsSp.Cells[1,1].Value = "SharePoint Info"
-                $wsSp.Cells["A1:B1"].Merge = $true
-                $wsSp.Cells["A1"].Style.Font.Bold = $true
-                $wsSp.Cells["A1"].Style.Font.Size = 14
-                $wsSp.Cells["A1"].Style.Font.Name = "Arial"
-                $wsSp.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
-                $wsSp.Cells["A1"].Style.Fill.PatternType = "Solid"
-                $wsSp.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
-                $wsSp.Row(1).Height = 22
-
-                # Data
-                $wsSp.Cells[2,1].Value = "Batch";  $wsSp.Cells[2,2].Value = "‚Äî"
-                
-                # Styling
-                $wsSp.Cells["A2"].Style.Font.Bold = $true
-                $wsSp.Cells["A2"].Style.Font.Name = "Arial"
-                $wsSp.Cells["A2"].Style.Font.Color.SetColor($SectionFg)
-                $wsSp.Cells["A2"].Style.Fill.PatternType = "Solid"
-                $wsSp.Cells["A2"].Style.Fill.BackgroundColor.SetColor($SectionBg)
-                $wsSp.Cells["B2"].Style.Font.Name = "Arial"
-                $wsSp.Cells["B2"].Style.Fill.PatternType = "Solid"
-                $wsSp.Cells["B2"].Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::White)
-
-                $wsSp.Column(1).Width = 30
-                $wsSp.Column(2).Width = 40
-                try {
-                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                        Safe-AutoFitColumns -Ws $wsSp -Context 'SharePointInfo'
-                    } else {
-                        $wsSp.Cells[$wsSp.Dimension.Address].AutoFitColumns() | Out-Null
-                    }
-                } catch {}
-            }
-        } else {
-            Gui-Log "üîé Batch hittad: $batch" 'Info'
-
-            $fields = @(
-                'Work_x0020_Center','Title','Batch_x0023_','SAP_x0020_Batch_x0023__x0020_2',
-                'LSP','Material','BBD_x002f_SLED','Actual_x0020_startdate_x002f__x0',
-                'PAL_x0020__x002d__x0020_Sample_x','Sample_x0020_Reagent_x0020_P_x00',
-                'Order_x0020_quantity','Total_x0020_good','ITP_x0020_Test_x0020_results',
-                'IPT_x0020__x002d__x0020_Testing_0','MES_x0020__x002d__x0020_Order_x0'
-            )
-            $renameMap = @{
-                'Work Center'            = 'Work Center'
-                'Title'                  = 'Order#'
-                'Batch#'                 = 'SAP Batch#'
-                'SAP Batch# 2'           = 'SAP Batch# 2'
-                'LSP'                    = 'LSP'
-                'Material'               = 'Material'
-                'BBD/SLED'               = 'BBD/SLED'
-                'Actual startdate/_x0'   = 'ROBAL - Actual start date/time'
-                'PAL - Sample_x'         = 'Sample Reagent use'
-                'Sample Reagent P'       = 'Sample Reagent P/N'
-                'Order quantity'         = 'Order quantity'
-                'Total good'             = 'ROBAL - Till Packning'
-                'IPT Test results'       = 'IPT Test results'
-                'IPT - Testing_0'        = 'IPT - Testing Finalized'
-                'MES - Order_x0'         = 'MES Order'
-            }
-
-            $desiredOrder = @(
-                'Work Center','Order#','SAP Batch#','SAP Batch# 2','LSP','Material','BBD/SLED',
-                'ROBAL - Actual start date/time','Sample Reagent use','Sample Reagent P/N',
-                'Order quantity','ROBAL - Till Packning','IPT Test results',
-                'IPT - Testing Finalized','MES Order'
-            )
-
-            $dateFields      = @('BBD/SLED','ROBAL - Actual start date/time','IPT - Testing Finalized')
-            $shortDateFields = @('BBD/SLED')
-
-            $rows = @()
-            if ($spOk) {
-                try {
-                    $items = Get-PnPListItem -List "Cepheid | Production orders" -Fields $fields -PageSize 2000 -ErrorAction Stop
-                    $match = $items | Where-Object {
-                        $v1 = $_['Batch_x0023_']; $v2 = $_['SAP_x0020_Batch_x0023__x0020_2']
-                        $s1 = if ($null -ne $v1) { ([string]$v1).Trim() } else { '' }
-                        $s2 = if ($null -ne $v2) { ([string]$v2).Trim() } else { '' }
-                        $s1 -eq $batch -or $s2 -eq $batch
-                    } | Select-Object -First 1
-
-                    if ($match) {
-                        foreach ($f in $fields) {
-                            $val = $match[$f]
-                            $label = $f -replace '_x0020_', ' ' `
-                                         -replace '_x002d_', '-' `
-                                         -replace '_x0023_', '#' `
-                                         -replace '_x002f_', '/' `
-                                         -replace '_x2013_', '‚Äì' `
-                                         -replace '_x00',''
-                            $label = $label.Trim()
-                            if ($renameMap.ContainsKey($label)) { $label = $renameMap[$label] }
-
-                            if ($null -ne $val -and $val -ne '') {
-                                if ($val -eq $true) { $val = 'JA' }
-                                elseif ($val -eq $false) { $val = 'NEJ' }
-
-                                $dt = $null
-                                if ($val -is [datetime]) { $dt = [datetime]$val }
-                                else { try { $dt = [datetime]::Parse($val) } catch { $dt = $null } }
-
-                                if ($dt -ne $null -and ($dateFields -contains $label)) {
-                                    $fmt = if ($shortDateFields -contains $label) { 'yyyy-MM-dd' } else { 'yyyy-MM-dd HH:mm' }
-                                    $val = $dt.ToString($fmt)
-                                }
-
-                                $rows += [pscustomobject]@{ Rubrik = $label; 'V√§rde' = $val }
-                            }
-                        }
-
-                        if ($rows.Count -gt 0) {
-                            $ordered = @()
-                            foreach ($label in $desiredOrder) {
-                                $hit = $rows | Where-Object { $_.Rubrik -eq $label } | Select-Object -First 1
-                                if ($hit) { $ordered += $hit }
-                            }
-                            if ($ordered.Count -gt 0) { $rows = $ordered }
-                        }
-
-                        Gui-Log "üìÑ SharePoint-post hittad ‚Äì skriver blad." 'Info'
-                    } else {
-                        Gui-Log "‚ÑπÔ∏è Ingen post i SharePoint f√∂r Batch=$batch." 'Info'
-                    }
-                } catch {
-                    Gui-Log "‚ö†Ô∏è SP: Get-PnPListItem misslyckades: $($_.Exception.Message)" 'Warn'
-                }
-            }
-
-            if (Get-Command Write-SPSheet-Safe -ErrorAction SilentlyContinue) {
-                [void](Write-SPSheet-Safe -Pkg $pkgOut -Rows $rows -DesiredOrder $desiredOrder -Batch $batch)
-            } else {
-                # Harmoniserade f√§rger (matchar CSV Sammanfattning)
-                $HeaderBg   = [System.Drawing.Color]::FromArgb(68, 84, 106)
-                $HeaderFg   = [System.Drawing.Color]::White
-                $SectionBg  = [System.Drawing.Color]::FromArgb(217, 225, 242)
-                $SectionFg  = [System.Drawing.Color]::FromArgb(0, 32, 96)
-                $BorderColor = [System.Drawing.Color]::FromArgb(68, 84, 106)
-
-                $wsSp = $pkgOut.Workbook.Worksheets["SharePoint Info"]; if ($wsSp) { $pkgOut.Workbook.Worksheets.Delete($wsSp) }
-                $wsSp = $pkgOut.Workbook.Worksheets.Add("SharePoint Info")
-                
-                # Huvudrubrik
-                $wsSp.Cells[1,1].Value = "SharePoint Info"
-                $wsSp.Cells["A1:B1"].Merge = $true
-                $wsSp.Cells["A1"].Style.Font.Bold = $true
-                $wsSp.Cells["A1"].Style.Font.Size = 14
-                $wsSp.Cells["A1"].Style.Font.Name = "Arial"
-                $wsSp.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
-                $wsSp.Cells["A1"].Style.Fill.PatternType = "Solid"
-                $wsSp.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
-                $wsSp.Row(1).Height = 22
-
-                if ($rows.Count -gt 0) {
-                    $r = 2
-                    foreach($rowObj in $rows) {
-                        $wsSp.Cells[$r,1].Value = $rowObj.Rubrik
-                        $wsSp.Cells[$r,2].Value = $rowObj.'V√§rde'
-                        $r++
-                    }
-                    $lastRow = $r - 1
-
-                    # Styling f√∂r rubrik-kolumnen
-                    $labelRange = $wsSp.Cells["A2:A$lastRow"]
-                    $labelRange.Style.Font.Bold = $true
-                    $labelRange.Style.Font.Name = "Arial"
-                    $labelRange.Style.Font.Size = 10
-                    $labelRange.Style.Font.Color.SetColor($SectionFg)
-                    $labelRange.Style.Fill.PatternType = "Solid"
-                    $labelRange.Style.Fill.BackgroundColor.SetColor($SectionBg)
-
-                    # Styling f√∂r v√§rde-kolumnen
-                    $valueRange = $wsSp.Cells["B2:B$lastRow"]
-                    $valueRange.Style.Font.Name = "Arial"
-                    $valueRange.Style.Font.Size = 10
-                    $valueRange.Style.Fill.PatternType = "Solid"
-                    $valueRange.Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::White)
-
-                    # Borders
-                    $rng = $wsSp.Cells["A1:B$lastRow"]
-                    $rng.Style.Border.Top.Style    = "Thin"
-                    $rng.Style.Border.Bottom.Style = "Thin"
-                    $rng.Style.Border.Left.Style   = "Thin"
-                    $rng.Style.Border.Right.Style  = "Thin"
-                    $rng.Style.Border.Top.Color.SetColor($BorderColor)
-                    $rng.Style.Border.Bottom.Color.SetColor($BorderColor)
-                    $rng.Style.Border.Left.Color.SetColor($BorderColor)
-                    $rng.Style.Border.Right.Color.SetColor($BorderColor)
-                    $rng.Style.Border.BorderAround([OfficeOpenXml.Style.ExcelBorderStyle]::Medium, $BorderColor)
-                } else {
-                    $wsSp.Cells[2,1].Value = "Batch";  $wsSp.Cells[2,2].Value = $batch
-                    $wsSp.Cells[3,1].Value = "Info";   $wsSp.Cells[3,2].Value = "Ingen SharePoint-post hittades"
-                    
-                    # Styling
-                    $wsSp.Cells["A2:A3"].Style.Font.Bold = $true
-                    $wsSp.Cells["A2:A3"].Style.Font.Name = "Arial"
-                    $wsSp.Cells["A2:A3"].Style.Font.Color.SetColor($SectionFg)
-                    $wsSp.Cells["A2:A3"].Style.Fill.PatternType = "Solid"
-                    $wsSp.Cells["A2:A3"].Style.Fill.BackgroundColor.SetColor($SectionBg)
-                    $wsSp.Cells["B2:B3"].Style.Font.Name = "Arial"
-                    $wsSp.Cells["B2:B3"].Style.Fill.PatternType = "Solid"
-                    $wsSp.Cells["B2:B3"].Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::White)
-                }
-
-                $wsSp.Column(1).Width = 30
-                $wsSp.Column(2).Width = 40
-                try {
-                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
-                        Safe-AutoFitColumns -Ws $wsSp -Context 'SharePointInfo'
-                    } else {
-                        $wsSp.Cells[$wsSp.Dimension.Address].AutoFitColumns() | Out-Null
-                    }
-                } catch {}
-            }
-
-            try {
-                if ($slBatchLink -and $batch) {
-                    $slBatchLink.Text = "SharePoint: $batch"
-                    $slBatchLink.Tag  = $batchInfo.Url
-                    $slBatchLink.Enabled = $true
-                }
-            } catch {}
-
-            try {
-                $wsSP = $pkgOut.Workbook.Worksheets['SharePoint Info']
-                if ($wsSP -and $wsSP.Dimension) {
-                    $labelCol = 1; $valueCol = 2
-                    for ($r = 1; $r -le $wsSP.Dimension.End.Row; $r++) {
-                        if (($wsSP.Cells[$r,$labelCol].Text).Trim() -eq 'Sample Reagent use') {
-                            $wsSP.Cells[$r,$valueCol].Style.WrapText = $true
-                            $wsSP.Cells[$r,$valueCol].Style.VerticalAlignment = [OfficeOpenXml.Style.ExcelVerticalAlignment]::Top
-                            try { $wsSP.Column($valueCol).Width = 55 } catch {}
-                            $wsSP.Row($r).CustomHeight = $true
-                            break
-                        }
-                    }
-                }
-            } catch {
-                Gui-Log "‚ö†Ô∏è WrapText p√• 'Sample Reagent use' misslyckades: $($_.Exception.Message)" 'Warn'
-            }
-        }
-    }
-} catch {
-    Gui-Log "‚ö†Ô∏è SP-blad: $($_.Exception.Message)" 'Warn'
-}
-
-# ============================
-# === Header watermark     ===
-# ============================
-try {
-    foreach ($ws in $pkgOut.Workbook.Worksheets) {
-        try {
-            $ws.HeaderFooter.OddHeader.CenteredText   = '&"Arial,Bold"&14 UNCONTROLLED'
-            $ws.HeaderFooter.EvenHeader.CenteredText  = '&"Arial,Bold"&14 UNCONTROLLED'
-            $ws.HeaderFooter.FirstHeader.CenteredText = '&"Arial,Bold"&14 UNCONTROLLED'
-        } catch {
-            Gui-Log ("‚ö†Ô∏è Kunde inte s√§tta header p√• blad: " + $ws.Name) 'Warn'
-        }
-    }
-} catch {
-    Gui-Log "‚ö†Ô∏è Fel vid vattenst√§mpling av rapporten." 'Warn'
-}
-
-# ============================
-# === Tab-f√§rger (innan Save)
-# ============================
-try {
-    $wsT = $pkgOut.Workbook.Worksheets['Information'];     if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 52, 152, 219) }
-    $wsT = $pkgOut.Workbook.Worksheets['Infinity/GX'];     if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 33, 115, 70) }
-    $wsT = $pkgOut.Workbook.Worksheets['SharePoint Info']; if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 0, 120, 212) }
-} catch {
-    Gui-Log "‚ö†Ô∏è Kunde inte s√§tta tab-f√§rg: $($_.Exception.Message)" 'Warn'
-}
-
-        # ============================
-        # === Spara & Audit        ===
-        # ============================
-
-        $nowTs    = Get-Date -Format "yyyyMMdd_HHmmss"
-        $baseName = "$($env:USERNAME)_output_${lsp}_$nowTs.xlsx"# (GUI-val borttaget) Spara alltid i tempor√§r katalog
-$saveDir  = $env:TEMP
-$SavePath = Join-Path $saveDir $baseName
-Gui-Log "üíæ Sparl√§ge: Tempor√§rt ‚Üí $SavePath"
-try {
-            $pkgOut.Workbook.View.ActiveTab = 0
-            $wsInitial = $pkgOut.Workbook.Worksheets["Information"]
-            if ($wsInitial) { $wsInitial.View.TabSelected = $true }
-
-            # ============================
-            # === RuleEngine Debug Sheet ==
-            # ============================
-            try {
-                if ((Get-ConfigFlag -Name 'EnableRuleEngine' -Default $false -ConfigOverride $Config) -and
-                    (Get-ConfigFlag -Name 'EnableRuleEngineDebugSheet' -Default $false -ConfigOverride $Config) -and
-                    $selCsv -and (Test-Path -LiteralPath $selCsv)) {
-
-                    # Om shadow saknas/tom: bygg fr√•n cache i f√∂rsta hand
-                    if (-not $script:RuleEngineShadow -or -not $script:RuleEngineShadow.Rows -or $script:RuleEngineShadow.Rows.Count -eq 0) {
-
-                        Gui-Log "üß† RuleEngine (shadow): saknas vid Save ‚Üí bygger nu..." 'Warn'
-
-                        $rb2 = $script:RuleBankCache
-                        if (-not $rb2) {
-                            $rb2 = Load-RuleBank -RuleBankDir $Config.RuleBankDir
-                            try { $rb2 = Compile-RuleBank -RuleBank $rb2 } catch {}
-                        }
-
-                        $csvObjs2 = $script:RuleEngineCsvObjs
-                        if (-not $csvObjs2 -or $csvObjs2.Count -eq 0) {
-                            $csvObjs2 = @()
-                            if ($csvRows -and $csvRows.Count -gt 0) {
-                                $csvObjs2 = @($csvRows)
-                            } else {
-                                try {
-                                    $all = Get-Content -LiteralPath $selCsv
-                                    if ($all -and $all.Count -gt 9) {
-                                        $hdr = ConvertTo-CsvFields $all[7]
-                                        $dl  = $all[9..($all.Count-1)] | Where-Object { $_ -and $_.Trim() }
-                                        $del = Get-CsvDelimiter -Path $selCsv
-                                        $csvObjs2 = @(ConvertFrom-Csv -InputObject ($dl -join "`n") -Delimiter $del -Header $hdr)
-                                    }
-                                } catch { $csvObjs2 = @() }
-                            }
-                        }
-
-                        if ($csvObjs2 -and $csvObjs2.Count -gt 0) {
-                            $script:RuleEngineShadow = Invoke-RuleEngine -CsvObjects $csvObjs2 -RuleBank $rb2 -CsvPath $selCsv
-                        } else {
-                            Gui-Log "‚ö†Ô∏è RuleEngine (shadow): kunde inte bygga vid Save (0 rader)." 'Warn'
-                        }
-                    }
-
-                    if ($script:RuleEngineShadow -and $script:RuleEngineShadow.Rows -and $script:RuleEngineShadow.Rows.Count -gt 0) {
-                        Gui-Log "üß† Skriver Sammanfattning av CSV..." 'Info'
-                        $includeAll = Get-ConfigFlag -Name 'RuleEngineDebugIncludeAllRows' -Default $false -ConfigOverride $Config
-                        [void](Write-RuleEngineDebugSheet -Pkg $pkgOut -RuleEngineResult $script:RuleEngineShadow -IncludeAllRows $includeAll)
-                    } else {
-                        Gui-Log "‚ö†Ô∏è RuleEngine_Debug hoppar √∂ver: inget RuleEngine-resultat." 'Warn'
-                    }
-                }
-            } catch {
-                Gui-Log ("‚ö†Ô∏è Kunde inte skriva RuleEngine_Debug: " + $_.Exception.Message) 'Warn'
-            }
-
-            Set-UiStep 90 'Sparar rapport‚Ä¶'
-            $pkgOut.SaveAs($SavePath)
-            Set-UiStep 100 'Klar ‚úÖ'
-            Gui-Log -Text ("‚úÖ Rapport sparad: {0}" -f $SavePath) -Severity Info -Category RESULT
-            $global:LastReportPath = $SavePath
-
-            # Audit (beh√•ll din befintliga audit-logik; den funkar som den √§r)
-            try {
-                $auditDir = Join-Path $PSScriptRoot 'audit'
-                if (-not (Test-Path $auditDir)) { New-Item -ItemType Directory -Path $auditDir -Force | Out-Null }
-
-                $auditObj = [pscustomobject]@{
-                    DatumTid        = (Get-Date).ToString('yyyy-MM-dd HH:mm:ss')
-                    Anv√§ndare       = $env:USERNAME
-                    LSP             = $lsp
-                    ValdCSV         = if ($selCsv) { Split-Path $selCsv -Leaf } else { '' }
-                    ValdSealNEG     = Split-Path $selNeg -Leaf
-                    ValdSealPOS     = Split-Path $selPos -Leaf
-                    SignaturSkriven = if ($chkWriteSign.Checked) { 'Ja' } else { 'Nej' }
-                    OverwroteSign   = if ($chkOverwriteSign.Checked) { 'Ja' } else { 'Nej' }
-                    SigMismatch     = if ($sigMismatch) { 'Ja' } else { 'Nej' }
-                    MismatchSheets  = if ($mismatchSheets -and $mismatchSheets.Count -gt 0) { ($mismatchSheets -join ';') } else { '' }
-                    ViolationsNEG   = $violationsNeg.Count
-                    ViolationsPOS   = $violationsPos.Count
-                    Violations      = ($violationsNeg.Count + $violationsPos.Count)
-                    Sparl√§ge        = 'Tempor√§rt'
-                    OutputFile      = $SavePath
-                    Kommentar       = 'UNCONTROLLED rapport, ingen k√§llfil √§ndrades automatiskt.'
-                    ScriptVersion   = $ScriptVersion
-                }
-
-                $auditFile = Join-Path $auditDir ("$($env:USERNAME)_audit_${nowTs}.csv")
-                $auditObj | Export-Csv -Path $auditFile -NoTypeInformation -Encoding UTF8
-
-                try {
-                    $statusText = 'OK'
-                    if (($violationsNeg.Count + $violationsPos.Count) -gt 0 -or $sigMismatch -or ($mismatchSheets -and $mismatchSheets.Count -gt 0)) {
-                        $statusText = 'Warnings'
-                    }
-                    $auditTests = $null
-                    try { if ($csvStats) { $auditTests = $csvStats.TestCount } } catch {}
-                    Add-AuditEntry -Lsp $lsp -Assay $runAssay -BatchNumber $batch -TestCount $auditTests -Status $statusText -ReportPath $SavePath
-                } catch {
-                    Gui-Log "‚ö†Ô∏è Kunde inte skriva audit-CSV: $($_.Exception.Message)" 'Warn'
-                }
-            } catch {
-                Gui-Log "‚ö†Ô∏è Kunde inte skriva revisionsfil: $($_.Exception.Message)" 'Warn'
-            }
-
-            try { Start-Process -FilePath "excel.exe" -ArgumentList "`"$SavePath`"" } catch {}
-        }
-        catch {
-            Gui-Log "‚ö†Ô∏è Kunde inte spara/√∂ppna: $($_.Exception.Message)" 'Warn'
-        }
-
-    } finally {
-        try { if ($pkgNeg) { $pkgNeg.Dispose() } } catch {}
-        try { if ($pkgPos) { $pkgPos.Dispose() } } catch {}
-        try { if ($pkgOut) { $pkgOut.Dispose() } } catch {}
-        Set-UiBusy -Busy $false
-        $script:BuildInProgress = $false
-    }
-})
-
-#endregion Event Handlers
-
-# === Tooltip-inst√§llningar ===
-$toolTip = New-Object System.Windows.Forms.ToolTip
-$toolTip.AutoPopDelay = 8000
-$toolTip.InitialDelay = 500
-$toolTip.ReshowDelay  = 500
-$toolTip.ShowAlways   = $true
-$toolTip.SetToolTip($txtLSP, 'Ange LSP-numret utan "#" och klicka p√• S√∂k filer.')
-$toolTip.SetToolTip($btnScan, 'S√∂k efter LSP och lista tillg√§ngliga filer.')
-$toolTip.SetToolTip($clbCsv,  'V√§lj CSV-fil.')
-$toolTip.SetToolTip($clbNeg,  'V√§lj Seal Test Neg-fil.')
-$toolTip.SetToolTip($clbPos,  'V√§lj Seal Test Pos-fil.')
-$toolTip.SetToolTip($btnCsvBrowse, 'Bl√§ddra efter en CSV-fil manuellt.')
-$toolTip.SetToolTip($btnNegBrowse, 'Bl√§ddra efter Seal Test Neg-fil manuellt.')
-$toolTip.SetToolTip($btnPosBrowse, 'Bl√§ddra efter Seal Test Pos-fil manuellt.')
-$toolTip.SetToolTip($txtSigner, 'Skriv fullst√§ndigt namn, signatur och datum (separerat med kommatecken).')
-$toolTip.SetToolTip($chkWriteSign, 'Signatur appliceras p√• flikar.')
-$toolTip.SetToolTip($chkOverwriteSign, 'Dubbelkontroll f√∂r att aktivera signering')
-$miToggleSign.ToolTipText = 'Visa eller d√∂lj panelen f√∂r att l√§gga till signatur.'
-if ($rbSaveInLsp) { $toolTip.SetToolTip($rbSaveInLsp, 'Spara rapporten i mappen f√∂r ditt LSP.') }
-if ($rbTempOnly) { $toolTip.SetToolTip($rbTempOnly, 'Skapa rapporten tempor√§r utan att spara.') }
-$toolTip.SetToolTip($btnBuild, 'Skapa och √∂ppna rapporten baserat p√• de valda filerna.')
-if ($chkSharePointInfo) { $toolTip.SetToolTip($chkSharePointInfo, 'Exportera med SharePoint Info.') }
-$txtLSP.add_TextChanged({ Update-BatchLink })
-
-#region Main Run / Orchestration
-# =============== SLUT ===============
-function Enable-DoubleBuffer {
-    $pi = [Windows.Forms.Control].GetProperty('DoubleBuffered',[Reflection.BindingFlags]'NonPublic,Instance')
-    foreach($c in @($content,$pLog,$grpPick,$grpSign,$grpSave)) { if ($c) { $pi.SetValue($c,$true,$null) } }
-}
-try { Set-Theme 'light' } catch {}
-Enable-DoubleBuffer
-Update-BatchLink
-[System.Windows.Forms.Application]::Run($form)
-
-try{ Stop-Transcript | Out-Null }catch{}
-#endregion Main Run / Orchestration
+Ôªø#region Importering och config
+if ([Threading.Thread]::CurrentThread.ApartmentState -ne 'STA') {
+    $exe = Join-Path $PSHome 'powershell.exe'
+    $scriptPath = if ($PSCommandPath) { $PSCommandPath } else { $MyInvocation.MyCommand.Path }
+    Start-Process -FilePath $exe -ArgumentList "-NoProfile -STA -ExecutionPolicy Bypass -File `"$scriptPath`""
+    exit
+}
+
+Add-Type -AssemblyName System.Windows.Forms
+try { [System.Windows.Forms.Application]::EnableVisualStyles() } catch {}
+Add-Type -AssemblyName System.Drawing
+Add-Type -AssemblyName System.ComponentModel
+try {
+    Add-Type -AssemblyName 'Microsoft.VisualBasic' -ErrorAction SilentlyContinue
+} catch {}
+
+$scriptPath = if ($PSCommandPath) { $PSCommandPath } else { $MyInvocation.MyCommand.Path }
+$ScriptRootPath = [System.IO.Path]::GetDirectoryName([System.IO.Path]::GetFullPath($scriptPath))
+$PSScriptRoot = $ScriptRootPath
+try {
+    $cwd = (Get-Location).Path
+    Write-Host ("[EXEC] Script={0} | ScriptRoot={1} | CWD={2}" -f $scriptPath, $ScriptRootPath, $cwd)
+} catch {}
+$modulesRoot = Join-Path $ScriptRootPath 'Modules'
+
+
+# samlade layoutkonstanter, lite r√∂rigt
+$Layout = @{ SignatureCell = 'B47' }
+
+. (Join-Path $modulesRoot 'Config.ps1') -ScriptRoot $ScriptRootPath
+. (Join-Path $modulesRoot 'Splash.ps1')
+. (Join-Path $modulesRoot 'UiStyling.ps1')
+. (Join-Path $modulesRoot 'Logging.ps1')
+
+try {
+    $netRoot = ($env:IPT_NETWORK_ROOT + '').Trim()
+    $iptRoot = ($global:IPT_ROOT_EFFECTIVE + '').Trim()
+    $iptSrc  = ($global:IPT_ROOT_SOURCE + '').Trim()
+    $logPath = ($global:LogPath + '').Trim()
+    $jsonl   = ($global:StructuredLogPath + '').Trim()
+
+    if (-not $netRoot) { $netRoot = '<empty>' }
+    if (-not $iptRoot) { $iptRoot = '<empty>' }
+    if (-not $iptSrc)  { $iptSrc  = '<empty>' }
+    if (-not $logPath) { $logPath = '<empty>' }
+    if (-not $jsonl)   { $jsonl   = '<empty>' }
+
+    $msg = "Sanity: IPT_NETWORK_ROOT=$netRoot | IPT_ROOT_EFFECTIVE=$iptRoot | IPT_ROOT_SOURCE=$iptSrc | LogPath=$logPath | StructuredLogPath=$jsonl"
+    try { Gui-Log -Text $msg -Severity 'Info' -Category 'SANITY' } catch { Write-Host $msg }
+} catch { }
+
+. (Join-Path $modulesRoot 'DataHelpers.ps1')
+. (Join-Path $modulesRoot 'SignatureHelpers.ps1')
+. (Join-Path $modulesRoot 'RuleEngine.ps1')
+
+$global:SpEnabled = Get-ConfigFlag -Name 'EnableSharePoint' -Default $true -ConfigOverride $Config
+
+
+$global:StartupReady = $true
+$configStatus = $null
+
+try {
+
+    $configStatus = Test-Config
+    if ($configStatus) {
+        foreach ($err in $configStatus.Errors) { Gui-Log "‚ùå Konfig-fel: $err" 'Error' }
+        foreach ($warn in $configStatus.Warnings) { Gui-Log "‚ö†Ô∏è Konfig-varning: $warn" 'Warn' }
+        if (-not $configStatus.Ok) {
+            $global:StartupReady = $false
+            try { [System.Windows.Forms.MessageBox]::Show("Startkontroll misslyckades. Se logg f√∂r detaljer.","Startkontroll") | Out-Null } catch {}
+        }
+    }
+} catch { Gui-Log "‚ùå Test-Config misslyckades: $($_.Exception.Message)" 'Error'; $global:StartupReady = $false }
+
+$Host.UI.RawUI.WindowTitle = "Startar‚Ä¶"
+Show-Splash "Laddar PowerShell‚Ä¶"
+$env:PNPPOWERSHELL_UPDATECHECK = 'Off'  # st√§ng av update-check tidigt
+
+$global:SpConnected = $false
+$global:SpError     = $null
+
+try {
+    $null = Get-PackageProvider -Name "NuGet" -ForceBootstrap -ErrorAction SilentlyContinue
+} catch {}
+
+if ($global:SpEnabled) {
+    try {
+        Update-Splash "Laddar..."
+        Import-Module PnP.PowerShell -ErrorAction Stop
+    } catch {
+        try {
+            Gui-Log "‚ÑπÔ∏è PowerShell-modulen saknas, installerar modulen..." 'Info'
+            Install-Module PnP.PowerShell -MaximumVersion 1.12.0 -Scope CurrentUser -Force -AllowClobber -ErrorAction Stop
+            Update-Splash "Laddar..."
+            Import-Module PnP.PowerShell -ErrorAction Stop
+        } catch {
+            $global:SpError = "PnP-install/import misslyckades: $($_.Exception.Message)"
+        }
+    }
+} else {
+    $global:SpError = 'SharePoint avst√§ngt i Config'
+    try { Gui-Log "‚ÑπÔ∏è SharePoint √§r avst√§ngt i konfigurationen." 'Info' } catch {}
+}
+try { $null = Ensure-EPPlus -Version '4.5.3.3' } catch { Gui-Log "‚ö†Ô∏è EPPlus-f√∂rkontroll misslyckades: $($_.Exception.Message)" 'Warn' }
+
+if ($global:SpEnabled -and -not $global:SpError) {
+    try {
+        Update-Splash "Ansluter till SharePoint"
+        Connect-PnPOnline -Url $global:SP_SiteUrl `
+                          -Tenant $global:SP_Tenant `
+                          -ClientId $global:SP_ClientId `
+                          -CertificateBase64Encoded $global:SP_CertBase64 `
+                          -ErrorAction Stop
+        $global:SpConnected = $true
+    } catch {
+        $msg = "Connect-PnPOnline misslyckades: $($_.Exception.Message)"
+        Update-Splash $msg
+        $global:SpError = $msg
+    }
+}
+#endregion Importering och config
+
+#region GUI 
+
+Update-Splash "Startar‚Ä¶"
+Close-Splash
+$form = New-Object System.Windows.Forms.Form
+$form.Text = "$ScriptVersion"
+$form.AutoScaleMode = 'Dpi'
+$form.Size = New-Object System.Drawing.Size(860,870)
+$form.MinimumSize = New-Object System.Drawing.Size(860,870)
+$form.StartPosition = 'CenterScreen'
+$form.BackColor = [System.Drawing.Color]::WhiteSmoke
+$form.AutoScroll  = $false
+$form.MaximizeBox = $false
+$form.Padding     = New-Object System.Windows.Forms.Padding(8)
+$form.Font        = New-Object System.Drawing.Font('Segoe UI',10)
+$form.KeyPreview = $true
+$form.add_KeyDown({ if ($_.KeyCode -eq [System.Windows.Forms.Keys]::Escape) { $form.Close() } })
+
+# ---------- Menyrad ----------
+$menuStrip = New-Object System.Windows.Forms.MenuStrip
+$menuStrip.Dock='Top'; $menuStrip.GripStyle='Hidden'
+$menuStrip.ImageScalingSize = New-Object System.Drawing.Size(20,20)
+$menuStrip.Padding = New-Object System.Windows.Forms.Padding(8,6,0,6)
+$menuStrip.Font = New-Object System.Drawing.Font('Segoe UI',10)
+$miArkiv   = New-Object System.Windows.Forms.ToolStripMenuItem('üóÇÔ∏è Arkiv')
+$miVerktyg = New-Object System.Windows.Forms.ToolStripMenuItem('üõ†Ô∏è Verktyg')
+$miSettings= New-Object System.Windows.Forms.ToolStripMenuItem('‚öôÔ∏è Inst√§llningar')
+$miHelp    = New-Object System.Windows.Forms.ToolStripMenuItem('üìñ Instruktioner')
+$miAbout   = New-Object System.Windows.Forms.ToolStripMenuItem('‚ÑπÔ∏è Om')
+$miScan  = New-Object System.Windows.Forms.ToolStripMenuItem('üîç S√∂k filer')
+$miBuild = New-Object System.Windows.Forms.ToolStripMenuItem('‚úÖ Skapa rapport')
+$miExit  = New-Object System.Windows.Forms.ToolStripMenuItem('‚ùå Avsluta')
+
+# Rensa ev. gamla undermenyer
+$miArkiv.DropDownItems.Clear()
+$miVerktyg.DropDownItems.Clear()
+$miSettings.DropDownItems.Clear()
+$miHelp.DropDownItems.Clear()
+
+# ----- Arkiv -----
+$miNew         = New-Object System.Windows.Forms.ToolStripMenuItem('üÜï Nytt')
+$miOpenRecent  = New-Object System.Windows.Forms.ToolStripMenuItem('üìÇ √ñppna senaste rapport')
+$miArkiv.DropDownItems.AddRange(@(
+    $miNew,
+    $miOpenRecent,
+    (New-Object System.Windows.Forms.ToolStripSeparator),
+    $miExit
+))
+
+# ----- Verktyg -----
+$miScript1   = New-Object System.Windows.Forms.ToolStripMenuItem('üìú Kontrollprovsfil-skript')
+$miScript2   = New-Object System.Windows.Forms.ToolStripMenuItem('üìú Aktivera Kontrollprovsfil')
+$miScript3   = New-Object System.Windows.Forms.ToolStripMenuItem('üìÖ √Ñndra datum p√• filer')
+$miToggleSign = New-Object System.Windows.Forms.ToolStripMenuItem('‚úÖ Aktivera Seal Test-signatur')
+$miVerktyg.DropDownItems.AddRange(@(
+    $miScript1,
+    $miScript2,
+    $miScript3,
+    $miToggleSign
+))
+
+# ----- Inst√§llningar -----
+$miTheme = New-Object System.Windows.Forms.ToolStripMenuItem('üé® Tema')
+$miLightTheme = New-Object System.Windows.Forms.ToolStripMenuItem('‚òÄÔ∏è Ljust (default)')
+$miDarkTheme  = New-Object System.Windows.Forms.ToolStripMenuItem('üåô M√∂rkt')
+$miTheme.DropDownItems.AddRange(@($miLightTheme,$miDarkTheme))
+$miSettings.DropDownItems.Add($miTheme)
+
+# ----- Instruktioner -----
+$miShowInstr   = New-Object System.Windows.Forms.ToolStripMenuItem('üìñ Visa instruktioner')
+$miFAQ         = New-Object System.Windows.Forms.ToolStripMenuItem('‚ùì FAQ')
+$miHelpDlg     = New-Object System.Windows.Forms.ToolStripMenuItem('üÜò Hj√§lp')
+$miHelp.DropDownItems.AddRange(@($miShowInstr,$miFAQ,$miHelpDlg))
+
+$miGenvagar = New-Object System.Windows.Forms.ToolStripMenuItem('üîó Genv√§gar')
+$ShortcutGroups = Get-ConfigValue -Name 'ShortcutGroups' -Default $null -ConfigOverride $Config
+if (-not $ShortcutGroups) {
+    # Fallback om config saknar genv√§gar
+    $ShortcutGroups = @{
+        'üóÇÔ∏è IPT-mappar' = @(
+            @{ Text='üìÇ IPT - P√ÖG√ÖENDE K√ñRNINGAR';        Target='N:\QC\QC-1\IPT\2. IPT - P√ÖG√ÖENDE K√ñRNINGAR' },
+            @{ Text='üìÇ IPT - KLART F√ñR SAMMANST√ÑLLNING'; Target='N:\QC\QC-1\IPT\3. IPT - KLART F√ñR SAMMANST√ÑLLNING' },
+            @{ Text='üìÇ IPT - KLART F√ñR GRANSKNING';      Target='N:\QC\QC-1\IPT\4. IPT - KLART F√ñR GRANSKNING' },
+            @{ Text='üìÇ SPT Macro Assay';                 Target='N:\QC\QC-0\SPT\SPT macros\Assay' }
+        )
+        'üìÑ Dokument' = @(
+            @{ Text='üß∞ Utrustningslista';    Target=$UtrustningListPath },
+            @{ Text='üß™ Kontrollprovsfil';    Target=$RawDataPath }
+        )
+        'üåê L√§nkar' = @(
+            @{ Text='‚ö° IPT App';              Target='https://apps.powerapps.com/play/e/default-771c9c47-7f24-44dc-958e-34f8713a8394/a/fd340dbd-bbbf-470b-b043-d2af4cb62c83' },
+            @{ Text='üåê MES';                  Target='http://mes.cepheid.pri/camstarportal/?domain=CEPHEID.COM' },
+            @{ Text='üåê CSV Uploader';         Target='http://auw2wgxtpap01.cepaws.com/Welcome.aspx' },
+            @{ Text='üåê BMRAM';                Target='https://cepheid62468.coolbluecloud.com/' },
+            @{ Text='üåê Agile';                Target='https://agileprod.cepheid.com/Agile/default/login-cms.jsp' }
+        )
+    }
+}
+
+foreach ($grp in $ShortcutGroups.GetEnumerator()) {
+
+    $grpMenu = New-Object System.Windows.Forms.ToolStripMenuItem($grp.Key)
+    foreach ($entry in $grp.Value) { Add-ShortcutItem -Parent $grpMenu -Text $entry.Text -Target $entry.Target }
+    [void]$miGenvagar.DropDownItems.Add($grpMenu)
+
+}
+
+$miOm = New-Object System.Windows.Forms.ToolStripMenuItem('‚ÑπÔ∏è Om det h√§r verktyget'); $miAbout.DropDownItems.Add($miOm)
+$menuStrip.Items.AddRange(@($miArkiv,$miVerktyg,$miGenvagar,$miSettings,$miHelp,$miAbout))
+$form.MainMenuStrip=$menuStrip
+
+# ---------- Header ----------
+$panelHeader = New-Object System.Windows.Forms.Panel
+$panelHeader.Dock='Top'; $panelHeader.Height=64
+$panelHeader.BackColor=[System.Drawing.Color]::SteelBlue
+$panelHeader.Padding = New-Object System.Windows.Forms.Padding(10,8,10,8)
+
+$picLogo = New-Object System.Windows.Forms.PictureBox
+$picLogo.Dock='Left'; $picLogo.Width=50; $picLogo.BorderStyle='FixedSingle'
+if(Test-Path $ikonSokvag){ $picLogo.Image=[System.Drawing.Image]::FromFile($ikonSokvag); $picLogo.SizeMode='Zoom' }
+$form.add_FormClosed({ try { if ($picLogo.Image) { $picLogo.Image.Dispose() } } catch {} })
+
+$lblTitle = New-Object System.Windows.Forms.Label
+$lblTitle.Text="$ScriptVersion - IPTCompile"
+$lblTitle.ForeColor=[System.Drawing.Color]::White
+$lblTitle.Font = New-Object System.Drawing.Font('Segoe UI Semibold',13)
+$lblTitle.TextAlign = [System.Drawing.ContentAlignment]::MiddleLeft
+$lblTitle.Padding = New-Object System.Windows.Forms.Padding(8,0,0,0)
+$lblTitle.Dock='Fill'
+
+$panelHeader.Controls.Add($lblTitle)
+$panelHeader.Controls.Add($picLogo)
+
+# ---------- S√∂k-rad ----------
+
+$tlSearch = New-Object System.Windows.Forms.TableLayoutPanel
+$tlSearch.Dock='Top'; $tlSearch.AutoSize=$true; $tlSearch.AutoSizeMode='GrowAndShrink'
+$tlSearch.Padding = New-Object System.Windows.Forms.Padding(0,10,0,8)
+$tlSearch.ColumnCount=3
+[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
+[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
+[void]$tlSearch.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,130)))
+
+$lblLSP = New-Object System.Windows.Forms.Label
+$lblLSP.Text='LSP:'; $lblLSP.Anchor='Left'; $lblLSP.AutoSize=$true
+$lblLSP.Margin = New-Object System.Windows.Forms.Padding(0,6,8,0)
+$txtLSP = New-Object System.Windows.Forms.TextBox
+$txtLSP.Dock='Fill'
+$txtLSP.Margin = New-Object System.Windows.Forms.Padding(0,2,10,2)
+$btnScan = New-Object System.Windows.Forms.Button
+$btnScan.Text='S√∂k filer'; $btnScan.Dock='Fill'; Set-AccentButton $btnScan -Primary
+$btnScan.Margin= New-Object System.Windows.Forms.Padding(0,2,0,2)
+
+$tlSearch.Controls.Add($lblLSP,0,0)
+$tlSearch.Controls.Add($txtLSP,1,0)
+$tlSearch.Controls.Add($btnScan,2,0)
+
+$pLog = New-Object System.Windows.Forms.Panel
+$pLog.Dock='Top'; $pLog.Height=220; $pLog.Padding=New-Object System.Windows.Forms.Padding(0,0,0,8)
+
+$outputBox = New-Object System.Windows.Forms.TextBox
+$outputBox.Multiline=$true; $outputBox.ScrollBars='Vertical'; $outputBox.ReadOnly=$true
+$outputBox.BackColor='White'; $outputBox.Dock='Fill'
+$outputBox.Font = New-Object System.Drawing.Font('Segoe UI',9)
+$pLog.Controls.Add($outputBox)
+try { Set-LogOutputControl -Control $outputBox } catch {}
+
+$grpPick = New-Object System.Windows.Forms.GroupBox
+$grpPick.Text='V√§lj filer f√∂r rapport'
+$grpPick.Dock='Top'
+$grpPick.Padding = New-Object System.Windows.Forms.Padding(10,12,10,14)
+$grpPick.AutoSize=$false
+$grpPick.Height = (78*3) + $grpPick.Padding.Top + $grpPick.Padding.Bottom +15
+
+$tlPick = New-Object System.Windows.Forms.TableLayoutPanel
+$tlPick.Dock='Fill'; $tlPick.ColumnCount=3; $tlPick.RowCount=3
+$tlPick.GrowStyle=[System.Windows.Forms.TableLayoutPanelGrowStyle]::FixedSize
+[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
+[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
+[void]$tlPick.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,100)))
+for($i=0;$i -lt 3;$i++){ [void]$tlPick.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,78))) }
+
+function New-ListRow {
+    param([string]$labelText,[ref]$lbl,[ref]$clb,[ref]$btn)
+    $lbl.Value = New-Object System.Windows.Forms.Label
+    $lbl.Value.Text=$labelText
+    $lbl.Value.Anchor='Left'
+    $lbl.Value.AutoSize=$true
+    $lbl.Value.Margin=New-Object System.Windows.Forms.Padding(0,12,6,0)
+    $clb.Value = New-Object System.Windows.Forms.CheckedListBox
+    $clb.Value.Dock='Fill'
+    $clb.Value.Margin=New-Object System.Windows.Forms.Padding(0,6,8,6)
+    $clb.Value.Height=70
+    $clb.Value.IntegralHeight=$false
+    $clb.Value.CheckOnClick = $true
+    $clb.Value.DisplayMember = 'Name'
+
+    $btn.Value = New-Object System.Windows.Forms.Button
+    $btn.Value.Text='Bl√§ddra‚Ä¶'
+    $btn.Value.Dock='Fill'
+    $btn.Value.Margin=New-Object System.Windows.Forms.Padding(0,6,0,6)
+    Set-AccentButton $btn.Value
+}
+
+$lblCsv=$null;$clbCsv=$null;$btnCsvBrowse=$null
+New-ListRow -labelText 'CSV-fil:' -lbl ([ref]$lblCsv) -clb ([ref]$clbCsv) -btn ([ref]$btnCsvBrowse)
+$lblNeg=$null;$clbNeg=$null;$btnNegBrowse=$null
+New-ListRow -labelText 'Seal Test Neg:' -lbl ([ref]$lblNeg) -clb ([ref]$clbNeg) -btn ([ref]$btnNegBrowse)
+$lblPos=$null;$clbPos=$null;$btnPosBrowse=$null
+New-ListRow -labelText 'Seal Test Pos:' -lbl ([ref]$lblPos) -clb ([ref]$clbPos) -btn ([ref]$btnPosBrowse)
+
+try {
+    if ($tlPick.RowCount -lt 4) {
+        $tlPick.RowCount = 4
+        for ($i=$tlPick.RowStyles.Count; $i -lt 4; $i++) {
+            $null = $tlPick.RowStyles.Add( (New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 78)) )
+        }
+        $grpPick.Height = (78*4) + $grpPick.Padding.Top + $grpPick.Padding.Bottom + 15
+    }
+} catch {}
+
+$lblLsp = $null; $clbLsp = $null; $btnLspBrowse = $null
+New-ListRow -labelText 'Worksheet:' -lbl ([ref]$lblLsp) -clb ([ref]$clbLsp) -btn ([ref]$btnLspBrowse)
+
+$tlPick.Controls.Add($lblLsp,  0, 3)
+$tlPick.Controls.Add($clbLsp,  1, 3)
+$tlPick.Controls.Add($btnLspBrowse, 2, 3)
+
+$clbLsp.add_ItemCheck({
+    param($s,$e)
+    if ($e.NewValue -eq [System.Windows.Forms.CheckState]::Checked) {
+        for ($i=0; $i -lt $s.Items.Count; $i++) {
+            if ($i -ne $e.Index) { $s.SetItemChecked($i, $false) }
+        }
+    }
+})
+
+$btnLspBrowse.Add_Click({
+    try {
+        $dlg = New-Object System.Windows.Forms.OpenFileDialog
+        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
+        $dlg.Title  = "V√§lj LSP Worksheet"
+        if ($dlg.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
+            $f = Get-Item -LiteralPath $dlg.FileName
+            Add-CLBItems -clb $clbLsp -files @($f) -AutoCheckFirst
+            if (Get-Command Update-StatusBar -ErrorAction SilentlyContinue) { Update-StatusBar }
+        }
+    } catch {
+        Gui-Log ("‚ö†Ô∏è LSP-browse fel: " + $_.Exception.Message) 'Warn'
+    }
+})
+
+# L√§gg in i tabellen
+$tlPick.Controls.Add($lblCsv,0,0); $tlPick.Controls.Add($clbCsv,1,0); $tlPick.Controls.Add($btnCsvBrowse,2,0)
+$tlPick.Controls.Add($lblNeg,0,1); $tlPick.Controls.Add($clbNeg,1,1); $tlPick.Controls.Add($btnNegBrowse,2,1)
+$tlPick.Controls.Add($lblPos,0,2); $tlPick.Controls.Add($clbPos,1,2); $tlPick.Controls.Add($btnPosBrowse,2,2)
+$grpPick.Controls.Add($tlPick)
+
+# ---------- Signatur ----------
+$grpSign = New-Object System.Windows.Forms.GroupBox
+$grpSign.Text = "L√§gg till signatur i Seal Test-filerna"
+$grpSign.Dock='Top'
+$grpSign.Padding = New-Object System.Windows.Forms.Padding(10,8,10,10)
+$grpSign.AutoSize = $false
+$grpSign.Height = 88
+
+$tlSign = New-Object System.Windows.Forms.TableLayoutPanel
+$tlSign.Dock='Fill'; $tlSign.ColumnCount=2; $tlSign.RowCount=2
+[void]$tlSign.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::AutoSize)))
+[void]$tlSign.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
+[void]$tlSign.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,28)))
+[void]$tlSign.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,28)))
+
+$lblSigner = New-Object System.Windows.Forms.Label
+$lblSigner.Text = 'Fullst√§ndigt namn, signatur och datum:'
+$lblSigner.Anchor='Left'; $lblSigner.AutoSize=$true
+
+$txtSigner = New-Object System.Windows.Forms.TextBox
+$txtSigner.Dock='Fill'; $txtSigner.Margin = New-Object System.Windows.Forms.Padding(6,2,0,2)
+$chkWriteSign = New-Object System.Windows.Forms.CheckBox
+$chkWriteSign.Text = 'Signera Seal Test-Filerna'
+$chkWriteSign.Anchor='Left'
+$chkWriteSign.AutoSize = $true
+
+$chkOverwriteSign = New-Object System.Windows.Forms.CheckBox
+$chkOverwriteSign.Text = 'Aktivera'
+
+$chkOverwriteSign.Anchor='Left'
+$chkOverwriteSign.AutoSize = $true
+$chkOverwriteSign.Enabled = $false
+$chkWriteSign.add_CheckedChanged({ $chkOverwriteSign.Enabled = $chkWriteSign.Checked })
+
+$tlSign.Controls.Add($lblSigner,0,0); $tlSign.Controls.Add($txtSigner,1,0)
+$tlSign.Controls.Add($chkWriteSign,0,1); $tlSign.Controls.Add($chkOverwriteSign,1,1)
+$grpSign.Controls.Add($tlSign)
+
+$grpSign.Visible = $false
+$baseHeight = $form.Height
+
+# ---------- Rapport-utdata ----------
+# (GUI-val borttaget) Rapporten sparas alltid tempor√§rt och SharePoint Info inkluderas alltid.
+$grpSave = $null
+$rbSaveInLsp = $null
+$rbTempOnly = $null
+$chkSharePointInfo = $null
+
+# ---------- Prim√§rknapp ----------
+
+$btnBuild = New-Object System.Windows.Forms.Button
+$btnBuild.Text='Skapa rapport'; $btnBuild.Dock='Top'; $btnBuild.Height=40
+$btnBuild.Margin = New-Object System.Windows.Forms.Padding(0,16,0,8)
+$btnBuild.Enabled=$false; Set-AccentButton $btnBuild -Primary
+
+# ---------- Statusrad ----------
+$status = New-Object System.Windows.Forms.StatusStrip
+$status.SizingGrip=$false; $status.Dock='Bottom'; $status.Font=New-Object System.Drawing.Font('Segoe UI',9)
+$status.ShowItemToolTips = $true
+$slCount = New-Object System.Windows.Forms.ToolStripStatusLabel; $slCount.Text='0 filer valda'; $slCount.Spring=$false
+$slWork  = New-Object System.Windows.Forms.ToolStripStatusLabel
+$slWork.Text   = ''
+$slWork.Spring = $true
+
+$pbWork = New-Object System.Windows.Forms.ToolStripProgressBar
+$pbWork.Visible = $false
+$pbWork.Style   = 'Marquee'
+$pbWork.MarqueeAnimationSpeed = 30
+$pbWork.AutoSize = $false
+$pbWork.Width    = 140
+
+$slSpacer= New-Object System.Windows.Forms.ToolStripStatusLabel; $slSpacer.Spring=$true
+
+# --- Klickbar SharePoint-l√§nk ---
+$slBatchLink = New-Object System.Windows.Forms.ToolStripStatusLabel
+$slBatchLink.IsLink   = $true
+$slBatchLink.Text     = 'SharePoint: ‚Äî'
+$slBatchLink.Enabled  = $false
+$slBatchLink.Tag      = $null
+$slBatchLink.ToolTipText = 'Direktl√§nk aktiveras n√§r Batch# hittas i filer.'
+$slBatchLink.add_Click({
+    if ($this.Enabled -and $this.Tag) {
+        try { Start-Process $this.Tag } catch {
+            [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna:`n$($this.Tag)`n$($_.Exception.Message)","L√§nk") | Out-Null
+        }
+    }
+})
+
+$status.Items.AddRange(@($slCount,$slWork,$pbWork,$slBatchLink))
+$tsc = New-Object System.Windows.Forms.ToolStripContainer
+$tsc.Dock = 'Fill'
+$tsc.LeftToolStripPanelVisible  = $false
+$tsc.RightToolStripPanelVisible = $false
+
+$form.SuspendLayout()
+$form.Controls.Clear()
+$form.Controls.Add($tsc)
+
+# Meny h√∂gst upp
+$tsc.TopToolStripPanel.Controls.Add($menuStrip)
+$form.MainMenuStrip = $menuStrip
+
+# Status l√§ngst ner
+$tsc.BottomToolStripPanel.Controls.Add($status)
+
+# Content i mitten
+$content = New-Object System.Windows.Forms.Panel
+$content.Dock='Fill'
+$content.BackColor = $form.BackColor
+$tsc.ContentPanel.Controls.Add($content)
+
+# Dock=Top: nedersta f√∂rst
+$content.SuspendLayout()
+$content.Controls.Add($btnBuild)
+$content.Controls.Add($grpSign)
+$content.Controls.Add($grpPick)
+$content.Controls.Add($pLog)
+$content.Controls.Add($tlSearch)
+$content.Controls.Add($panelHeader)
+$content.ResumeLayout()
+$form.ResumeLayout()
+$form.PerformLayout()
+$form.AcceptButton = $btnScan
+
+#endregion GUI Construction
+
+function Add-CLBItems {
+    param([System.Windows.Forms.CheckedListBox]$clb,[System.IO.FileInfo[]]$files,[switch]$AutoCheckFirst)
+    $clb.BeginUpdate()
+    $clb.Items.Clear()
+    foreach($f in $files){
+        if ($f -isnot [System.IO.FileInfo]) { try { $f = Get-Item -LiteralPath $f } catch { continue } }
+        [void]$clb.Items.Add($f, $false)
+    }
+    $clb.EndUpdate()
+    if ($AutoCheckFirst -and $clb.Items.Count -gt 0) { $clb.SetItemChecked(0,$true) }
+    Update-StatusBar
+}
+
+function Get-CheckedFilePath { param([System.Windows.Forms.CheckedListBox]$clb)
+    for($i=0;$i -lt $clb.Items.Count;$i++){
+        if ($clb.GetItemChecked($i)) {
+            $fi = [System.IO.FileInfo]$clb.Items[$i]
+            return $fi.FullName
+        }
+    }
+    return $null
+}
+
+function Clear-GUI {
+    $txtLSP.Text = ''
+    $txtSigner.Text = ''
+    $chkWriteSign.Checked = $false
+    $chkOverwriteSign.Checked = $false
+    Add-CLBItems -clb $clbCsv -files @()
+    Add-CLBItems -clb $clbNeg -files @()
+    Add-CLBItems -clb $clbPos -files @()
+    Add-CLBItems -clb $clbLsp -files @()
+    $outputBox.Clear()
+    Update-BuildEnabled
+    Gui-Log "üßπ GUI rensat." 'Info'
+    Update-BatchLink
+}
+
+$onExclusive = {
+    $clb = $this
+    if ($_.NewValue -eq [System.Windows.Forms.CheckState]::Checked) {
+        for ($i=0; $i -lt $clb.Items.Count; $i++) {
+            if ($i -ne $_.Index -and $clb.GetItemChecked($i)) { $clb.SetItemChecked($i, $false) }
+        }
+    }
+    $clb.BeginInvoke([Action]{ Update-BuildEnabled }) | Out-Null
+}
+$clbCsv.add_ItemCheck($onExclusive)
+$clbNeg.add_ItemCheck($onExclusive)
+$clbPos.add_ItemCheck($onExclusive)
+
+function Get-SelectedFileCount {
+    $n=0
+    if (Get-CheckedFilePath $clbCsv) { $n++ }
+    if (Get-CheckedFilePath $clbNeg) { $n++ }
+    if (Get-CheckedFilePath $clbPos) { $n++ }
+    if (Get-CheckedFilePath $clbLsp) { $n++ }
+    return $n
+}
+
+function Update-StatusBar { $slCount.Text = "$(Get-SelectedFileCount) filer valda" }
+
+function Invoke-UiPump {
+    try { [System.Windows.Forms.Application]::DoEvents() } catch {}
+}
+
+function Set-UiBusy {
+    param(
+        [Parameter(Mandatory)][bool]$Busy,
+        [string]$Message = ''
+    )
+    try {
+        if ($Busy) {
+            $slWork.Text = $Message
+            $pbWork.Visible = $true
+            $pbWork.Style   = 'Marquee'
+            $form.Cursor = [System.Windows.Forms.Cursors]::WaitCursor
+            $btnScan.Enabled  = $false
+            $btnBuild.Enabled = $false
+        } else {
+            $pbWork.Visible = $false
+            $pbWork.Style   = 'Blocks'
+            $pbWork.Value   = 0
+            $slWork.Text = ''
+            $form.Cursor = [System.Windows.Forms.Cursors]::Default
+            $btnScan.Enabled = $true
+            Update-BuildEnabled
+        }
+        $status.Refresh()
+        $form.Refresh()
+        Invoke-UiPump
+    } catch {}
+}
+
+function Set-UiStep {
+    param(
+        [Parameter(Mandatory)][int]$Percent,
+        [string]$Message = ''
+    )
+    try {
+        if ($Percent -lt 0) { $Percent = 0 }
+        if ($Percent -gt 100) { $Percent = 100 }
+        $slWork.Text = $Message
+        $pbWork.Visible = $true
+        $pbWork.Style   = 'Blocks'
+        $pbWork.Minimum = 0
+        $pbWork.Maximum = 100
+        if ($pbWork.Value -ne $Percent) { $pbWork.Value = $Percent }
+        $status.Refresh()
+        $form.Refresh()
+        Invoke-UiPump
+    } catch {}
+}
+
+
+function Update-BuildEnabled {
+    $btnBuild.Enabled = ((Get-CheckedFilePath $clbNeg) -and (Get-CheckedFilePath $clbPos))
+    Update-StatusBar
+}
+
+$script:LastScanResult = $null
+
+# Reentrancy guards (DoEvents can otherwise allow nested clicks)
+$script:ScanInProgress  = $false
+$script:BuildInProgress = $false
+
+function Get-BatchLinkInfo {
+    param(
+        [string]$SealPosPath,
+        [string]$SealNegPath,
+        [string]$Lsp
+    )
+
+    $batch = $null
+    try { if ($SealPosPath) { $batch = Get-BatchNumberFromSealFile $SealPosPath } } catch {}
+    if (-not $batch) {
+        try { if ($SealNegPath) { $batch = Get-BatchNumberFromSealFile $SealNegPath } } catch {}
+    }
+
+    $batchEsc = if ($batch) { [uri]::EscapeDataString($batch) } else { '' }
+    $lspEsc   = if ($Lsp)   { [uri]::EscapeDataString($Lsp) }   else { '' }
+
+    $url = if ($SharePointBatchLinkTemplate) {
+        ($SharePointBatchLinkTemplate -replace '\{BatchNumber\}', $batchEsc) -replace '\{LSP\}', $lspEsc
+    } else {
+        "https://danaher.sharepoint.com/sites/CEP-Sweden-Production-Management/Lists/Cepheid%20%20Production%20orders/AllItems.aspx?view=7&q=$batchEsc"
+    }
+    $linkText = if ($batch) { "√ñppna $batch" } else { 'Ingen batch funnen' }
+
+    return [pscustomobject]@{
+        Batch    = $batch
+        Url      = $url
+        LinkText = $linkText
+    }
+}
+
+function Assert-StartupReady {
+    if ($global:StartupReady) { return $true }
+    Gui-Log "‚ùå Startkontroll misslyckades. √Ötg√§rda konfigurationsfel innan du forts√§tter." 'Error'
+    return $false
+}
+
+function Find-LspFolder {
+    [CmdletBinding()]
+    param(
+        [Parameter(Mandatory)] [string]$Lsp,
+        [Parameter(Mandatory)] [string[]]$Roots
+    )
+
+    $lspRaw = ($Lsp + '').Trim()
+    if (-not $lspRaw) { return $null }
+
+    # Till√•t att anv√§ndaren skriver t.ex. "#38401" eller "38401" eller "LSP 38401".
+    $lspDigits = ($lspRaw -replace '\D', '')
+    if (-not $lspDigits) { return $null }
+
+    # Matcha som "eget tal": undvik att 3840 matchar 38401 osv.
+    $rxToken = "(?<!\d)#?\s*$lspDigits(?!\d)"
+
+    # Snabb v√§g: anv√§nd -Filter f√∂rst (fil-systemet kan optimera) + matcha med rxToken f√∂r att undvika falska tr√§ffar.
+    $filters = @("*$lspDigits*", "*#$lspDigits*")
+
+    foreach ($root in $Roots) {
+        if (-not $root) { continue }
+        if (-not (Test-Path -LiteralPath $root)) { continue }
+
+        # 1) F√∂rs√∂k hitta i √∂versta niv√•n (vanligaste fallet)
+        foreach ($f in $filters) {
+            try {
+                $hit = Get-ChildItem -LiteralPath $root -Directory -Filter $f -ErrorAction SilentlyContinue |
+                       Where-Object { $_.Name -match $rxToken } |
+                       Select-Object -First 1
+                if ($hit) { return $hit }
+            } catch {}
+        }
+
+        # 2) F√∂rs√∂k med -Recurse + -Filter
+        foreach ($f in $filters) {
+            try {
+                $hit = Get-ChildItem -LiteralPath $root -Directory -Recurse -Filter $f -ErrorAction SilentlyContinue |
+                       Where-Object { $_.Name -match $rxToken } |
+                       Select-Object -First 1
+                if ($hit) { return $hit }
+            } catch {}
+        }
+
+        # 3) Fallback
+        try {
+            $hit = Get-ChildItem -LiteralPath $root -Directory -Recurse -ErrorAction SilentlyContinue |
+                   Where-Object { $_.Name -match $rxToken } |
+                   Select-Object -First 1
+            if ($hit) { return $hit }
+        } catch {}
+    }
+
+    return $null
+}
+
+#region Event Handlers
+$miScan.add_Click({ $btnScan.PerformClick() })
+$miBuild.add_Click({ if ($btnBuild.Enabled) { $btnBuild.PerformClick() } })
+$miExit.add_Click({ $form.Close() })
+$miNew.add_Click({ Clear-GUI })
+
+$miOpenRecent.add_Click({
+    if ($global:LastReportPath -and (Test-Path -LiteralPath $global:LastReportPath)) {
+        try { Start-Process -FilePath $global:LastReportPath } catch {
+            [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna rapporten:\n$($_.Exception.Message)","√ñppna senaste rapport") | Out-Null
+        }
+    } else {
+        [System.Windows.Forms.MessageBox]::Show("Ingen rapport har genererats i denna session.","√ñppna senaste rapport") | Out-Null
+    }
+})
+
+# Skript1..3
+$miScript1.add_Click({
+    $p = $Script1Path
+    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("Ange s√∂kv√§gen till Skript1 i variabeln `$Script1Path.","Skript1") | Out-Null; return }
+    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("Filen hittades inte:\n$Script1Path","Skript1") | Out-Null; return }
+    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
+    switch ($ext) {
+        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
+        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
+        '.lnk' { Start-Process -FilePath $p }
+        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript1") | Out-Null } }
+    }
+})
+
+$miScript2.add_Click({
+    $p = $Script2Path
+    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("Ange s√∂kv√§gen till Skript2 i variabeln `$Script2Path.","Skript2") | Out-Null; return }
+    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("Filen hittades inte:\n$Script2Path","Skript2") | Out-Null; return }
+    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
+    switch ($ext) {
+        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
+        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
+        '.lnk' { Start-Process -FilePath $p }
+        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript2") | Out-Null } }
+    }
+})
+
+$miScript3.add_Click({
+    $p = $Script3Path
+    if ([string]::IsNullOrWhiteSpace($p)) { [System.Windows.Forms.MessageBox]::Show("...","Skript3") | Out-Null; return }
+    if (-not (Test-Path -LiteralPath $p)) { [System.Windows.Forms.MessageBox]::Show("...","Skript3") | Out-Null; return }
+    $ext=[System.IO.Path]::GetExtension($p).ToLowerInvariant()
+    switch ($ext) {
+        '.ps1' { Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$p`"" }
+        '.bat' { Start-Process cmd.exe -ArgumentList "/c `"$p`"" }
+        '.lnk' { Start-Process -FilePath $p }
+        default { try { Start-Process -FilePath $p } catch { [System.Windows.Forms.MessageBox]::Show("Kunde inte √∂ppna filen:","Skript3") | Out-Null } }
+    }
+})
+
+$miToggleSign.add_Click({
+    $lsp = $txtLSP.Text.Trim()
+    if (-not $lsp) {
+        Gui-Log "‚ö†Ô∏è Ange och s√∂k ett LSP f√∂rst innan du aktiverar Seal Test-signatur." 'Warn'
+        return
+    }
+    $selNeg = Get-CheckedFilePath $clbNeg
+    $selPos = Get-CheckedFilePath $clbPos
+    if (-not $selNeg -or -not $selPos) {
+        Gui-Log "‚ö†Ô∏è Du m√•ste f√∂rst v√§lja b√•de Seal Test NEG och POS innan Seal Test-signatur kan aktiveras." 'Warn'
+        return
+    }
+    $grpSign.Visible = -not $grpSign.Visible
+    if ($grpSign.Visible) {
+        $form.Height = $baseHeight + $grpSign.Height + 40
+        $miToggleSign.Text  = '‚ùå D√∂lj Seal Test-signatur'
+    }
+    else {
+        $form.Height = $baseHeight
+        $miToggleSign.Text  = '‚úÖ Aktivera Seal Test-signatur'
+    }
+})
+
+function Set-Theme {
+    param([string]$Theme)
+    if ($Theme -eq 'dark') {
+        $global:CurrentTheme = 'dark'
+        $form.BackColor        = [System.Drawing.Color]::FromArgb(35,35,35)
+        $content.BackColor     = $form.BackColor
+        $panelHeader.BackColor = [System.Drawing.Color]::DarkSlateBlue
+        $pLog.BackColor        = [System.Drawing.Color]::FromArgb(45,45,45)
+        $grpPick.BackColor     = $form.BackColor  
+        $grpSign.BackColor     = $form.BackColor
+        if ($grpSave) { $grpSave.BackColor = $form.BackColor }
+        $tlSearch.BackColor    = $form.BackColor
+        $outputBox.BackColor   = [System.Drawing.Color]::FromArgb(55,55,55)
+        $outputBox.ForeColor   = [System.Drawing.Color]::White
+        $lblLSP.ForeColor      = [System.Drawing.Color]::White
+        $lblCsv.ForeColor      = [System.Drawing.Color]::White
+        $lblNeg.ForeColor      = [System.Drawing.Color]::White
+        $lblPos.ForeColor      = [System.Drawing.Color]::White
+        if ($lblLsp) { $lblLsp.ForeColor = [System.Drawing.Color]::White }
+        $grpPick.ForeColor     = [System.Drawing.Color]::White
+        $grpSign.ForeColor     = [System.Drawing.Color]::White
+        if ($grpSave) { $grpSave.ForeColor = [System.Drawing.Color]::White }
+        $pLog.ForeColor        = [System.Drawing.Color]::White
+        $tlSearch.ForeColor    = [System.Drawing.Color]::White
+    } else {
+        $global:CurrentTheme = 'light'
+        $form.BackColor        = [System.Drawing.Color]::WhiteSmoke
+        $content.BackColor     = $form.BackColor
+        $panelHeader.BackColor = [System.Drawing.Color]::SteelBlue
+        $pLog.BackColor        = [System.Drawing.Color]::White
+        $grpPick.BackColor     = $form.BackColor
+        $grpSign.BackColor     = $form.BackColor
+        if ($grpSave) { $grpSave.BackColor = $form.BackColor }
+        $tlSearch.BackColor    = $form.BackColor
+        $outputBox.BackColor   = [System.Drawing.Color]::White
+        $outputBox.ForeColor   = [System.Drawing.Color]::Black
+        $lblLSP.ForeColor      = [System.Drawing.Color]::Black
+        $lblCsv.ForeColor      = [System.Drawing.Color]::Black
+        $lblNeg.ForeColor      = [System.Drawing.Color]::Black
+        $lblPos.ForeColor      = [System.Drawing.Color]::Black
+        if ($lblLsp) { $lblLsp.ForeColor = [System.Drawing.Color]::Black }
+        $grpPick.ForeColor     = [System.Drawing.Color]::Black
+        $grpSign.ForeColor     = [System.Drawing.Color]::Black
+        if ($grpSave) { $grpSave.ForeColor = [System.Drawing.Color]::Black }
+        $pLog.ForeColor        = [System.Drawing.Color]::Black
+        $tlSearch.ForeColor    = [System.Drawing.Color]::Black
+    }
+}
+
+$miLightTheme.add_Click({ Set-Theme 'light' })
+$miDarkTheme.add_Click({ Set-Theme 'dark' })
+
+# Instruktioner
+
+$miShowInstr.add_Click({
+    $msg = @"
+Snabbguide
+
+1. Skriv in ditt LSP och klicka "S√∂k Filer eller anv√§nd Bl√§ddra..."
+
+2. Klicka p√• "Skapa rapport"
+
+
+"@
+    [System.Windows.Forms.MessageBox]::Show($msg,"Instruktioner") | Out-Null
+})
+
+$miFAQ.add_Click({
+    $faq = @"
+Vad g√∂r skriptet?
+
+Det skapar en excel-rapport f√∂r s√∂kt LSP.
+
+Excelrapport √∂ppnas med f√∂ljande flikar:
+   ‚Ä¢ Information (generell)
+   ‚Ä¢ Seal Test Info
+   ‚Ä¢ STF Sum (och minusv√§rden -3 mg gr√§ns)
+   ‚Ä¢ Utrustninglista
+   ‚Ä¢ Kontrollmaterial
+   ‚Ä¢ SharePoint Info
+   ‚Ä¢ CSV-Summering
+
+"@
+    [System.Windows.Forms.MessageBox]::Show($faq,"Vanliga fr√•gor") | Out-Null
+})
+
+$miHelpDlg.add_Click({
+    $helpForm = New-Object System.Windows.Forms.Form
+    $helpForm.Text = 'Skicka meddelande'
+    $helpForm.Size = New-Object System.Drawing.Size(400,300)
+    $helpForm.StartPosition = 'CenterParent'
+    $helpForm.Font = $form.Font
+    $helpBox = New-Object System.Windows.Forms.TextBox
+    $helpBox.Multiline = $true
+    $helpBox.ScrollBars = 'Vertical'
+    $helpBox.Dock = 'Fill'
+    $helpBox.Font = New-Object System.Drawing.Font('Segoe UI',9)
+    $helpBox.Margin = New-Object System.Windows.Forms.Padding(10)
+    $panelButtons = New-Object System.Windows.Forms.FlowLayoutPanel
+    $panelButtons.Dock = 'Bottom'
+    $panelButtons.FlowDirection = 'RightToLeft'
+    $panelButtons.Padding = New-Object System.Windows.Forms.Padding(10)
+    $btnSend = New-Object System.Windows.Forms.Button
+    $btnSend.Text = 'Skicka'
+    $btnCancel = New-Object System.Windows.Forms.Button
+    $btnCancel.Text = 'Avbryt'
+    $panelButtons.Controls.Add($btnSend)
+    $panelButtons.Controls.Add($btnCancel)
+    $helpForm.Controls.Add($helpBox)
+    $helpForm.Controls.Add($panelButtons)
+    $btnSend.Add_Click({
+        $msg = $helpBox.Text.Trim()
+        if (-not $msg) { [System.Windows.Forms.MessageBox]::Show('Ange ett meddelande innan du skickar.','Hj√§lp') | Out-Null; return }
+        try {
+            $helpDir = (Get-ConfigValue -Name 'HelpFeedbackDir' -Default (Join-Path $PSScriptRoot 'help') -ConfigOverride $null)
+            if (-not (Test-Path -LiteralPath $helpDir)) { New-Item -ItemType Directory -Path $helpDir -Force | Out-Null }
+            $ts   = (Get-Date).ToString('yyyyMMdd_HHmmss')
+            $user = ($env:USERNAME + '').Trim()
+            if (-not $user) { $user = 'unknown' }
+            $file = Join-Path $helpDir ("help_{0}_{1}.txt" -f $user, $ts)
+
+            $body = @(
+                "User: $user"
+                "Computer: $($env:COMPUTERNAME)"
+                "Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
+                ''
+                $msg
+            ) -join "`r`n"
+             Set-Content -Path $file -Value $body -Encoding UTF8
+             [System.Windows.Forms.MessageBox]::Show('Meddelandet sparades. Tack!','Hj√§lp') | Out-Null
+             $helpForm.Close()
+         } catch {
+            [System.Windows.Forms.MessageBox]::Show("Kunde inte spara meddelandet:\n$($_.Exception.Message)",'Hj√§lp') | Out-Null
+        }
+    })
+    $btnCancel.Add_Click({ $helpForm.Close() })
+    $helpForm.ShowDialog() | Out-Null
+})
+
+# Om
+$miOm.add_Click({ [System.Windows.Forms.MessageBox]::Show("OBS! Detta √§r endast ett hj√§lpmedel och ers√§tter inte n√•gon IPT-process.`n $ScriptVersion`nav Jesper","Om") | Out-Null })
+
+$btnScan.Add_Click({
+    if (-not (Assert-StartupReady)) { return }
+
+    $lspInput = ($txtLSP.Text + '').Trim()
+    if (-not $lspInput) { Gui-Log "‚ö†Ô∏è Ange ett LSP-nummer" 'Warn'; return }
+
+    # Normalisera: anv√§nd endast siffrorna som nyckel (till√•t '#38401', 'LSP 38401' osv.)
+    $lsp = ($lspInput -replace '\D', '')
+    if (-not $lsp) { Gui-Log "‚ö†Ô∏è Ange ett giltigt LSP-nummer (siffror)" 'Warn'; return }
+
+    if ($script:BuildInProgress) { Gui-Log "‚ö†Ô∏è Rapportgenerering p√•g√•r ‚Äì v√§nta tills den √§r klar." 'Warn'; return }
+    if ($script:ScanInProgress)  { Gui-Log "‚ö†Ô∏è S√∂kning p√•g√•r redan ‚Äì v√§nta." 'Warn'; return }
+    $script:ScanInProgress = $true
+
+
+    Gui-Log -Text ("üîé S√∂ker filer f√∂r {0}‚Ä¶" -f $lsp) -Severity Info -Category USER -Immediate
+
+    try {
+        # √Öteranv√§nd cache om LSP + mapp fortfarande finns
+        if ($script:LastScanResult -and $script:LastScanResult.Lsp -eq $lsp -and
+            $script:LastScanResult.Folder -and (Test-Path -LiteralPath $script:LastScanResult.Folder)) {
+
+            Gui-Log -Text ("‚ôªÔ∏è √Öteranv√§nder senaste s√∂kresultatet f√∂r {0}." -f $lsp) -Severity Info -Category USER
+            Add-CLBItems -clb $clbCsv -files $script:LastScanResult.Csv -AutoCheckFirst
+            Add-CLBItems -clb $clbNeg -files $script:LastScanResult.Neg -AutoCheckFirst
+            Add-CLBItems -clb $clbPos -files $script:LastScanResult.Pos -AutoCheckFirst
+            Add-CLBItems -clb $clbLsp -files $script:LastScanResult.LspFiles -AutoCheckFirst
+            Update-BuildEnabled
+            Update-BatchLink
+            return
+        }
+       
+$folder = Find-LspFolder -Lsp $lsp -Roots $RootPaths
+if (-not $folder) {
+    Gui-Log "‚ùå Ingen LSP-mapp hittad f√∂r $lsp" 'Warn'
+    if ($env:IPT_ROOT) { Gui-Log "‚ÑπÔ∏è IPT_ROOT=$($env:IPT_ROOT)" 'Info' 'DEBUG' }
+    $rootInfo = $RootPaths | ForEach-Object { "{0} ({1})" -f $_, $(if (Test-Path -LiteralPath $_) { "OK" } else { "MISSING" }) }
+    Gui-Log -Text ("S√∂kv√§gar som provats: " + ($rootInfo -join " | ")) -Severity Info -Category USER
+    return
+}
+
+if (-not (Test-Path -LiteralPath $folder.FullName)) {
+    Gui-Log "‚ùå LSP-mappen hittades men finns inte l√§ngre: $($folder.FullName)" 'Warn'
+    $rootInfo = $RootPaths | ForEach-Object { "{0} ({1})" -f $_, $(if (Test-Path -LiteralPath $_) { "OK" } else { "MISSING" }) }
+    Gui-Log -Text ("S√∂kv√§gar som provats: " + ($rootInfo -join " | ")) -Severity Info -Category USER
+    return
+}
+        Gui-Log -Text ("üìÇ Hittad mapp: {0}" -f $folder.FullName) -Severity Info -Category USER
+
+        # Plocka filer EN g√•ng
+        $files = Get-ChildItem -LiteralPath $folder.FullName -File -ErrorAction SilentlyContinue
+
+        $candCsv = $files | Where-Object { $_.Extension -ieq '.csv' -and ( $_.Name -match [regex]::Escape($lsp) -or $_.Length -gt 100kb ) } | Sort-Object LastWriteTime -Descending
+        $candNeg = $files | Where-Object { $_.Name -match '(?i)Neg.*\.xls[xm]$' -and $_.Name -match [regex]::Escape($lsp) } | Sort-Object LastWriteTime -Descending
+        $candPos = $files | Where-Object { $_.Name -match '(?i)Pos.*\.xls[xm]$' -and $_.Name -match [regex]::Escape($lsp) } | Sort-Object LastWriteTime -Descending
+        $candLsp = $files | Where-Object {
+            ($_.Name -match '(?i)worksheet') -and ($_.Name -match [regex]::Escape($lsp)) -and ($_.Extension -match '^(\.xlsx|\.xlsm|\.xls)$')
+        } | Sort-Object LastWriteTime -Descending
+
+        Add-CLBItems -clb $clbCsv -files $candCsv -AutoCheckFirst
+        Add-CLBItems -clb $clbNeg -files $candNeg -AutoCheckFirst
+        Add-CLBItems -clb $clbPos -files $candPos -AutoCheckFirst
+        Add-CLBItems -clb $clbLsp -files $candLsp -AutoCheckFirst
+
+        if ($candCsv.Count -eq 0) { Gui-Log "‚ÑπÔ∏è Ingen CSV hittad (endast .csv visas)." 'Info' }
+        if ($candNeg.Count -eq 0) { Gui-Log "‚ö†Ô∏è Ingen Seal NEG hittad." 'Warn' }
+        if ($candPos.Count -eq 0) { Gui-Log "‚ö†Ô∏è Ingen Seal POS hittad." 'Warn' }
+        if ($candLsp.Count -eq 0) { Gui-Log "‚ÑπÔ∏è Ingen LSP Worksheet hittad." 'Info' }
+
+        Update-BuildEnabled
+        Update-BatchLink
+
+        # Cachea FileInfo-objekt
+        $script:LastScanResult = [pscustomobject]@{
+            Lsp      = $lsp
+            Folder   = $folder.FullName
+            Csv      = @($candCsv)
+            Neg      = @($candNeg)
+            Pos      = @($candPos)
+            LspFiles = @($candLsp)
+        }
+
+        Gui-Log -Text "‚úÖ Filer laddade." -Severity Info -Category USER
+    }
+    catch {
+        Gui-Log ("‚ùå Fils√∂kning misslyckades: " + $_.Exception.Message) 'Error'
+    }
+    finally {
+        $script:ScanInProgress = $false
+    }
+})
+
+$btnCsvBrowse.Add_Click({
+        $dlg = $null
+    try {
+        $dlg = New-Object System.Windows.Forms.OpenFileDialog
+        $dlg.Filter = "CSV|*.csv|Alla filer|*.*"
+        if ($dlg.ShowDialog() -eq 'OK') {
+            $f = Get-Item -LiteralPath $dlg.FileName
+            Add-CLBItems -clb $clbCsv -files @($f) -AutoCheckFirst
+            Update-BuildEnabled
+            Update-BatchLink
+        }
+    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
+})
+
+$btnNegBrowse.Add_Click({
+        $dlg = $null
+    try {
+        $dlg = New-Object System.Windows.Forms.OpenFileDialog
+        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
+        if ($dlg.ShowDialog() -eq 'OK') {
+            $f = Get-Item -LiteralPath $dlg.FileName
+            Add-CLBItems -clb $clbNeg -files @($f) -AutoCheckFirst
+            Update-BuildEnabled
+            Update-BatchLink
+        }
+    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
+})
+
+$btnPosBrowse.Add_Click({
+        $dlg = $null
+    try {
+        $dlg = New-Object System.Windows.Forms.OpenFileDialog
+        $dlg.Filter = "Excel|*.xlsx;*.xlsm|Alla filer|*.*"
+        if ($dlg.ShowDialog() -eq 'OK') {
+            $f = Get-Item -LiteralPath $dlg.FileName
+            Add-CLBItems -clb $clbPos -files @($f) -AutoCheckFirst
+            Update-BuildEnabled
+            Update-BatchLink
+        }
+    } finally { if ($dlg) { try { $dlg.Dispose() } catch {} } }
+})
+
+
+
+if (-not (Get-Command Write-SPSheet-Safe -ErrorAction SilentlyContinue)) {
+    function Write-SPSheet-Safe {
+        param(
+            [OfficeOpenXml.ExcelPackage]$Pkg,
+            [object]$Rows,                    
+            [string[]]$DesiredOrder,            
+            [string]$Batch
+        )
+        if (-not $Pkg) { return $false }
+        $Rows = @($Rows)
+        $name = "SharePoint Info"
+        $wsOld = $Pkg.Workbook.Worksheets[$name]
+        if ($wsOld) { $Pkg.Workbook.Worksheets.Delete($wsOld) }
+        $ws = $Pkg.Workbook.Worksheets.Add($name)
+
+        # ==========================================
+        # Harmoniserade f√§rger (matchar CSV Sammanfattning)
+        # ==========================================
+        $HeaderBg   = [System.Drawing.Color]::FromArgb(68, 84, 106)    # M√∂rkbl√• (#44546A)
+        $HeaderFg   = [System.Drawing.Color]::White
+        $SectionBg  = [System.Drawing.Color]::FromArgb(217, 225, 242)  # Ljusbl√• (#D9E1F2)
+        $SectionFg  = [System.Drawing.Color]::FromArgb(0, 32, 96)      # M√∂rkbl√• text
+        $ValueBg    = [System.Drawing.Color]::White
+        $BorderColor = [System.Drawing.Color]::FromArgb(68, 84, 106)   # M√∂rkbl√• border
+
+        if ($Rows.Count -eq 0 -or $Rows[0] -eq $null) {
+            # Tom data - visa meddelande med harmoniserad stil
+            $ws.Cells[1,1].Value = "SharePoint Info"
+            $ws.Cells["A1:B1"].Merge = $true
+            $ws.Cells["A1"].Style.Font.Bold = $true
+            $ws.Cells["A1"].Style.Font.Size = 14
+            $ws.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
+            $ws.Cells["A1"].Style.Fill.PatternType = "Solid"
+            $ws.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
+            $ws.Cells["A1"].Style.HorizontalAlignment = "Left"
+            $ws.Cells[2,1].Value = "Batch"
+            $ws.Cells[2,2].Value = $Batch
+            $ws.Cells[3,1].Value = "Status"
+            $ws.Cells[3,2].Value = "Ingen data hittad"
+            $ws.Cells["A2:A3"].Style.Fill.PatternType = "Solid"
+            $ws.Cells["A2:A3"].Style.Fill.BackgroundColor.SetColor($SectionBg)
+            $ws.Cells["A2:A3"].Style.Font.Bold = $true
+            return $true
+        }
+        $isKV = ($Rows[0].psobject.Properties.Name -contains 'Rubrik') -and `
+                ($Rows[0].psobject.Properties.Name -contains 'V√§rde')
+        if ($isKV) {
+            # ==========================================
+            # RUBRIK-V√ÑRDE FORMAT (Harmoniserad layout)
+            # ==========================================
+            
+            # Huvudrubrik (rad 1) - m√∂rkbl√• bakgrund
+            $ws.Cells[1,1].Value = "SharePoint Info"
+            $ws.Cells[1,2].Value = ""
+            $ws.Cells["A1:B1"].Merge = $true
+            $ws.Cells["A1"].Style.Font.Bold = $true
+            $ws.Cells["A1"].Style.Font.Size = 14
+            $ws.Cells["A1"].Style.Font.Name = "Arial"
+            $ws.Cells["A1"].Style.Font.Color.SetColor($HeaderFg)
+            $ws.Cells["A1"].Style.Fill.PatternType = "Solid"
+            $ws.Cells["A1"].Style.Fill.BackgroundColor.SetColor($HeaderBg)
+            $ws.Cells["A1"].Style.HorizontalAlignment = "Left"
+            $ws.Cells["A1"].Style.VerticalAlignment   = "Center"
+            $ws.Row(1).Height = 22
+
+            # Datarader b√∂rjar p√• rad 2
+            $r = 2
+            foreach ($row in $Rows) {
+                $ws.Cells[$r,1].Value = $row.Rubrik
+                $ws.Cells[$r,2].Value = $row.'V√§rde'
+                $r++
+            }
+            $lastRow = $r-1
+
+            # Styling f√∂r rubrik-kolumnen (A) - ljusbl√• bakgrund
+            $labelRange = $ws.Cells["A2:A$lastRow"]
+            $labelRange.Style.Font.Bold = $true
+            $labelRange.Style.Font.Name = "Arial"
+            $labelRange.Style.Font.Size = 10
+            $labelRange.Style.Font.Color.SetColor($SectionFg)
+            $labelRange.Style.Fill.PatternType = "Solid"
+            $labelRange.Style.Fill.BackgroundColor.SetColor($SectionBg)
+            $labelRange.Style.HorizontalAlignment = "Left"
+            $labelRange.Style.VerticalAlignment   = "Center"
+
+            # Styling f√∂r v√§rde-kolumnen (B) - vit bakgrund
+            $valueRange = $ws.Cells["B2:B$lastRow"]
+            $valueRange.Style.Font.Name = "Arial"
+            $valueRange.Style.Font.Size = 10
+            $valueRange.Style.Fill.PatternType = "Solid"
+            $valueRange.Style.Fill.BackgroundColor.SetColor($ValueBg)
+            $valueRange.Style.HorizontalAlignment = "Left"
+            $valueRange.Style.VerticalAlignment   = "Center"
+
+            # Borders f√∂r hela tabellen
+            $rng = $ws.Cells["A1:B$lastRow"]
+            $rng.Style.Border.Top.Style    = "Thin"
+            $rng.Style.Border.Bottom.Style = "Thin"
+            $rng.Style.Border.Left.Style   = "Thin"
+            $rng.Style.Border.Right.Style  = "Thin"
+            $rng.Style.Border.Top.Color.SetColor($BorderColor)
+            $rng.Style.Border.Bottom.Color.SetColor($BorderColor)
+            $rng.Style.Border.Left.Color.SetColor($BorderColor)
+            $rng.Style.Border.Right.Color.SetColor($BorderColor)
+
+            # Yttre ram - tjockare
+            $rng.Style.Border.BorderAround([OfficeOpenXml.Style.ExcelBorderStyle]::Medium, $BorderColor)
+
+            # Kolumnbredder
+            $ws.Column(1).Width = 35
+            $ws.Column(2).Width = 50
+
+            # AutoFit f√∂r b√§ttre anpassning
+            try {
+                if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
+                    Safe-AutoFitColumns -Ws $ws -Context 'SharePointInfo'
+                } else {
+                    $ws.Cells[$ws.Dimension.Address].AutoFitColumns() | Out-Null
+                }
+                # S√§kerst√§ll minsta bredd
+                if ($ws.Column(1).Width -lt 30) { $ws.Column(1).Width = 30 }
+                if ($ws.Column(2).Width -lt 40) { $ws.Column(2).Width = 40 }
+            } catch {}
+        }
+        else {
+            # ==========================================
+            # TABELL-FORMAT (flera kolumner)
+            # ==========================================
+            $cols = @()
+            if ($DesiredOrder) { $cols += $DesiredOrder }
+            foreach ($k in $Rows[0].psobject.Properties.Name) {
+                if ($cols -notcontains $k) { $cols += $k }
+            }
+
+            # Header-rad
+            for ($c=0; $c -lt $cols.Count; $c++) {
+                $ws.Cells[1,$c+1].Value = $cols[$c]
+            }
+            $headerRange = $ws.Cells[1,1,1,$cols.Count]
+            $headerRange.Style.Font.Bold = $true
+            $headerRange.Style.Font.Name = "Arial"
+            $headerRange.Style.Font.Size = 10
+            $headerRange.Style.Font.Color.SetColor($HeaderFg)
+            $headerRange.Style.Fill.PatternType = "Solid"
+            $headerRange.Style.Fill.BackgroundColor.SetColor($HeaderBg)
+            $headerRange.Style.HorizontalAlignment = "Left"
+
+            # Datarader
+            $r = 2
+            foreach ($row in $Rows) {
+                for ($c=0; $c -lt $cols.Count; $c++) {
+                    $ws.Cells[$r,$c+1].Value = $row.$($cols[$c])
+                }
+                $r++
+            }
+            $lastRow = $r-1
+
+            # Styling f√∂r datarader
+            if ($lastRow -ge 2) {
+                $dataRange = $ws.Cells[2,1,$lastRow,$cols.Count]
+                $dataRange.Style.Font.Name = "Arial"
+                $dataRange.Style.Font.Size = 10
+
+                # Borders
+                $fullRange = $ws.Cells[1,1,$lastRow,$cols.Count]
+                $fullRange.Style.Border.Top.Style    = "Thin"
+                $fullRange.Style.Border.Bottom.Style = "Thin"
+                $fullRange.Style.Border.Left.Style   = "Thin"
+                $fullRange.Style.Border.Right.Style  = "Thin"
+                $fullRange.Style.Border.Top.Color.SetColor($BorderColor)
+                $fullRange.Style.Border.Bottom.Color.SetColor($BorderColor)
+                $fullRange.Style.Border.Left.Color.SetColor($BorderColor)
+                $fullRange.Style.Border.Right.Color.SetColor($BorderColor)
+            }
+
+            try {
+                if ($ws.Dimension) {
+                    $maxR = [Math]::Min($ws.Dimension.End.Row, 2000)
+                    $rAF = $ws.Cells[$ws.Dimension.Start.Row,$ws.Dimension.Start.Column,$maxR,$ws.Dimension.End.Column]
+                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
+                        Safe-AutoFitColumns -Ws $ws -Range $rAF -Context 'TableSheet'
+                    } else {
+                        $rAF.AutoFitColumns() | Out-Null
+                    }
+                }
+            } catch {}
+        }
+        return $true
+    }
+}
+
+# --- Write SharePoint Info block into 'Information' sheet (no separate worksheet) ---
+if (-not (Get-Command Write-SPBlockIntoInformation -ErrorAction SilentlyContinue)) {
+    function Write-SPBlockIntoInformation {
+        param(
+            [Parameter(Mandatory)][OfficeOpenXml.ExcelPackage]$Pkg,
+            [Parameter()][object[]]$Rows,
+            [Parameter()][string]$Batch,
+            [Parameter()][string]$TargetSheetName = 'Information',
+            [Parameter()][int]$StartRow = 1,
+            [Parameter()][int]$StartCol = 5  # E = 5
+        )
+
+        if (-not $Pkg) { return $false }
+        $Rows = @($Rows)
+
+        $ws = $Pkg.Workbook.Worksheets[$TargetSheetName]
+        if (-not $ws) { return $false }
+
+        $labelCol = $StartCol
+        $valueCol = $StartCol + 1
+
+        # Harmoniserade f√§rger (matchar CSV Sammanfattning)
+        $HeaderBg   = [System.Drawing.Color]::FromArgb(68, 84, 106)    # M√∂rkbl√•
+        $HeaderFg   = [System.Drawing.Color]::White
+        $SectionBg  = [System.Drawing.Color]::FromArgb(217, 225, 242)  # Ljusbl√•
+        $SectionFg  = [System.Drawing.Color]::FromArgb(0, 32, 96)      # M√∂rkbl√• text
+        $BorderColor = [System.Drawing.Color]::FromArgb(68, 84, 106)
+
+        # Rensa tidigare block (bara i block-ytan, p√•verkar inte A-D)
+        try {
+            $clearRows = 120
+            $rngClear = $ws.Cells[$StartRow, $labelCol, ($StartRow + $clearRows - 1), $valueCol]
+            $rngClear.Clear()
+        } catch {}
+
+        # Huvudrubrik
+        $ws.Cells[$StartRow, $labelCol].Value = "SharePoint Info"
+        $ws.Cells[$StartRow, $valueCol].Value = ""
+        $ws.Cells[$StartRow, $labelCol, $StartRow, $valueCol].Merge = $true
+        $ws.Cells[$StartRow, $labelCol].Style.Font.Bold = $true
+        $ws.Cells[$StartRow, $labelCol].Style.Font.Size = 14
+        $ws.Cells[$StartRow, $labelCol].Style.Font.Name = "Arial"
+        $ws.Cells[$StartRow, $labelCol].Style.Font.Color.SetColor($HeaderFg)
+        $ws.Cells[$StartRow, $labelCol].Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+        $ws.Cells[$StartRow, $labelCol].Style.Fill.BackgroundColor.SetColor($HeaderBg)
+        $ws.Cells[$StartRow, $labelCol].Style.HorizontalAlignment = [OfficeOpenXml.Style.ExcelHorizontalAlignment]::Left
+        $ws.Cells[$StartRow, $labelCol].Style.VerticalAlignment   = [OfficeOpenXml.Style.ExcelVerticalAlignment]::Center
+        $ws.Row($StartRow).Height = 22
+
+        $r = $StartRow + 1
+
+        if (-not $Rows -or $Rows.Count -eq 0 -or $Rows[0] -eq $null) {
+            # Tom data
+            $ws.Cells[$r, $labelCol].Value = "Batch"
+            $ws.Cells[$r, $valueCol].Value = $Batch
+            $r++
+            $ws.Cells[$r, $labelCol].Value = "Status"
+            $ws.Cells[$r, $valueCol].Value = "Ingen data hittad"
+            $lastRow = $r
+        } else {
+            foreach ($row in $Rows) {
+                $ws.Cells[$r, $labelCol].Value = $row.Rubrik
+                $ws.Cells[$r, $valueCol].Value = $row.'V√§rde'
+                $r++
+            }
+            $lastRow = $r - 1
+        }
+
+        # Styling rubrik-kolumn
+        try {
+            $labelRange = $ws.Cells[($StartRow + 1), $labelCol, $lastRow, $labelCol]
+            $labelRange.Style.Font.Bold = $true
+            $labelRange.Style.Font.Name = "Arial"
+            $labelRange.Style.Font.Size = 10
+            $labelRange.Style.Font.Color.SetColor($SectionFg)
+            $labelRange.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+            $labelRange.Style.Fill.BackgroundColor.SetColor($SectionBg)
+
+            # Styling v√§rde-kolumn
+            $valueRange = $ws.Cells[($StartRow + 1), $valueCol, $lastRow, $valueCol]
+            $valueRange.Style.Font.Name = "Arial"
+            $valueRange.Style.Font.Size = 10
+            $valueRange.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+            $valueRange.Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::White)
+
+            # Borders kring block
+            $rng = $ws.Cells[$StartRow, $labelCol, $lastRow, $valueCol]
+            $rng.Style.Border.Top.Style    = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+            $rng.Style.Border.Bottom.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+            $rng.Style.Border.Left.Style   = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+            $rng.Style.Border.Right.Style  = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+            $rng.Style.Border.Top.Color.SetColor($BorderColor)
+            $rng.Style.Border.Bottom.Color.SetColor($BorderColor)
+            $rng.Style.Border.Left.Color.SetColor($BorderColor)
+            $rng.Style.Border.Right.Color.SetColor($BorderColor)
+        } catch {}
+
+        # Kolumnbredd (endast block-kolumnerna)
+        try { $ws.Column($labelCol).Width = 30 } catch {}
+        try { $ws.Column($valueCol).Width = 40 } catch {}
+
+        return $true
+    }
+}
+
+‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ
+
+# ============================
+# ===== RAPPORTLOGIK =========
+# ============================
+        
+$btnBuild.Add_Click({
+    if (-not (Assert-StartupReady)) { return }
+
+    if ($script:ScanInProgress) { Gui-Log "‚ö†Ô∏è S√∂kning p√•g√•r ‚Äì v√§nta innan du skapar rapport." 'Warn'; return }
+    if ($script:BuildInProgress) { Gui-Log "‚ö†Ô∏è Rapportgenerering k√∂r redan ‚Äì v√§nta." 'Warn'; return }
+    $script:BuildInProgress = $true
+
+    Gui-Log -Text 'üîÉ Skapar rapport‚Ä¶' -Severity Info -Category USER -Immediate
+    Set-UiBusy -Busy $true -Message 'Skapar rapport‚Ä¶'
+    Set-UiStep 5 'Initierar‚Ä¶'
+
+    $pkgNeg = $null
+    $pkgPos = $null
+    $pkgOut = $null
+
+    # RuleEngine caches (per-k√∂rning)
+    $script:RuleEngineShadow  = $null
+    $script:RuleEngineCsvObjs = $null
+    $script:RuleBankCache     = $null
+
+    try {
+        if (-not (Load-EPPlus)) { Gui-Log "‚ùå EPPlus kunde inte laddas ‚Äì avbryter." 'Error'; return }
+
+        Set-UiStep 10 'L√§ser in Seal Test-filer‚Ä¶'
+
+        $selCsv = Get-CheckedFilePath $clbCsv
+        $selNeg = Get-CheckedFilePath $clbNeg
+        $selPos = Get-CheckedFilePath $clbPos
+
+        if (-not $selNeg -or -not $selPos) { Gui-Log "‚ùå Du m√•ste v√§lja en Seal NEG och en Seal POS." 'Error'; return }
+
+        $lspRaw    = ($txtLSP.Text + '').Trim()
+        $lspDigits = ($lspRaw -replace '\D','')
+        $hasLsp    = -not [string]::IsNullOrWhiteSpace($lspDigits)
+
+        if ($hasLsp) {
+            $lsp = $lspDigits
+        } else {
+            $lsp = 'MANUELL'
+            Gui-Log "‚ÑπÔ∏è Ingen LSP angiven ‚Äì k√∂r manuellt l√§ge (filval via Bl√§ddra). Rapporten m√§rks som '$lsp' och SharePoint/LSP-koppling hoppas √∂ver." 'Warn'
+        }
+
+        $lspForLinks = if ($hasLsp) { $lsp } else { '' }
+
+        # ---- Local staging for network files (N:\ or UNC) ----
+        $stageDir = $null
+        $enableStaging = Get-ConfigFlag -Name 'EnableLocalStaging' -Default $true -ConfigOverride $Config
+        if ($enableStaging) {
+            try {
+                $stageDir = Join-Path ([IO.Path]::GetTempPath()) ("QC_Stage_" + $lsp + "_" + (Get-Date -Format 'yyyyMMdd_HHmmss'))
+                New-Item -ItemType Directory -Path $stageDir -Force | Out-Null
+
+                $selNeg = Stage-InputFile -Path $selNeg -StageDir $stageDir
+                $selPos = Stage-InputFile -Path $selPos -StageDir $stageDir
+                if ($selCsv) { $selCsv = Stage-InputFile -Path $selCsv -StageDir $stageDir }
+            } catch {
+            }
+        }
+
+        Gui-Log "üìÑ Neg-fil: $(Split-Path $selNeg -Leaf)" 'Info'
+        Gui-Log "üìÑ Pos-fil: $(Split-Path $selPos -Leaf)" 'Info'
+        if ($selCsv) { Gui-Log "üìÑ CSV: $(Split-Path $selCsv -Leaf)" 'Info' } else { Gui-Log "‚ÑπÔ∏è Ingen CSV vald." 'Info' }
+
+        $negWritable = $true; $posWritable = $true
+        if ($chkWriteSign.Checked) {
+            $negWritable = -not (Test-FileLocked $selNeg); if (-not $negWritable) { Gui-Log "üîí NEG √§r l√•st (√∂ppen i Excel?)." 'Warn' }
+            $posWritable = -not (Test-FileLocked $selPos); if (-not $posWritable) { Gui-Log "üîí POS √§r l√•st (√∂ppen i Excel?)." 'Warn' }
+        }
+
+        # ----------------------------
+        # Open packages
+        # ----------------------------
+        try {
+            $pkgNeg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selNeg))
+            $pkgPos = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selPos))
+        } catch {
+            Gui-Log "‚ùå Kunde inte √∂ppna NEG/POS: $($_.Exception.Message)" 'Error'
+            return
+        }
+
+        $templatePath = Join-Path $PSScriptRoot "output_template-v4.xlsx"
+        if (-not (Test-Path -LiteralPath $templatePath)) { Gui-Log "‚ùå Mallfilen 'output_template-v4.xlsx' saknas!" 'Error'; return }
+        try {
+            $pkgOut = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($templatePath))
+        } catch {
+            Gui-Log "‚ùå Kunde inte l√§sa mall: $($_.Exception.Message)" 'Error'
+            return
+        }
+
+        # ============================
+        # === SIGNATUR I NEG/POS  ====
+        # ============================
+
+        $signToWrite = ($txtSigner.Text + '').Trim()
+        if ($chkWriteSign.Checked) {
+            if (-not $signToWrite) { Gui-Log "‚ùå Ingen signatur angiven (B47). Avbryter."; return }
+            if (-not (Confirm-SignatureInput -Text $signToWrite)) { Gui-Log "üõë Signatur ej bekr√§ftad. Avbryter."; return }
+
+            $negWritten = 0; $posWritten = 0; $negSkipped = 0; $posSkipped = 0
+
+            foreach ($ws in $pkgNeg.Workbook.Worksheets) {
+                if ($ws.Name -eq 'Worksheet Instructions') { continue }
+                $h3 = ($ws.Cells['H3'].Text + '').Trim()
+
+                if ($h3 -match '^[0-9]') {
+                    $existing = ($ws.Cells[$Layout.SignatureCell].Text + '').Trim()
+                    if ($existing -and -not $chkOverwriteSign.Checked) { $negSkipped++; continue }
+                    $ws.Cells[$Layout.SignatureCell].Style.Numberformat.Format = '@'
+                    $ws.Cells[$Layout.SignatureCell].Value = $signToWrite
+                    $negWritten++
+                }
+                elseif ([string]::IsNullOrWhiteSpace($h3) -or $h3 -match '^(?i)(N\/\?A|NA|Tomt( inneh√•ll)?)$') {
+                    break
+                }
+            }
+
+            foreach ($ws in $pkgPos.Workbook.Worksheets) {
+                if ($ws.Name -eq 'Worksheet Instructions') { continue }
+                $h3 = ($ws.Cells['H3'].Text + '').Trim()
+
+                if ($h3 -match '^[0-9]') {
+                    $existing = ($ws.Cells[$Layout.SignatureCell].Text + '').Trim()
+                    if ($existing -and -not $chkOverwriteSign.Checked) { $posSkipped++; continue }
+                    $ws.Cells[$Layout.SignatureCell].Style.Numberformat.Format = '@'
+                    $ws.Cells[$Layout.SignatureCell].Value = $signToWrite
+                    $posWritten++
+                }
+                elseif ([string]::IsNullOrWhiteSpace($h3) -or $h3 -match '^(?i)(N\/\?A|NA|Tomt( inneh√•ll)?)$') {
+                    break
+                }
+            }
+
+            try {
+                if ($negWritten -eq 0 -and $negSkipped -eq 0 -and $posWritten -eq 0 -and $posSkipped -eq 0) {
+                    Gui-Log "‚ÑπÔ∏è Inga databladsflikar efter flik 1 att s√§tta signatur i (ingen √•tg√§rd)."
+                } else {
+                    if ($negWritten -gt 0 -and $negWritable) { $pkgNeg.Save() } elseif ($negWritten -gt 0) { Gui-Log "üîí Kunde inte spara NEG (l√•st)." 'Warn' }
+                    if ($posWritten -gt 0 -and $posWritable) { $pkgPos.Save() } elseif ($posWritten -gt 0) { Gui-Log "üîí Kunde inte spara POS (l√•st)." 'Warn' }
+                    Gui-Log "üñäÔ∏è Signatur satt: NEG $negWritten blad (√∂verhoppade $negSkipped), POS $posWritten blad (√∂verhoppade $posSkipped)."
+                }
+            } catch {
+                Gui-Log "‚ö†Ô∏è Kunde inte spara signatur i NEG/POS: $($_.Exception.Message)" 'Warn'
+            }
+        }
+
+        # ============================
+        # === CSV (Info/Control)  ====
+        # ============================
+
+        $csvRows = @()
+        $runAssay = $null
+
+        if ($selCsv) {
+            try {
+                $csvInfo = Get-Item -LiteralPath $selCsv -ErrorAction Stop
+                $thresholdMb = 25
+                try {
+                    if ($Config -and ($Config -is [System.Collections.IDictionary]) -and $Config.Contains('CsvStreamingThresholdMB')) {
+                        $thresholdMb = [int]$Config['CsvStreamingThresholdMB']
+                    }
+                } catch {}
+
+                $useStreaming = ($csvInfo.Length -ge ($thresholdMb * 1MB))
+                if ($useStreaming) {
+                    Gui-Log ("‚è≥ CSV √§r stor ({0:N1} MB) ‚Äì anv√§nder streaming-import‚Ä¶" -f ($csvInfo.Length / 1MB)) 'Info'
+                    Set-UiStep 35 "L√§ser CSV (streaming)‚Ä¶"
+                    $list = New-Object System.Collections.Generic.List[object]
+                    Import-CsvRowsStreaming -Path $selCsv -StartRow 10 -ProcessRow {
+                        param($Fields,$RowIndex)
+                        [void]$list.Add($Fields)
+                        if (($RowIndex % 2000) -eq 0) { Invoke-UiPump }
+                    }
+                    $csvRows = @($list.ToArray())
+                } else {
+                    Set-UiStep 35 "L√§ser CSV‚Ä¶"
+                    $csvRows = Import-CsvRows -Path $selCsv -StartRow 10
+                }
+
+                # --- Robusthet: Sortera p√• kolumn C (Sample ID) innan vidare bearbetning.
+                # M√•nga downstream-steg (gruppering/skrivning) f√∂ruts√§tter att raderna √§r konsekvent sorterade.
+                try {
+                    if ($csvRows -and $csvRows.Count -gt 1) {
+                        if ($csvRows[0] -is [object[]]) {
+                            # Import-CsvRows* returnerar f√§lt-arrayer: kolumn C = index 2
+                            $csvRows = @($csvRows | Sort-Object { [string]($_[2]) })
+                        } else {
+                            # Om vi i framtiden f√•r PSCustomObject-rader
+                            $csvRows = @($csvRows | Sort-Object { [string]($_.'Sample ID') })
+                        }
+                        Gui-Log ("üîÉ CSV sorterad p√• kolumn C (Sample ID). Rader: {0}" -f $csvRows.Count) 'Info'
+                    }
+                } catch {
+                    Gui-Log "‚ö†Ô∏è Kunde inte sortera CSV p√• kolumn C (Sample ID)." 'Warn'
+                }
+            } catch {
+                Gui-Log "‚ö†Ô∏è CSV-import misslyckades: $($_.Exception.Message)" 'Warn'
+                $csvRows = @()
+            }
+            try { $runAssay = Get-AssayFromCsv -Path $selCsv -StartRow 10 } catch {}
+            if ($runAssay) { Gui-Log "üîé Assay fr√•n CSV: $runAssay" }
+        }
+
+        # ============================
+        # === RuleEngine (shadow)  ===
+        # ============================
+        try {
+            if ((Get-ConfigFlag -Name 'EnableRuleEngine' -Default $false -ConfigOverride $Config) -and
+                $selCsv -and (Test-Path -LiteralPath $selCsv)) {
+
+                # Load rulebank once
+                $rb = Load-RuleBank -RuleBankDir $Config.RuleBankDir
+                try { $rb = Compile-RuleBank -RuleBank $rb } catch {}
+                $script:RuleBankCache = $rb
+
+                # Build csvObjs once (prefer Import-CsvRows, else raw fallback)
+                $csvObjs = @()
+                if ($csvRows -and $csvRows.Count -gt 0) {
+                    $csvObjs = @($csvRows)
+                    Gui-Log ("üß† Regelbank: CSV-k√§lla: Import-CsvRows ({0})" -f $csvObjs.Count) 'Info'
+                } else {
+                    try {
+                        $all = Get-Content -LiteralPath $selCsv
+                        if ($all -and $all.Count -gt 9) {
+                            $del = Get-CsvDelimiter -Path $selCsv
+                            $hdr = ConvertTo-CsvFields $all[7]
+                            $dl  = $all[9..($all.Count-1)] | Where-Object { $_ -and $_.Trim() }
+                            $csvObjs = @(ConvertFrom-Csv -InputObject ($dl -join "`n") -Delimiter $del -Header $hdr)
+                        }
+                    } catch {
+                        $csvObjs = @()
+                    }
+                    Gui-Log ("üß† Regelbank: CSV-k√§lla: Fallback-raw ({0})" -f ($csvObjs.Count)) 'Info'
+                }
+
+                $script:RuleEngineCsvObjs = $csvObjs
+
+                if (-not $csvObjs -or $csvObjs.Count -eq 0) {
+                    Gui-Log "‚ö†Ô∏è RuleEngine (shadow): CSV-objekt saknas (0 rader) ‚Äì hoppar √∂ver." 'Warn'
+                    $script:RuleEngineShadow = $null
+                } else {
+                    $re = Invoke-RuleEngine -CsvObjects $csvObjs -RuleBank $rb -CsvPath $selCsv
+                    $script:RuleEngineShadow = $re
+
+                    if ($re -and $re.Summary) {
+                        $pairs = @()
+                        foreach ($k in $re.Summary.ObservedCounts.Keys) { $pairs += ("$k=$($re.Summary.ObservedCounts[$k])") }
+                        if ($pairs.Count -gt 0) { Gui-Log -Text ("üß† Regelbank: ObservedCall counts: " + ($pairs -join ', ')) -Severity Info -Category RuleEngineStats }
+
+                        $dpairs = @()
+                        foreach ($k2 in $re.Summary.DeviationCounts.Keys) { $dpairs += ("$k2=$($re.Summary.DeviationCounts[$k2])") }
+                        if ($dpairs.Count -gt 0) { Gui-Log -Text ("üß† Regelbank: Deviations: " + ($dpairs -join ', ')) -Severity Info -Category RuleEngineStats }
+
+                        if ($re.Summary.RetestYes -gt 0) { Gui-Log -Text ("üß† Regelbank: Retest=YES count: " + $re.Summary.RetestYes) -Severity Info -Category RuleEngineStats }
+
+                        # Single user-facing summary line
+                        if (Get-ConfigFlag -Name 'EnableRuleEngineSummaryLog' -Default $false -ConfigOverride $Config) {
+                            try {
+                                $pos = 0; $neg = 0; $err = 0
+                                if ($re.Summary.ObservedCounts) {
+                                    if ($re.Summary.ObservedCounts.ContainsKey('POS'))   { $pos = [int]$re.Summary.ObservedCounts['POS'] }
+                                    if ($re.Summary.ObservedCounts.ContainsKey('NEG'))   { $neg = [int]$re.Summary.ObservedCounts['NEG'] }
+                                    if ($re.Summary.ObservedCounts.ContainsKey('ERROR')) { $err = [int]$re.Summary.ObservedCounts['ERROR'] }
+                                }
+
+                                # Deviations: OK / FP / ERROR
+                                $ok = 0; $fp = 0; $fn = 0; $derr = 0
+                                if ($re.Summary.DeviationCounts) {
+                                    if ($re.Summary.DeviationCounts.ContainsKey('OK'))    { $ok   = [int]$re.Summary.DeviationCounts['OK'] }
+                                    if ($re.Summary.DeviationCounts.ContainsKey('FP'))    { $fp   = [int]$re.Summary.DeviationCounts['FP'] }
+                                    if ($re.Summary.DeviationCounts.ContainsKey('FN'))    { $fn   = [int]$re.Summary.DeviationCounts['FN'] }
+                                    if ($re.Summary.DeviationCounts.ContainsKey('ERROR')) { $derr = [int]$re.Summary.DeviationCounts['ERROR'] }
+                                }
+
+                                $rt = [int]$re.Summary.RetestYes
+                                $sum = "üß† Regelkontroll: POS=$pos, NEG=$neg, Error=$err | OK=$ok, FP=$fp, FN=$fn, Minor Func=$derr | Instrument Error=$rt"
+                                Gui-Log -Text $sum -Severity Info -Category SUMMARY
+                            } catch { }
+                        }
+
+                        if ((Get-ConfigFlag -Name 'EnableShadowCompare' -Default $false -ConfigOverride $Config) -and $re.TopDeviations) {
+                            $n = 0
+                            foreach ($d in $re.TopDeviations) {
+                                $n++; if ($n -gt 20) { break }
+                                $msg = "‚ö†Ô∏è RuleEngine dev: " + ($d.Deviation + '') + " | " + ($d.SampleId + '') + " | Exp=" + ($d.ExpectedCall + '') + " | Obs=" + ($d.ObservedCall + '')
+                                if (($d.ErrorCode + '').Trim()) { $msg += " | Err=" + ($d.ErrorCode + '') }
+                                Gui-Log -Text $msg -Severity Info -Category RuleEngineDev
+                            }
+                        }
+                    }
+                }
+            }
+        } catch {
+            Gui-Log ("‚ö†Ô∏è RuleEngine (shadow) fel: " + $_.Exception.Message) 'Warn'
+        }
+
+        $controlTab = $null
+        if ($runAssay) { $controlTab = Get-ControlTabName -AssayName $runAssay }
+        if ($controlTab) { Gui-Log "üß™ Kontrollmaterial-flik: $controlTab" } else { Gui-Log "‚ÑπÔ∏è Ingen Kontrollmaterialsflik (forts√§tter utan)." }
+
+        # ============================
+        # === L√§s avvikelser       ===
+        # ============================
+
+        $violationsNeg = @(); $violationsPos = @(); $failNegCount = 0; $failPosCount = 0
+
+        foreach ($ws in $pkgNeg.Workbook.Worksheets) {
+            if ($ws.Name -eq "Worksheet Instructions") { continue }
+            if (-not $ws.Dimension) { continue }
+            $obsC = Find-ObservationCol $ws
+
+            for ($r = 3; $r -le 45; $r++) {
+                $valK = $ws.Cells["K$r"].Value
+                $textL = $ws.Cells["L$r"].Text
+
+                if ($valK -ne $null -and $valK -is [double]) {
+                    if ($textL -eq "FAIL" -or $valK -le -3.0) {
+                        $obsTxt = $ws.Cells[$r, $obsC].Text
+                        $violationsNeg += [PSCustomObject]@{
+                            Sheet      = $ws.Name
+                            Cartridge  = $ws.Cells["H$r"].Text
+                            InitialW   = $ws.Cells["I$r"].Value
+                            FinalW     = $ws.Cells["J$r"].Value
+                            WeightLoss = $valK
+                            Status     = if ($textL -eq "FAIL") { "FAIL" } else { "Minusv√§rde" }
+                            Obs        = $obsTxt
+                        }
+                        if ($textL -eq "FAIL") { $failNegCount++ }
+                    }
+                }
+            }
+        }
+
+        foreach ($ws in $pkgPos.Workbook.Worksheets) {
+            if ($ws.Name -eq "Worksheet Instructions") { continue }
+            if (-not $ws.Dimension) { continue }
+            $obsC = Find-ObservationCol $ws
+
+            for ($r = 3; $r -le 45; $r++) {
+                $valK = $ws.Cells["K$r"].Value
+                $textL = $ws.Cells["L$r"].Text
+
+                if ($valK -ne $null -and $valK -is [double]) {
+                    if ($textL -eq "FAIL" -or $valK -le -3.0) {
+                        $obsTxt = $ws.Cells[$r, $obsC].Text
+                        $violationsPos += [PSCustomObject]@{
+                            Sheet      = $ws.Name
+                            Cartridge  = $ws.Cells["H$r"].Text
+                            InitialW   = $ws.Cells["I$r"].Value
+                            FinalW     = $ws.Cells["J$r"].Value
+                            WeightLoss = $valK
+                            Status     = if ($textL -eq "FAIL") { "FAIL" } else { "Minusv√§rde" }
+                            Obs        = $obsTxt
+                        }
+                        if ($textL -eq "FAIL") { $failPosCount++ }
+                    }
+                }
+            }
+        }
+
+        # ============================
+        # === Seal Test Info (blad) ==
+        # ============================
+
+        $wsOut1 = $pkgOut.Workbook.Worksheets["Seal Test Info"]
+        if (-not $wsOut1) { Gui-Log "‚ùå Fliken 'Seal Test Info' saknas i mallen"; return }
+
+        for ($row = 3; $row -le 15; $row++) {
+            $wsOut1.Cells["D$row"].Value = $null
+            try { $wsOut1.Cells["D$row"].Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::None } catch {}
+        }
+
+        # --- Equipment expected list (optional) ---
+        $equip = $null
+        $equipPath = $null
+        try {
+            $equipPath = Get-ConfigValue -Name 'EquipmentXmlPath' -Default (Join-Path $PSScriptRoot 'equipment.xml') -ConfigOverride $null
+            if ($equipPath -and (Test-Path -LiteralPath $equipPath)) {
+                $equip = Import-Clixml -LiteralPath $equipPath
+            }
+        } catch {
+            $equip = $null
+        }
+
+        function _EquipTokens([string]$s) {
+            if ([string]::IsNullOrWhiteSpace($s)) { return @() }
+            $parts = $s -split '[,;]' | ForEach-Object { ($_ -replace '\s+', ' ').Trim() } | Where-Object { $_ }
+            $tok = @()
+            foreach ($p in $parts) {
+                $v = $p.ToUpper()
+                $v = $v -replace '^(NR\.?|NO\.?)\s*', ''
+                $v = $v -replace '[^\w\-]', ''
+                if ($v) { $tok += $v }
+            }
+            return ($tok | Sort-Object -Unique)
+        }
+
+        function _EquipMatch([string]$actual, [string]$expected) {
+            if ([string]::IsNullOrWhiteSpace($expected)) { return $null } # no reference
+            if ([string]::IsNullOrWhiteSpace($actual)) { return $false }
+            $aT = _EquipTokens $actual
+            $eT = _EquipTokens $expected
+            if ($aT.Count -eq 0) { return $false }
+            foreach ($a in $aT) { if ($eT -contains $a) { return $true } }
+            return $false
+        }
+
+        function _EquipMatchMonth([string]$actual, [string]$expected) {
+            if ([string]::IsNullOrWhiteSpace($expected)) { return $null }
+            if ([string]::IsNullOrWhiteSpace($actual)) { return $false }
+            $a = (Normalize-HeaderText $actual).Trim()
+            $e = (Normalize-HeaderText $expected).Trim()
+            return ($a.ToUpper() -eq $e.ToUpper())
+        }
+
+        $equipMap = @{
+            'Balance ID Number'        = @{ NegKey='SCALESNEG';       PosKey='SCALESPOS';       Mode='LIST'  }
+            'Balance Cal Due Date'     = @{ NegKey='CAL_D_SCALES';    PosKey='CAL_D_SCALES';    Mode='MONTH' }
+            'Vacuum Oven ID Number'    = @{ NegKey='OVENSNEG';        PosKey='OVENSPOS';        Mode='LIST'  }
+            'Vacuum Oven Cal Due Date' = @{ NegKey='CAL_D_OVENS';     PosKey='CAL_D_OVENS';     Mode='MONTH' }
+            'Timer ID Number'          = @{ NegKey='TIMERSNEG';       PosKey='TIMERSPOS';       Mode='LIST'  }
+            'Timer Cal Due Date'       = @{ NegKey='CAL_D_TIMERSNEG'; PosKey='CAL_D_TIMERSPOS'; Mode='MONTH' }
+        }
+
+
+        $fields = @(
+            @{ Label = "ROBAL";                         Cell = "F2"  }
+            @{ Label = "Part Number";                   Cell = "B2"  }
+            @{ Label = "Batch Number";                  Cell = "D2"  }
+            @{ Label = "Cartridge Number (LSP)";        Cell = "B6"  }
+            @{ Label = "PO Number";                     Cell = "B10" }
+            @{ Label = "Assay Family";                  Cell = "D10" }
+            @{ Label = "Weight Loss Spec";              Cell = "F10" }
+            @{ Label = "Balance ID Number";             Cell = "B14" }
+            @{ Label = "Balance Cal Due Date";          Cell = "D14" }
+            @{ Label = "Vacuum Oven ID Number";         Cell = "B20" }
+            @{ Label = "Vacuum Oven Cal Due Date";      Cell = "D20" }
+            @{ Label = "Timer ID Number";               Cell = "B25" }
+            @{ Label = "Timer Cal Due Date";            Cell = "D25" }
+        )
+
+        $forceText = @("ROBAL","Part Number","Batch Number","Cartridge Number (LSP)","PO Number","Assay Family","Balance ID Number","Vacuum Oven ID Number","Timer ID Number")
+        $mismatchFields = $fields[0..6] | ForEach-Object { $_.Label }
+
+        $row = 3
+        foreach ($f in $fields) {
+            $valNeg=''; $valPos=''
+
+            foreach ($wsN in $pkgNeg.Workbook.Worksheets) {
+                if ($wsN.Name -eq "Worksheet Instructions") { continue }
+                $cell = $wsN.Cells[$f.Cell]
+                if ($cell.Value -ne $null) {
+                    if ($cell.Value -is [datetime]) { $valNeg = $cell.Value.ToString('MMM-yy') } else { $valNeg = $cell.Text }
+                    break
+                }
+            }
+
+            foreach ($wsP in $pkgPos.Workbook.Worksheets) {
+                if ($wsP.Name -eq "Worksheet Instructions") { continue }
+                $cell = $wsP.Cells[$f.Cell]
+                if ($cell.Value -ne $null) {
+                    if ($cell.Value -is [datetime]) { $valPos = $cell.Value.ToString('MMM-yy') } else { $valPos = $cell.Text }
+                    break
+                }
+            }
+
+            if ($forceText -contains $f.Label) {
+                $wsOut1.Cells["B$row"].Style.Numberformat.Format = '@'
+                $wsOut1.Cells["C$row"].Style.Numberformat.Format = '@'
+            }
+
+            $wsOut1.Cells["B$row"].Value = $valNeg
+            $wsOut1.Cells["C$row"].Value = $valPos
+            $wsOut1.Cells["B$row"].Style.Border.Right.Style = "Medium"
+            $wsOut1.Cells["C$row"].Style.Border.Left.Style  = "Medium"
+
+        if ($mismatchFields -contains $f.Label) {
+                # D3:D9: visa tydlig Match/Mismatch med symboler
+                if ($valNeg -and $valPos) {
+                    if ($valNeg -ne $valPos) {
+                        $wsOut1.Cells["D$row"].Value = "‚ö† Mismatch"
+                        Style-Cell $wsOut1.Cells["D$row"] $true "FF0000" "Medium" "FFFFFF"
+                        Gui-Log "‚ö†Ô∏è Avvikelse: $($f.Label) (NEG='$valNeg' vs POS='$valPos')"
+                    } else {
+                        $wsOut1.Cells["D$row"].Value = "‚úì Match"
+                        Style-Cell $wsOut1.Cells["D$row"] $true "C6EFCE" "Medium" "006100"
+                    }
+                } elseif ($valNeg -or $valPos) {
+                    # Bara en av filerna har v√§rde - markera som varning
+                    $wsOut1.Cells["D$row"].Value = "‚ö† Saknas"
+                    Style-Cell $wsOut1.Cells["D$row"] $true "FFE699" "Medium" "806000"
+                }
+            }
+            # --- Equipment check (POS/NEG kan skilja) ---
+            if ($equip -and $equipMap.ContainsKey($f.Label)) {
+                $map = $equipMap[$f.Label]
+                $expNeg = $null; $expPos = $null
+                try { if ($equip.Contains($map.NegKey)) { $expNeg = (""+$equip[$map.NegKey]).Trim() } } catch {}
+                try { if ($equip.Contains($map.PosKey)) { $expPos = (""+$equip[$map.PosKey]).Trim() } } catch {}
+
+                $negOk = $null; $posOk = $null
+                if ($map.Mode -eq 'MONTH') {
+                    $negOk = _EquipMatchMonth $valNeg $expNeg
+                    $posOk = _EquipMatchMonth $valPos $expPos
+                } else {
+                    $negOk = _EquipMatch $valNeg $expNeg
+                    $posOk = _EquipMatch $valPos $expPos
+                }
+
+                # Style NEG cell (B)
+                if ($negOk -eq $true) {
+                    Style-Cell $wsOut1.Cells["B$row"] $false "C6EFCE" "Thin" "006100"
+                } elseif ($negOk -eq $false) {
+                    Style-Cell $wsOut1.Cells["B$row"] $false "FF0000" "Thin" "FFFFFF"
+                } elseif ($valNeg) {
+                    Style-Cell $wsOut1.Cells["B$row"] $false "FFE699" "Thin" "806000"
+                }
+
+                # Style POS cell (C)
+                if ($posOk -eq $true) {
+                    Style-Cell $wsOut1.Cells["C$row"] $false "C6EFCE" "Thin" "006100"
+                } elseif ($posOk -eq $false) {
+                    Style-Cell $wsOut1.Cells["C$row"] $false "FF0000" "Thin" "FFFFFF"
+                } elseif ($valPos) {
+                    Style-Cell $wsOut1.Cells["C$row"] $false "FFE699" "Thin" "806000"
+                }
+
+                # Optional status in D10:D15
+                $negTxt = if ($negOk -eq $true) { 'NEG ‚úì' } elseif ($negOk -eq $false) { 'NEG ‚ö†' } else { 'NEG ?' }
+                $posTxt = if ($posOk -eq $true) { 'POS ‚úì' } elseif ($posOk -eq $false) { 'POS ‚ö†' } else { 'POS ?' }
+                $wsOut1.Cells["D$row"].Value = ($negTxt + ' / ' + $posTxt)
+
+                if (($negOk -eq $false) -or ($posOk -eq $false)) {
+                    Style-Cell $wsOut1.Cells["D$row"] $true "FFCCCC" "Medium" "8B0000"
+                    if ($negOk -eq $false) { Gui-Log ("‚ö†Ô∏è Equipment mismatch (NEG): " + $f.Label + " actual='" + $valNeg + "' expected='" + $expNeg + "'") 'Warn' }
+                    if ($posOk -eq $false) { Gui-Log ("‚ö†Ô∏è Equipment mismatch (POS): " + $f.Label + " actual='" + $valPos + "' expected='" + $expPos + "'") 'Warn' }
+                } elseif (($negOk -eq $true) -and ($posOk -eq $true)) {
+                    Style-Cell $wsOut1.Cells["D$row"] $true "C6EFCE" "Medium" "006100"
+                } else {
+                    Style-Cell $wsOut1.Cells["D$row"] $true "FFE699" "Medium" "806000"
+                }
+            }
+
+            $row++
+        }
+
+        $wsOut1.Cells["D:D"].Style.WrapText = $false
+        $wsOut1.Column(4).AutoFit()
+        $wsOut1.Column(4).Width += 1.5
+        $wsOut1.Column(4).BestFit = $true
+
+        # ============================
+        # === Testare (B43)        ===
+        # ============================
+
+        $testersNeg = @(); $testersPos = @()
+        foreach ($s in $pkgNeg.Workbook.Worksheets | Where-Object { $_.Name -ne "Worksheet Instructions" }) {
+            $t=$s.Cells["B43"].Text
+            if ($t) { $testersNeg += ($t -split ",") }
+        }
+        foreach ($s in $pkgPos.Workbook.Worksheets | Where-Object { $_.Name -ne "Worksheet Instructions" }) {
+            $t=$s.Cells["B43"].Text
+            if ($t) { $testersPos += ($t -split ",") }
+        }
+        $testersNeg = $testersNeg | ForEach-Object { $_.Trim() } | Where-Object { $_ } | Sort-Object -Unique
+        $testersPos = $testersPos | ForEach-Object { $_.Trim() } | Where-Object { $_ } | Sort-Object -Unique
+
+        $wsOut1.Cells["B16"].Value = "Name of Tester"
+        $wsOut1.Cells["B16:C16"].Merge = $true
+        $wsOut1.Cells["B16"].Style.HorizontalAlignment = "Center"
+
+        $maxTesters = [Math]::Max($testersNeg.Count, $testersPos.Count)
+        $initialRows = 11
+        if ($maxTesters -lt $initialRows) { $wsOut1.DeleteRow(17 + $maxTesters, $initialRows - $maxTesters) }
+        if ($maxTesters -gt $initialRows) {
+            $rowsToAdd = $maxTesters - $initialRows
+            $lastRow = 16 + $initialRows
+            for ($i = 1; $i -le $rowsToAdd; $i++) { $wsOut1.InsertRow($lastRow + 1, 1, $lastRow) }
+        }
+
+        for ($i = 0; $i -lt $maxTesters; $i++) {
+            $rowIndex = 17 + $i
+            $wsOut1.Cells["A$rowIndex"].Value = $null
+            $wsOut1.Cells["B$rowIndex"].Value = if ($i -lt $testersNeg.Count) { $testersNeg[$i] } else { "N/A" }
+            $wsOut1.Cells["C$rowIndex"].Value = if ($i -lt $testersPos.Count) { $testersPos[$i] } else { "N/A" }
+
+            $topStyle    = if ($i -eq 0) { "Medium" } else { "Thin" }
+            $bottomStyle = if ($i -eq $maxTesters - 1) { "Medium" } else { "Thin" }
+
+            foreach ($col in @("B","C")) {
+                $cell = $wsOut1.Cells["$col$rowIndex"]
+                $cell.Style.Border.Top.Style    = $topStyle
+                $cell.Style.Border.Bottom.Style = $bottomStyle
+                $cell.Style.Border.Left.Style   = "Medium"
+                $cell.Style.Border.Right.Style  = "Medium"
+                $cell.Style.Fill.PatternType = "Solid"
+                $cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
+            }
+        }
+
+        # ============================
+        # === Signatur-j√§mf√∂relse  ===
+        # ============================
+
+        $negSigSet = Get-SignatureSetForDataSheets -Pkg $pkgNeg
+        $posSigSet = Get-SignatureSetForDataSheets -Pkg $pkgPos
+
+        $negSet = New-Object 'System.Collections.Generic.HashSet[string]'
+        $posSet = New-Object 'System.Collections.Generic.HashSet[string]'
+        foreach ($n in $negSigSet.NormSet) { [void]$negSet.Add($n) }
+        foreach ($p in $posSigSet.NormSet) { [void]$posSet.Add($p) }
+
+        $hasNeg = ($negSet.Count -gt 0)
+        $hasPos = ($posSet.Count -gt 0)
+
+        $onlyNeg = @(); $onlyPos = @(); $sigMismatch = $false
+        if ($hasNeg -and $hasPos) {
+            foreach ($n in $negSet) { if (-not $posSet.Contains($n)) { $onlyNeg += $n } }
+            foreach ($p in $posSet) { if (-not $negSet.Contains($p)) { $onlyPos += $p } }
+            $sigMismatch = ($onlyNeg.Count -gt 0 -or $onlyPos.Count -gt 0)
+        } else {
+            $sigMismatch = $false
+        }
+
+        $mismatchSheets = @()
+        if ($sigMismatch) {
+            foreach ($k in $onlyNeg) {
+                $raw = if ($negSigSet.RawByNorm.ContainsKey($k)) { $negSigSet.RawByNorm[$k] } else { $k }
+                $where = if ($negSigSet.Occ.ContainsKey($k)) { ($negSigSet.Occ[$k] -join ', ') } else { '‚Äî' }
+                $mismatchSheets += ("NEG: " + $raw + "  [Blad: " + $where + "]")
+            }
+            foreach ($k in $onlyPos) {
+                $raw = if ($posSigSet.RawByNorm.ContainsKey($k)) { $posSigSet.RawByNorm[$k] } else { $k }
+                $where = if ($posSigSet.Occ.ContainsKey($k)) { ($posSigSet.Occ[$k] -join ', ') } else { '‚Äî' }
+                $mismatchSheets += ("POS: " + $raw + "  [Blad: " + $where + "]")
+            }
+            Gui-Log "‚ö†Ô∏è Avvikelse: Print Full Name, Sign, and Date (NEG vs POS)"
+        }
+
+        if (-not (Get-Command Set-MergedWrapAutoHeight -ErrorAction SilentlyContinue)) {
+            function Set-MergedWrapAutoHeight {
+                param([OfficeOpenXml.ExcelWorksheet]$Sheet,[int]$RowIndex,[int]$ColStart=2,[int]$ColEnd=3,[string]$Text)
+                $rng = $Sheet.Cells[$RowIndex, $ColStart, $RowIndex, $ColEnd]
+                $rng.Style.WrapText = $true
+                $rng.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::None
+                $Sheet.Row($RowIndex).CustomHeight = $false
+                try {
+                    $wChars = [Math]::Floor(($Sheet.Column($ColStart).Width + $Sheet.Column($ColEnd).Width) - 2); if ($wChars -lt 1) { $wChars = 1 }
+                    $segments = $Text -split "(\r\n|\n|\r)"; $lineCount = 0
+                    foreach ($seg in $segments) { if (-not $seg) { $lineCount++ } else { $lineCount += [Math]::Ceiling($seg.Length / $wChars) } }
+                    if ($lineCount -lt 1) { $lineCount = 1 }
+                    $targetHeight = [Math]::Max(15, [Math]::Ceiling(15 * $lineCount * 2.15))
+                    if ($Sheet.Row($RowIndex).Height -lt $targetHeight) {
+                        $Sheet.Row($RowIndex).Height = $targetHeight
+                        $Sheet.Row($RowIndex).CustomHeight = $true
+                    }
+                } catch { $Sheet.Row($RowIndex).CustomHeight = $false }
+            }
+        }
+
+        $signRow = 17 + $maxTesters + 3
+        $displaySignNeg = $null; $displaySignPos = $null
+
+        if ($signToWrite) {
+            $displaySignNeg = $signToWrite
+            $displaySignPos = $signToWrite
+        } else {
+            $displaySignNeg = if ($negSigSet.RawFirst) { $negSigSet.RawFirst } else { '‚Äî' }
+            $displaySignPos = if ($posSigSet.RawFirst) { $posSigSet.RawFirst } else { '‚Äî' }
+        }
+
+        $wsOut1.Cells["B$signRow"].Style.Numberformat.Format = '@'
+        $wsOut1.Cells["C$signRow"].Style.Numberformat.Format = '@'
+        $wsOut1.Cells["B$signRow"].Value = $displaySignNeg
+        $wsOut1.Cells["C$signRow"].Value = $displaySignPos
+
+        foreach ($col in @('B','C')) {
+            $cell = $wsOut1.Cells["${col}$signRow"]
+            Style-Cell $cell $false 'CCFFFF' 'Medium' $null
+            $cell.Style.HorizontalAlignment = 'Center'
+        }
+
+        try { $wsOut1.Column(2).Width = 40; $wsOut1.Column(3).Width = 40 } catch {}
+        try { $wsOut1.Column(4).Width = 10 } catch {}
+
+        if ($sigMismatch) {
+            # === MISMATCH: R√∂d markering och detaljerad tabell med fet border ===
+            $mismatchCell = $wsOut1.Cells["D$signRow"]
+            $mismatchCell.Value = '‚ö† Mismatch'
+            Style-Cell $mismatchCell $true 'FF0000' 'Medium' 'FFFFFF'
+
+            if ($mismatchSheets.Count -gt 0) {
+                # Rubrikrad f√∂r mismatch-detaljer
+                $headerRow = $signRow + 1
+                $wsOut1.Cells["A$headerRow"].Value = 'Fil'
+                $wsOut1.Cells["B$headerRow"].Value = 'Signatur'
+                $wsOut1.Cells["C$headerRow"].Value = 'Blad'
+                foreach ($col in @('A','B','C')) {
+                    $hdrCell = $wsOut1.Cells["$col$headerRow"]
+                    $hdrCell.Style.Font.Bold = $true
+                    $hdrCell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+                    $hdrCell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#FFE699'))
+                    $hdrCell.Style.HorizontalAlignment = [OfficeOpenXml.Style.ExcelHorizontalAlignment]::Center
+                }
+
+                $lastDataRow = $headerRow
+                for ($j = 0; $j -lt $mismatchSheets.Count; $j++) {
+                    $rowIdx = $headerRow + 1 + $j
+                    $lastDataRow = $rowIdx
+                    $text = $mismatchSheets[$j]
+
+                    # Parsa "NEG: signatur  [Blad: namn]" eller "POS: signatur  [Blad: namn]"
+                    $filType = ''; $sigVal = ''; $bladVal = ''
+                    if ($text -match '^(NEG|POS):\s*(.+?)\s*\[Blad:\s*(.+?)\]$') {
+                        $filType = $matches[1]
+                        $sigVal  = $matches[2].Trim()
+                        $bladVal = $matches[3].Trim()
+                    } else {
+                        $sigVal = $text
+                    }
+
+                    $wsOut1.Cells["A$rowIdx"].Value = $filType
+                    $wsOut1.Cells["B$rowIdx"].Value = $sigVal
+                    $wsOut1.Cells["C$rowIdx"].Value = $bladVal
+
+                    # F√§rgkoda per fil
+                    $bgColor = if ($filType -eq 'NEG') { '#B5E6A2' } else { '#FFB3B3' }
+                    foreach ($col in @('A','B','C')) {
+                        $dataCell = $wsOut1.Cells["$col$rowIdx"]
+                        $dataCell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+                        $dataCell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml($bgColor))
+                    }
+                }
+                
+                # === FET YTTRE BORDER runt hela mismatch-tabellen ===
+                try {
+                    $borderColor = [System.Drawing.Color]::FromArgb(0, 0, 0) # SVART
+                    
+                    # Topp-border p√• header-raden
+                    for ($c = 1; $c -le 3; $c++) {
+                        $wsOut1.Cells[$headerRow, $c].Style.Border.Top.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
+                        $wsOut1.Cells[$headerRow, $c].Style.Border.Top.Color.SetColor($borderColor)
+                    }
+                    
+                    # Botten-border p√• sista data-raden
+                    for ($c = 1; $c -le 3; $c++) {
+                        $wsOut1.Cells[$lastDataRow, $c].Style.Border.Bottom.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
+                        $wsOut1.Cells[$lastDataRow, $c].Style.Border.Bottom.Color.SetColor($borderColor)
+                    }
+                    
+                    # V√§nster-border p√• kolumn A (alla rader)
+                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
+                        $wsOut1.Cells[$r, 1].Style.Border.Left.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
+                        $wsOut1.Cells[$r, 1].Style.Border.Left.Color.SetColor($borderColor)
+                    }
+                    
+                    # H√∂ger-border p√• kolumn C (alla rader)
+                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
+                        $wsOut1.Cells[$r, 3].Style.Border.Right.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thick
+                        $wsOut1.Cells[$r, 3].Style.Border.Right.Color.SetColor($borderColor)
+                    }
+                    
+                    # Inre tunna borders
+                    for ($r = $headerRow; $r -le $lastDataRow; $r++) {
+                        for ($c = 1; $c -le 3; $c++) {
+                            if ($r -lt $lastDataRow) {
+                                $wsOut1.Cells[$r, $c].Style.Border.Bottom.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+                            }
+                            if ($c -lt 3) {
+                                $wsOut1.Cells[$r, $c].Style.Border.Right.Style = [OfficeOpenXml.Style.ExcelBorderStyle]::Thin
+                            }
+                        }
+                    }
+                } catch {}
+            }
+        } else {
+            # === MATCH: Gr√∂n markering n√§r signaturer st√§mmer ===
+            if ($hasNeg -and $hasPos) {
+                $matchCell = $wsOut1.Cells["D$signRow"]
+                $matchCell.Value = '‚úì Match'
+                Style-Cell $matchCell $true 'C6EFCE' 'Medium' '006100'
+            }
+        }
+
+        # ============================
+        # === STF Sum              ===
+        # ============================
+
+        $wsOut2 = $pkgOut.Workbook.Worksheets["STF Sum"]
+        if (-not $wsOut2) { Gui-Log "‚ùå Fliken 'STF Sum' saknas i mallen!"; return }
+
+        $totalRows = $violationsNeg.Count + $violationsPos.Count
+        $currentRow = 2
+
+        if ($totalRows -eq 0) {
+            Gui-Log "‚úÖ Seal Test hittades"
+            $wsOut2.Cells["B1:H1"].Value = $null
+            $wsOut2.Cells["A1"].Value = "Inga STF hittades!"
+            Style-Cell $wsOut2.Cells["A1"] $true "D9EAD3" "Medium" "006100"
+            $wsOut2.Cells["A1"].Style.HorizontalAlignment = "Left"
+            if ($wsOut2.Dimension -and $wsOut2.Dimension.End.Row -gt 1) { $wsOut2.DeleteRow(2, $wsOut2.Dimension.End.Row - 1) }
+        }
+        else {
+            Gui-Log "‚ùó $failNegCount avvikelser i NEG, $failPosCount i POS"
+
+            $oldDataRows = 0
+            if ($wsOut2.Dimension) {
+                $oldDataRows = $wsOut2.Dimension.End.Row - 1
+                if ($oldDataRows -lt 0) { $oldDataRows = 0 }
+            }
+
+            if ($totalRows -lt $oldDataRows) {
+                $wsOut2.DeleteRow(2 + $totalRows, $oldDataRows - $totalRows)
+            }
+            elseif ($totalRows -gt $oldDataRows) {
+                $wsOut2.InsertRow(2 + $oldDataRows, $totalRows - $oldDataRows, 1 + $oldDataRows)
+            }
+
+            $currentRow = 2
+            foreach ($v in $violationsNeg) {
+                $wsOut2.Cells["A$currentRow"].Value = "NEG"
+                $wsOut2.Cells["B$currentRow"].Value = $v.Sheet
+                $wsOut2.Cells["C$currentRow"].Value = $v.Cartridge
+                $wsOut2.Cells["D$currentRow"].Value = $v.InitialW
+                $wsOut2.Cells["E$currentRow"].Value = $v.FinalW
+                $wsOut2.Cells["F$currentRow"].Value = [Math]::Round($v.WeightLoss, 1)
+                $wsOut2.Cells["G$currentRow"].Value = $v.Status
+                $wsOut2.Cells["H$currentRow"].Value = if ([string]::IsNullOrWhiteSpace($v.Obs)) { 'NA' } else { $v.Obs }
+
+                Style-Cell $wsOut2.Cells["A$currentRow"] $true "B5E6A2" "Medium" $null
+                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
+                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#FFFF99"))
+                $wsOut2.Cells["H$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["H$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#D9D9D9"))
+
+                if ($v.Status -in @("FAIL","Minusv√§rde")) {
+                    $wsOut2.Cells["F$currentRow"].Style.Font.Bold = $true
+                    $wsOut2.Cells["F$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
+                    $wsOut2.Cells["G$currentRow"].Style.Font.Bold = $true
+                    $wsOut2.Cells["G$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
+                }
+
+                Set-RowBorder -ws $wsOut2 -row $currentRow -firstRow 2 -lastRow ($totalRows + 1)
+                $currentRow++
+            }
+
+            foreach ($v in $violationsPos) {
+                $wsOut2.Cells["A$currentRow"].Value = "POS"
+                $wsOut2.Cells["B$currentRow"].Value = $v.Sheet
+                $wsOut2.Cells["C$currentRow"].Value = $v.Cartridge
+                $wsOut2.Cells["D$currentRow"].Value = $v.InitialW
+                $wsOut2.Cells["E$currentRow"].Value = $v.FinalW
+                $wsOut2.Cells["F$currentRow"].Value = [Math]::Round($v.WeightLoss, 1)
+                $wsOut2.Cells["G$currentRow"].Value = $v.Status
+                $wsOut2.Cells["H$currentRow"].Value = if ($v.Obs) { $v.Obs } else { 'NA' }
+
+                Style-Cell $wsOut2.Cells["A$currentRow"] $true "FFB3B3" "Medium" $null
+                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["C$currentRow:E$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#CCFFFF"))
+                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["F$currentRow:G$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#FFFF99"))
+                $wsOut2.Cells["H$currentRow"].Style.Fill.PatternType = "Solid"
+                $wsOut2.Cells["H$currentRow"].Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml("#D9D9D9"))
+
+                if ($v.Status -in @("FAIL","Minusv√§rde")) {
+                    $wsOut2.Cells["F$currentRow"].Style.Font.Bold = $true
+                    $wsOut2.Cells["F$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
+                    $wsOut2.Cells["G$currentRow"].Style.Font.Bold = $true
+                    $wsOut2.Cells["G$currentRow"].Style.Font.Color.SetColor([System.Drawing.Color]::Red)
+                }
+
+                Set-RowBorder -ws $wsOut2 -row $currentRow -firstRow 2 -lastRow ($totalRows + 1)
+                $currentRow++
+            }
+
+            $wsOut2.Cells.Style.WrapText = $false
+            $wsOut2.Cells["A1"].Style.HorizontalAlignment = "Left"
+            try { $wsOut2.Cells[2,6,([Math]::Max($currentRow-1,2)),6].Style.Numberformat.Format = '0.0' } catch {}
+            if ($wsOut2.Dimension) {
+                try {
+                    if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
+                        Safe-AutoFitColumns -Ws $wsOut2 -Context 'OutputSheet'
+                    } else {
+                        $wsOut2.Cells[$wsOut2.Dimension.Address].AutoFitColumns() | Out-Null
+                    }
+                } catch {}
+            }
+        }
+
+
+‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ# ============================
+# === Information-blad     ===
+# ============================
+
+try {
+    if (-not (Get-Command Add-Hyperlink -ErrorAction SilentlyContinue)) {
+        function Add-Hyperlink {
+            param(
+                [OfficeOpenXml.ExcelRange]$Cell,
+                [string]$Text,
+                [string]$Url
+            )
+            try {
+                $Cell.Value = $Text
+                $Cell.Hyperlink = [Uri]$Url
+                $Cell.Style.Font.UnderLine = $true
+                $Cell.Style.Font.Color.SetColor([System.Drawing.Color]::FromArgb(0,102,204))
+            } catch {}
+        }
+    }
+
+    if (-not (Get-Command Find-RegexCell -ErrorAction SilentlyContinue)) {
+        function Find-RegexCell {
+            param(
+                [OfficeOpenXml.ExcelWorksheet]$Ws,
+                [regex]$Rx,
+                [int]$MaxRows = 200,
+                [int]$MaxCols = 40
+            )
+            if (-not $Ws -or -not $Ws.Dimension) { return $null }
+
+            $rMax = [Math]::Min($Ws.Dimension.End.Row, $MaxRows)
+            $cMax = [Math]::Min($Ws.Dimension.End.Column, $MaxCols)
+
+            for ($r = 1; $r -le $rMax; $r++) {
+                for ($c = 1; $c -le $cMax; $c++) {
+                    $t = Normalize-HeaderText ($Ws.Cells[$r,$c].Text + '')
+                    if ($t -and $Rx.IsMatch($t)) {
+                        return @{ Row = $r; Col = $c; Text = $t }
+                    }
+                }
+            }
+            return $null
+        }
+    }
+
+    if (-not (Get-Command Get-SealHeaderDocInfo -ErrorAction SilentlyContinue)) {
+        function Get-SealHeaderDocInfo {
+            param([OfficeOpenXml.ExcelPackage]$Pkg)
+
+            $result = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' }
+            if (-not $Pkg) { return $result }
+
+            $ws = $Pkg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
+            if (-not $ws) { return $result }
+
+            try {
+                $lt = ($ws.HeaderFooter.OddHeader.LeftAlignedText + '').Trim()
+                if (-not $lt) { $lt = ($ws.HeaderFooter.EvenHeader.LeftAlignedText + '').Trim() }
+
+                $result.Raw = $lt
+
+                $rx = [regex]'(?i)(?:document\s*(?:no|nr|#|number)\s*[:#]?\s*([A-Z0-9\-_\.\/]+))?.*?(?:rev(?:ision)?\.?\s*[:#]?\s*([A-Z0-9\-_\.]+))?'
+                $m = $rx.Match($lt)
+                if ($m.Success) {
+                    if ($m.Groups[1].Value) { $result.DocNo = $m.Groups[1].Value.Trim() }
+                    if ($m.Groups[2].Value) { $result.Rev   = $m.Groups[2].Value.Trim() }
+                }
+            } catch {}
+
+            return $result
+        }
+    }
+
+    $wsInfo = $pkgOut.Workbook.Worksheets['Information']
+    if (-not $wsInfo) { $wsInfo = $pkgOut.Workbook.Worksheets.Add('Information') }
+
+    try { $wsInfo.Cells.Style.Font.Name = 'Arial'; $wsInfo.Cells.Style.Font.Size = 11 } catch {}
+
+    try {
+        $csvLines = $null
+        $csvStats = $null
+
+        # ‚úÖ Viktigt: initiera alltid, √§ven om ingen CSV √§r vald
+        $csvInstrumentSerials = @()
+
+        if ($selCsv -and (Test-Path -LiteralPath $selCsv)) {
+            try { $csvLines = Get-Content -LiteralPath $selCsv } catch { Gui-Log ("‚ö†Ô∏è Kunde inte l√§sa CSV: " + $_.Exception.Message) 'Warn' }
+            try { $csvStats = Get-CsvStats -Path $selCsv -Lines $csvLines } catch { Gui-Log ("‚ö†Ô∏è Get-CsvStats: " + $_.Exception.Message) 'Warn' }
+
+            # Extract exact Instrument S/N list from CSV (for Equipment sheet when WS scan is disabled)
+            try {
+                if ($csvLines -and $csvLines.Count -gt 8) {
+                    $hdr = ConvertTo-CsvFields $csvLines[7]
+
+                    $idx = -1
+                    for ($ii=0; $ii -lt $hdr.Count; $ii++) {
+                        $h = (($hdr[$ii] + '').Trim('\"').ToLower())
+                        if ($h -eq 'instrument s/n' -or $h -match 'instrument') { $idx = $ii; break }
+                    }
+
+                    if ($idx -ge 0) {
+                        $set = New-Object System.Collections.Generic.HashSet[string]
+                        for ($rr=9; $rr -lt $csvLines.Count; $rr++) {
+                            $ln = $csvLines[$rr]
+                            if (-not $ln -or -not $ln.Trim()) { continue }
+                            $f = ConvertTo-CsvFields $ln
+                            if ($f.Count -gt $idx) {
+                                $v = ($f[$idx] + '').Trim().Trim('\"')
+                                if ($v) { $null = $set.Add($v) }
+                            }
+                        }
+
+                        # HashSet[T] enumerate (PS 5.1 safe)
+                        $csvInstrumentSerials = @($set | Sort-Object)
+                    }
+                }
+            } catch {
+                Gui-Log ("‚ö†Ô∏è Kunde inte extrahera Instrument S/N fr√•n CSV: " + $_.Exception.Message) 'Warn'
+                $csvInstrumentSerials = @()
+            }
+        }
+
+        if (-not $csvStats) {
+            $csvStats = [pscustomobject]@{
+                TestCount    = 0
+                DupCount     = 0
+                Duplicates   = @()
+                LspValues    = @()
+                LspOK        = $null
+                InstrumentByType = [ordered]@{}
+            }
+        }
+
+        $infSN = @()
+        if ($script:GXINF_Map) {
+            foreach ($k in $script:GXINF_Map.Keys) {
+                if ($k -like 'Infinity-*') {
+                    $infSN += ($script:GXINF_Map[$k].Split(',') | ForEach-Object { ($_ + '').Trim() } | Where-Object { $_ })
+                }
+            }
+        }
+        $infSN = $infSN | Select-Object -Unique
+
+        $infSummary = '‚Äî'
+        try {
+            if ($selCsv -and (Test-Path -LiteralPath $selCsv) -and $infSN.Count -gt 0) {
+                $infSummary = Get-InfinitySpFromCsvStrict -Path $selCsv -InfinitySerials $infSN -Lines $csvLines
+            }
+        } catch {
+            Gui-Log ("Infinity SP fel: " + $_.Exception.Message) 'Warn'
+        }
+
+        # --- Dubbletter Sample ID ---
+        $dupSampleCount = 0
+        $dupSampleList  = @()
+        if ($csvLines -and $csvLines.Count -gt 8) {
+            try {
+                $headerFields = ConvertTo-CsvFields $csvLines[7]
+                $sampleIdx = -1
+                for ($i=0; $i -lt $headerFields.Count; $i++) {
+                    $hf = ($headerFields[$i] + '').Trim().ToLower()
+                    if ($hf -match 'sample') { $sampleIdx = $i; break }
+                }
+                if ($sampleIdx -ge 0) {
+                    $samples = @()
+                    for ($r=9; $r -lt $csvLines.Count; $r++) {
+                        $line = $csvLines[$r]
+                        if (-not $line -or -not $line.Trim()) { continue }
+                        $fields = ConvertTo-CsvFields $line
+                        if ($fields.Count -gt $sampleIdx) {
+                            $val = ($fields[$sampleIdx] + '').Trim()
+                            if ($val) { $samples += $val }
+                        }
+                    }
+                    if ($samples.Count -gt 0) {
+                        $counts = @{}
+                        foreach ($s in $samples) { if (-not $counts.ContainsKey($s)) { $counts[$s] = 0 }; $counts[$s]++ }
+                        foreach ($entry in $counts.GetEnumerator()) {
+                            if ($entry.Value -gt 1) { $dupSampleList += ("$($entry.Key) x$($entry.Value)") }
+                        }
+                        $dupSampleCount = $dupSampleList.Count
+                    }
+                }
+            } catch {
+                Gui-Log ("‚ö†Ô∏è Fel vid analys av Sample ID: " + $_.Exception.Message) 'Warn'
+            }
+        }
+
+        $dupSampleText = if ($dupSampleCount -gt 0) {
+            $show = ($dupSampleList | Select-Object -First 8) -join ', '
+            "$dupSampleCount ($show)"
+        } else { 'N/A' }
+
+        $dupCartText = if ($csvStats.DupCount -gt 0) {
+            $show = ($csvStats.Duplicates | Select-Object -First 8) -join ', '
+            "$($csvStats.DupCount) ($show)"
+        } else { 'N/A' }
+
+        # --- LSP summary ---
+        $lspSummary = ''
+        try {
+            if ($csvLines -and $csvLines.Count -gt 8) {
+                $counts = @{}
+                for ($rr = 9; $rr -lt $csvLines.Count; $rr++) {
+                    $ln = $csvLines[$rr]
+                    if (-not $ln -or -not $ln.Trim()) { continue }
+                    $fs = ConvertTo-CsvFields $ln
+                    if ($fs.Count -gt 4) {
+                        $raw = ($fs[4] + '').Trim()
+                        if ($raw) {
+                            $mLsp = [regex]::Match($raw,'(\d{5})')
+                            $code = if ($mLsp.Success) { $mLsp.Groups[1].Value } else { $raw }
+                            if (-not $counts.ContainsKey($code)) { $counts[$code] = 0 }
+                            $counts[$code]++
+                        }
+                    }
+                }
+
+                if ($counts.Count -gt 0) {
+                    $sorted = $counts.GetEnumerator() | Sort-Object Key
+                    $parts = @()
+                    foreach ($kvp in $sorted) {
+                        $parts += $(if ($kvp.Value -gt 1) { "$($kvp.Key) x$($kvp.Value)" } else { $kvp.Key })
+                    }
+                    if ($sorted.Count -eq 1) { $lspSummary = $sorted[0].Key }
+                    else { $lspSummary = "$($sorted.Count) (" + ($parts -join ', ') + ")" }
+                }
+            }
+        } catch {
+            Gui-Log ("‚ö†Ô∏è Fel vid extraktion av LSP fr√•n CSV: " + $_.Exception.Message) 'Warn'
+            $lspSummary = ''
+        }
+
+        $instText = if ($csvStats.InstrumentByType.Keys.Count -gt 0) {
+            ($csvStats.InstrumentByType.GetEnumerator() | ForEach-Object { "$($_.Key)" } | Sort-Object) -join '; '
+        } else { '' }
+
+        function Find-InfoRow {
+            param([OfficeOpenXml.ExcelWorksheet]$Ws, [string]$Label)
+            if (-not $Ws -or -not $Ws.Dimension) { return $null }
+            $maxRow = [Math]::Min($Ws.Dimension.End.Row, 300)
+            for ($ri=1; $ri -le $maxRow; $ri++) {
+                $txt = (($Ws.Cells[$ri,1].Text) + '').Trim()
+                if (-not $txt) { continue }
+                if ($txt.ToLowerInvariant() -eq $Label.ToLowerInvariant()) { return $ri }
+            }
+            return $null
+        }
+
+        # ‚úÖ Default: anta INTE new layout om vi inte hittar ankaret
+        $isNewLayout = $false
+        try {
+            $tmpRow = Find-InfoRow -Ws $wsInfo -Label 'CSV-Info'
+            if ($tmpRow) { $isNewLayout = $true }
+        } catch {}
+
+        $rowCsvFile    = Find-InfoRow -Ws $wsInfo -Label 'CSV'
+        $rowLsp        = Find-InfoRow -Ws $wsInfo -Label 'LSP'
+        $rowAntal      = Find-InfoRow -Ws $wsInfo -Label 'Antal tester'
+        $rowDupSample  = Find-InfoRow -Ws $wsInfo -Label 'Dubblett Sample ID'
+        if (-not $rowDupSample) { $rowDupSample = Find-InfoRow -Ws $wsInfo -Label 'Dublett Sample ID' }
+
+        $rowDupCart    = Find-InfoRow -Ws $wsInfo -Label 'Dubblett Cartridge S/N'
+        if (-not $rowDupCart) { $rowDupCart = Find-InfoRow -Ws $wsInfo -Label 'Dublett Cartridge S/N' }
+
+        $rowInst = Find-InfoRow -Ws $wsInfo -Label 'Anv√§nda INF/GX'
+
+        $rowBag = Find-InfoRow -Ws $wsInfo -Label 'Bag Numbers Tested Using Infinity'
+        if (-not $rowBag) { $rowBag = Find-InfoRow -Ws $wsInfo -Label 'Bag Numbers Tested Using Infinity:' }
+        if (-not $rowBag) { $rowBag = 14 }
+
+        $wsInfo.Cells["B$rowBag"].Style.Numberformat.Format = '@'
+        $wsInfo.Cells["B$rowBag"].Value = $infSummary
+
+        if ($isNewLayout) {
+            if (-not $rowCsvFile)   { $rowCsvFile   = 8 }
+            if (-not $rowLsp)       { $rowLsp       = 9 }
+            if (-not $rowAntal)     { $rowAntal     = 10 }
+            if (-not $rowDupSample) { $rowDupSample = 11 }
+            if (-not $rowDupCart)   { $rowDupCart   = 12 }
+            if (-not $rowInst)      { $rowInst      = 13 }
+        }
+
+        if ($selCsv) {
+            $wsInfo.Cells["B$rowCsvFile"].Style.Numberformat.Format = '@'
+            $wsInfo.Cells["B$rowCsvFile"].Value = (Split-Path $selCsv -Leaf)
+        } else {
+            $wsInfo.Cells["B$rowCsvFile"].Value = ''
+        }
+
+        $wsInfo.Cells["B$rowLsp"].Style.Numberformat.Format = '@'
+        $wsInfo.Cells["B$rowLsp"].Value = $(if ($lspSummary) { $lspSummary } else { $lsp })
+
+        # ‚úÖ Skriv Antal tester EN g√•ng (som text f√∂r att inte bli 1.00E+3 etc)
+        $wsInfo.Cells["B$rowAntal"].Style.Numberformat.Format = '@'
+        $wsInfo.Cells["B$rowAntal"].Value = "$($csvStats.TestCount)"
+
+        if ($rowDupSample) { $wsInfo.Cells["B$rowDupSample"].Value = $dupSampleText }
+        if ($rowDupCart)   { $wsInfo.Cells["B$rowDupCart"].Value   = $dupCartText }
+
+        if ($rowInst) { $wsInfo.Cells["B$rowInst"].Value = $instText }
+
+    } catch {
+        Gui-Log ("‚ö†Ô∏è CSV data-fel: " + $_.Exception.Message) 'Warn'
+    }
+
+    # --- Macro / docinfo ---
+    $assayForMacro = ''
+    if ($runAssay) { $assayForMacro = $runAssay }
+    elseif ($wsOut1) { $assayForMacro = ($wsOut1.Cells['D10'].Text + '').Trim() }
+
+    $miniVal = ''
+    if (Get-Command Get-MinitabMacro -ErrorAction SilentlyContinue) {
+        $miniVal = Get-MinitabMacro -AssayName $assayForMacro
+    }
+    if (-not $miniVal) { $miniVal = 'N/A' }
+
+    $hdNeg = $null; $hdPos = $null
+    try { $hdNeg = Get-SealHeaderDocInfo -Pkg $pkgNeg } catch {}
+    try { $hdPos = Get-SealHeaderDocInfo -Pkg $pkgPos } catch {}
+    if (-not $hdNeg) { $hdNeg = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' } }
+    if (-not $hdPos) { $hdPos = [pscustomobject]@{ Raw=''; DocNo=''; Rev='' } }
+
+    $wsInfo.Cells['B2'].Value = $ScriptVersion
+    $wsInfo.Cells['B3'].Value = $env:USERNAME
+    $wsInfo.Cells['B4'].Value = (Get-Date).ToString('yyyy-MM-dd HH:mm')
+    $wsInfo.Cells['B5'].Value = $miniVal
+
+    # --- Batch + l√§nkar ---
+    $selLsp = $null
+    try {
+        if (Get-Variable -Name clbLsp -ErrorAction SilentlyContinue) {
+            $selLsp = Get-CheckedFilePath $clbLsp
+        }
+    } catch {}
+
+    $batchInfo = Get-BatchLinkInfo -SealPosPath $selPos -SealNegPath $selNeg -Lsp $lspForLinks
+    $batch     = $batchInfo.Batch
+
+    $wsInfo.Cells['A34'].Value = 'SharePoint Batch'
+    $wsInfo.Cells['A34'].Style.Font.Bold = $true
+    Add-Hyperlink -Cell $wsInfo.Cells['B34'] -Text $batchInfo.LinkText -Url $batchInfo.Url
+
+    $linkMap = [ordered]@{
+        'IPT App'      = 'https://apps.powerapps.com/play/e/default-771c9c47-7f24-44dc-958e-34f8713a8394/a/fd340dbd-bbbf-470b-b043-d2af4cb62c83'
+        'MES Login'    = 'http://mes.cepheid.pri/camstarportal/?domain=CEPHEID.COM'
+        'CSV Uploader' = 'http://auw2wgxtpap01.cepaws.com/Welcome.aspx'
+        'BMRAM'        = 'https://cepheid62468.coolbluecloud.com/'
+        'Agile'        = 'https://agileprod.cepheid.com/Agile/default/login-cms.jsp'
+    }
+
+    $rowLink = 35
+    foreach ($key in $linkMap.Keys) {
+        $wsInfo.Cells["A$rowLink"].Value = $key
+        Add-Hyperlink -Cell $wsInfo.Cells["B$rowLink"] -Text 'L√ÑNK' -Url $linkMap[$key]
+        $rowLink++
+    }
+
+} catch {
+    Gui-Log ("‚ö†Ô∏è Information-blad fel: " + $_.Exception.Message) 'Warn'
+}
+‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ‚ÄÇ
+# ----------------------------------------------------------------
+# WS (LSP Worksheet): hitta fil och skriv in i Information-bladet
+# ----------------------------------------------------------------
+try {
+    if (-not $selLsp) {
+        $probeDir = $null
+        if ($selPos) { $probeDir = Split-Path -Parent $selPos }
+        if (-not $probeDir -and $selNeg) { $probeDir = Split-Path -Parent $selNeg }
+
+        if ($probeDir -and (Test-Path -LiteralPath $probeDir)) {
+            $cand = Get-ChildItem -LiteralPath $probeDir -File -ErrorAction SilentlyContinue |
+                    Where-Object {
+                        ($_.Name -match '(?i)worksheet') -and
+                        ($_.Name -match [regex]::Escape($lsp)) -and
+                        ($_.Extension -match '^\.(xlsx|xlsm|xls)$')
+                    } |
+                    Sort-Object LastWriteTime -Descending |
+                    Select-Object -First 1
+
+            if ($cand) { $selLsp = $cand.FullName }
+        }
+    }
+
+    if (-not (Get-Command Find-LabelValueRightward -ErrorAction SilentlyContinue)) {
+        function Find-LabelValueRightward {
+            param(
+                [OfficeOpenXml.ExcelWorksheet]$Ws,
+                [string]$Label,
+                [int]$MaxRows = 200,
+                [int]$MaxCols = 40
+            )
+            if (-not $Ws -or -not $Ws.Dimension) { return $null }
+
+            $normLbl = Normalize-HeaderText $Label
+            $pat = '^(?i)\s*' + [regex]::Escape($normLbl).Replace('\ ', '\s*') + '\s*[:\.]*\s*$'
+            $rx  = [regex]::new($pat, [Text.RegularExpressions.RegexOptions]::IgnoreCase)
+
+            $hit = Find-RegexCell -Ws $Ws -Rx $rx -MaxRows $MaxRows -MaxCols $MaxCols
+            if (-not $hit) { return $null }
+
+            $cMax = [Math]::Min($Ws.Dimension.End.Column, $MaxCols)
+            for ($c = $hit.Col + 1; $c -le $cMax; $c++) {
+                $t = Normalize-HeaderText ($Ws.Cells[$hit.Row,$c].Text + '')
+                if ($t) { return $t }
+            }
+            return $null
+        }
+    }
+
+    if ($selLsp -and (Test-Path -LiteralPath $selLsp)) {
+        Gui-Log ("üîé WS hittad: " + (Split-Path $selLsp -Leaf)) 'Info'
+    } else {
+        Gui-Log "‚ÑπÔ∏è Ingen WS-fil vald/hittad (LSP Worksheet). Hoppar √∂ver WS-extraktion." 'Info'
+    }
+} catch {
+    Gui-Log ("‚ö†Ô∏è WS-block fel: " + $_.Exception.Message) 'Warn'
+}
+
+try {
+    # ‚úÖ Se till att dessa alltid finns (de anv√§nds senare)
+    $headerWs  = $null
+    $headerNeg = $null
+    $headerPos = $null
+    # OBS: $eqInfo anv√§nds senare vid Equipment-blad ‚Üí init h√§r
+    if (-not (Get-Variable -Name eqInfo -Scope 1 -ErrorAction SilentlyContinue)) {
+        $eqInfo = $null
+    }
+
+    # --- WS √∂ppnas EN g√•ng och dispose:as alltid ---
+    $tmpPkg = $null
+    try {
+        if ($selLsp -and (Test-Path -LiteralPath $selLsp)) {
+            try {
+                $tmpPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($selLsp))
+
+                # ==============================
+                # ==============================
+                # Equipment / TestSummary
+                # ==============================
+                try {
+                    # NOTE (2026-02): "EquipmentSheet" ska endast generera sj√§lva BLADET/mallen.
+                    # Det ska *inte* automatiskt h√§mta pipetter/instrument fr√•n Test Summary/CSV h√§r,
+                    # annars blir det en blandning (auto + manuellt) som f√∂rvirrar anv√§ndaren.
+                    if ($Config -and $Config.Contains('EnableEquipmentSheet') -and -not $Config.EnableEquipmentSheet) {
+                        $eqInfo = $null
+                        Gui-Log '‚ÑπÔ∏è Utrustningslista avst√§ngt. Hoppar √∂ver.' 'Info'
+                    } else {
+                        $eqInfo = $null
+                        Gui-Log '‚úÖ Utrustningslista h√§mtad.' 'Info'
+                    }
+                } catch {
+                    # Utrustning ska aldrig f√• stoppa rapporten
+                    try { Gui-Log ("‚ö†Ô∏è Utrustningslista: kunde inte h√§mtas: " + $_.Exception.Message) 'Warn' } catch {}
+                    $eqInfo = $null
+                }
+
+                # Worksheet header (Extract + Compare)
+                # ==============================
+                try {
+                    $headerWs = Extract-WorksheetHeader -Pkg $tmpPkg
+                } catch {
+                    $headerWs = $null
+                }
+
+                # ‚úÖ Fallback om Extract gav null: skapa tomt objekt s√• .PartNo osv aldrig kraschar
+                if (-not $headerWs) {
+                    $headerWs = [pscustomobject]@{
+                        WorksheetName   = ''
+                        PartNo          = ''
+                        BatchNo         = ''
+                        CartridgeNo     = ''
+                        DocumentNumber  = ''
+                        Rev             = ''
+                        Effective       = ''
+                        Attachment      = ''
+                    }
+                }
+
+                try {
+                    $wsHeaderRows  = Get-WorksheetHeaderPerSheet -Pkg $tmpPkg
+                    $wsHeaderCheck = Compare-WorksheetHeaderSet   -Rows $wsHeaderRows
+                    try {
+                        if ($wsHeaderCheck.Issues -gt 0 -and $wsHeaderCheck.Summary) {
+                            Gui-Log ("‚ö†Ô∏è Worksheet header-avvikelser: {0} ‚Äì se Information!" -f $wsHeaderCheck.Summary) 'Warn'
+                        } else {
+                            Gui-Log "‚úÖ Worksheet header korrekt" 'Info'
+                        }
+                    } catch {}
+                } catch {
+                    # Beh√•ll tyst/robust; wsHeaderCheck anv√§nds senare om den finns
+                }
+
+                # ==============================
+                # F√∂rst√§rk headerWs via labels (om Extract missade)
+                # ==============================
+                try {
+                    $wsLsp = $tmpPkg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
+                    if ($wsLsp) {
+
+                        if (-not $headerWs.PartNo) {
+                            $val = $null
+                            $labels = @('Part No.','Part No.:','Part No','Part Number','Part Number:','Part Number.','Part Number.:')
+                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
+                            if ($val) { $headerWs.PartNo = $val }
+                        }
+
+                        if (-not $headerWs.BatchNo) {
+                            $val = $null
+                            $labels = @(
+                                'Batch No(s)','Batch No(s).','Batch No(s):','Batch No(s).:',
+                                'Batch No','Batch No.','Batch No:','Batch No.:',
+                                'Batch Number','Batch Number.','Batch Number:','Batch Number.:'
+                            )
+                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
+                            if ($val) { $headerWs.BatchNo = $val }
+                        }
+
+                        if (-not $headerWs.CartridgeNo -or $headerWs.CartridgeNo -eq '.') {
+                            $val = $null
+                            $labels = @(
+                                'Cartridge No. (LSP)','Cartridge No. (LSP):','Cartridge No. (LSP) :',
+                                'Cartridge No (LSP)','Cartridge No (LSP):','Cartridge No (LSP) :',
+                                'Cartridge Number (LSP)','Cartridge Number (LSP):','Cartridge Number (LSP) :',
+                                'Cartridge No.','Cartridge No.:','Cartridge No. :','Cartridge No :',
+                                'Cartridge Number','Cartridge Number:','Cartridge Number :',
+                                'Cartridge No','Cartridge No:','Cartridge No :'
+                            )
+                            foreach ($lbl in $labels) { $val = Find-LabelValueRightward -Ws $wsLsp -Label $lbl; if ($val) { break } }
+
+                            if (-not $val) {
+                                $rxCart = [regex]::new('(?i)Cartridge.*\(LSP\)')
+                                $maxCols = [Math]::Min($wsLsp.Dimension.End.Column, 100)
+                                $hitCart = Find-RegexCell -Ws $wsLsp -Rx $rxCart -MaxRows 200 -MaxCols $maxCols
+                                if ($hitCart) {
+                                    for ($c = $hitCart.Col + 1; $c -le $wsLsp.Dimension.End.Column; $c++) {
+                                        $cellVal = ($wsLsp.Cells[$hitCart.Row, $c].Text + '').Trim()
+                                        if ($cellVal) { $val = $cellVal; break }
+                                    }
+                                }
+                            }
+
+                            if ($val) { $headerWs.CartridgeNo = $val }
+                        }
+
+                        if (-not $headerWs.Effective) {
+                            $val = Find-LabelValueRightward -Ws $wsLsp -Label 'Effective'
+                            if (-not $val) { $val = Find-LabelValueRightward -Ws $wsLsp -Label 'Effective Date' }
+                            if ($val) { $headerWs.Effective = $val }
+                        }
+                    }
+                } catch {}
+
+                # Filename fallback f√∂r CartridgeNo om fortfarande tomt
+                try {
+                    if ($selLsp -and (-not $headerWs.CartridgeNo -or $headerWs.CartridgeNo -eq '.' -or $headerWs.CartridgeNo -eq '')) {
+                        $fn = Split-Path $selLsp -Leaf
+                        $m = [regex]::Matches($fn, '(?<!\d)(\d{5,7})(?!\d)')
+                        if ($m.Count -gt 0) { $headerWs.CartridgeNo = $m[0].Groups[1].Value }
+                    }
+                } catch {}
+
+            } catch {
+                # Om WS √∂ppnas men n√•got inne fallerar: l√•t det inte d√∂da hela rapporten
+                Gui-Log ("‚ö†Ô∏è WS-parse fel: " + $_.Exception.Message) 'Warn'
+            }
+        }
+    } finally {
+        if ($tmpPkg) { try { $tmpPkg.Dispose() } catch {} }
+    }
+
+    # SealTest headers (beh√•ll som du hade)
+    try { $headerNeg = Extract-SealTestHeader -Pkg $pkgNeg } catch {}
+    try { $headerPos = Extract-SealTestHeader -Pkg $pkgPos } catch {}
+
+    # Effective fallback f√∂r Seal POS/NEG om saknas (din logik, of√∂r√§ndrad)
+    try {
+        if ($pkgPos -and $headerPos -and -not $headerPos.Effective) {
+            $wsPos = $pkgPos.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
+            if ($wsPos) {
+                $val = Find-LabelValueRightward -Ws $wsPos -Label 'Effective'
+                if (-not $val) { $val = Find-LabelValueRightward -Ws $wsPos -Label 'Effective Date' }
+                if ($val) { $headerPos.Effective = $val }
+            }
+        }
+    } catch {}
+
+    try {
+        if ($pkgNeg -and $headerNeg -and -not $headerNeg.Effective) {
+            $wsNeg = $pkgNeg.Workbook.Worksheets | Where-Object { $_.Name -ne 'Worksheet Instructions' } | Select-Object -First 1
+            if ($wsNeg) {
+                $val = Find-LabelValueRightward -Ws $wsNeg -Label 'Effective'
+                if (-not $val) { $val = Find-LabelValueRightward -Ws $wsNeg -Label 'Effective Date' }
+                if ($val) { $headerNeg.Effective = $val }
+            }
+        }
+    } catch {}
+
+    # --------------------------
+    # Header summary ‚Üí Information
+    # --------------------------
+    try {
+        $wsBatch   = if ($headerWs -and $headerWs.BatchNo) { $headerWs.BatchNo } else { $null }
+        $sealBatch = $batch
+        if (-not $sealBatch) {
+            try { if ($selPos) { $sealBatch = Get-BatchNumberFromSealFile $selPos } } catch {}
+            if (-not $sealBatch) { try { if ($selNeg) { $sealBatch = Get-BatchNumberFromSealFile $selNeg } } catch {} }
+        }
+
+        $rowWsFile = Find-InfoRow -Ws $wsInfo -Label 'Worksheet'
+        if (-not $rowWsFile) { $rowWsFile = 17 }
+        $rowPart  = $rowWsFile + 1
+        $rowBatch = $rowWsFile + 2
+        $rowCart  = $rowWsFile + 3
+        $rowDoc   = $rowWsFile + 4
+        $rowRev   = $rowWsFile + 5
+        $rowEff   = $rowWsFile + 6
+
+        $rowPosFile = Find-InfoRow -Ws $wsInfo -Label 'Seal Test POS'
+        if (-not $rowPosFile) { $rowPosFile = $rowWsFile + 7 }
+        $rowPosDoc = $rowPosFile + 1
+        $rowPosRev = $rowPosFile + 2
+        $rowPosEff = $rowPosFile + 3
+
+        $rowNegFile = Find-InfoRow -Ws $wsInfo -Label 'Seal Test NEG'
+        if (-not $rowNegFile) { $rowNegFile = $rowPosFile + 4 }
+        $rowNegDoc = $rowNegFile + 1
+        $rowNegRev = $rowNegFile + 2
+        $rowNegEff = $rowNegFile + 3
+
+        if ($selLsp) {
+            $wsInfo.Cells["B$rowWsFile"].Style.Numberformat.Format = '@'
+            $wsInfo.Cells["B$rowWsFile"].Value = (Split-Path $selLsp -Leaf)
+        } else {
+            $wsInfo.Cells["B$rowWsFile"].Value = ''
+        }
+
+        $consPart  = Get-ConsensusValue -Type 'Part'      -Ws $headerWs.PartNo      -Pos $headerPos.PartNumber   -Neg $headerNeg.PartNumber
+        $consBatch = Get-ConsensusValue -Type 'Batch'     -Ws $headerWs.BatchNo     -Pos $headerPos.BatchNumber  -Neg $headerNeg.BatchNumber
+        $consCart  = Get-ConsensusValue -Type 'Cartridge' -Ws $headerWs.CartridgeNo -Pos $headerPos.CartridgeNo  -Neg $headerNeg.CartridgeNo
+
+        if (-not $consCart.Value -and $selLsp) {
+            $fnCart = Split-Path $selLsp -Leaf
+            $mCart  = [regex]::Match($fnCart,'(?<!\d)(\d{5,7})(?!\d)')
+            if ($mCart.Success) {
+                $consCart = @{ Value=$mCart.Groups[1].Value; Source='FILENAME'; Note='Filename fallback' }
+            }
+        }
+
+        $wsInfo.Cells["B$rowPart"].Value  = if ($consPart.Value)  { $consPart.Value }  else { '' }
+        $wsInfo.Cells["B$rowBatch"].Value = if ($consBatch.Value) { $consBatch.Value } else { '' }
+        $wsInfo.Cells["B$rowCart"].Value  = if ($consCart.Value)  { $consCart.Value }  else { '' }
+
+        # wsHeaderCheck ‚Üí skriv Match/Mismatch i C-kolumn f√∂r Part/Batch/Cartridge
+        try {
+            # Helper f√∂r att styla mismatch-cell med r√∂d bakgrund
+            $StyleMismatchCell = {
+                param($Cell, $Text)
+                $Cell.Style.Numberformat.Format = '@'
+                $Cell.Value = '‚ö† ' + $Text
+                $Cell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+                $Cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#FFCCCC'))
+                $Cell.Style.Font.Bold = $true
+                $Cell.Style.Font.Color.SetColor([System.Drawing.Color]::DarkRed)
+            }
+
+            # Helper f√∂r att styla match-cell med gr√∂n bakgrund
+            $StyleMatchCell = {
+                param($Cell)
+                $Cell.Style.Numberformat.Format = '@'
+                $Cell.Value = '‚úì Alla flikar matchar'
+                $Cell.Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
+                $Cell.Style.Fill.BackgroundColor.SetColor([System.Drawing.ColorTranslator]::FromHtml('#C6EFCE'))
+                $Cell.Style.Font.Bold = $true
+                $Cell.Style.Font.Color.SetColor([System.Drawing.ColorTranslator]::FromHtml('#006100'))
+            }
+
+            $devPart = $null; $devBatch = $null; $devCart = $null
+
+            # Parsa eventuella avvikelser fr√•n wsHeaderCheck
+            if ($wsHeaderCheck -and $wsHeaderCheck.Details) {
+                $linesDev = ($wsHeaderCheck.Details -split "`r?`n")
+                foreach ($ln in $linesDev) {
+                    if ($ln -match '^-\s*PartNo[^:]*:\s*(.+)$')      { $devPart  = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*BatchNo[^:]*:\s*(.+)$') { $devBatch = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*CartridgeNo[^:]*:\s*(.+)$') { $devCart = $matches[1].Trim() }
+                }
+            }
+
+            # Visa Match eller Mismatch f√∂r varje f√§lt (endast om wsHeaderCheck k√∂rdes)
+            if ($wsHeaderCheck) {
+                if ($devPart)  { & $StyleMismatchCell $wsInfo.Cells["C$rowPart"]  ('Avvikande: ' + $devPart) }
+                else           { & $StyleMatchCell $wsInfo.Cells["C$rowPart"] }
+                
+                if ($devBatch) { & $StyleMismatchCell $wsInfo.Cells["C$rowBatch"] ('Avvikande: ' + $devBatch) }
+                else           { & $StyleMatchCell $wsInfo.Cells["C$rowBatch"] }
+                
+                if ($devCart)  { & $StyleMismatchCell $wsInfo.Cells["C$rowCart"]  ('Avvikande: ' + $devCart) }
+                else           { & $StyleMatchCell $wsInfo.Cells["C$rowCart"] }
+            }
+        } catch {}
+
+        # WS metadata + Match-kontroll
+        if ($headerWs) {
+            $doc = $headerWs.DocumentNumber
+            if ($doc) { $doc = ($doc -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$', '').Trim() }
+            if ($headerWs.Attachment -and ($doc -notmatch '(?i)\bAttachment\s+\w+\b')) {
+                $doc = "$doc Attachment $($headerWs.Attachment)"
+            }
+            $wsInfo.Cells["B$rowDoc"].Value = $doc
+            $wsInfo.Cells["B$rowRev"].Value = $headerWs.Rev
+            $wsInfo.Cells["B$rowEff"].Value = $headerWs.Effective
+            
+            # Visa "‚úì Alla flikar matchar" f√∂r WS-f√§lt (om wsHeaderCheck k√∂rdes och f√§lten finns)
+            if ($wsHeaderCheck -and $doc) { & $StyleMatchCell $wsInfo.Cells["C$rowDoc"] }
+            if ($wsHeaderCheck -and $headerWs.Rev) { & $StyleMatchCell $wsInfo.Cells["C$rowRev"] }
+            if ($wsHeaderCheck -and $headerWs.Effective) { & $StyleMatchCell $wsInfo.Cells["C$rowEff"] }
+        } else {
+            $wsInfo.Cells["B$rowDoc"].Value = ''
+            $wsInfo.Cells["B$rowRev"].Value = ''
+            $wsInfo.Cells["B$rowEff"].Value = ''
+        }
+
+        # POS file + metadata + Match-kontroll
+        if ($selPos) {
+            $wsInfo.Cells["B$rowPosFile"].Style.Numberformat.Format = '@'
+            $wsInfo.Cells["B$rowPosFile"].Value = (Split-Path $selPos -Leaf)
+        } else { $wsInfo.Cells["B$rowPosFile"].Value = '' }
+
+        if ($headerPos) {
+            $docPos = $headerPos.DocumentNumber
+            if ($docPos) { $docPos = ($docPos -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$','').Trim() }
+            $wsInfo.Cells["B$rowPosDoc"].Value = $docPos
+            $wsInfo.Cells["B$rowPosRev"].Value = $headerPos.Rev
+            $wsInfo.Cells["B$rowPosEff"].Value = $headerPos.Effective
+            
+            # Visa Match/Mismatch f√∂r POS-f√§lt (verifiera alla flikar i POS-filen)
+            $posHeaderCheck = $null
+            try { $posHeaderCheck = $headerPos.HeaderCheck } catch {}
+            $devPosDoc = $null; $devPosRev = $null; $devPosEff = $null
+
+            if ($posHeaderCheck -and $posHeaderCheck.Details) {
+                $linesDev = ($posHeaderCheck.Details -split "`r?`n")
+                foreach ($ln in $linesDev) {
+                    if ($ln -match '^-\s*DocumentNumber[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devPosDoc = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*Rev[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devPosRev = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*Effective[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devPosEff = $matches[1].Trim() }
+                }
+            }
+
+            if ($posHeaderCheck) {
+                if ($docPos) {
+                    if ($devPosDoc) { & $StyleMismatchCell $wsInfo.Cells["C$rowPosDoc"] ('Avvikande flikar: ' + $devPosDoc) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowPosDoc"] }
+                }
+                if ($headerPos.Rev) {
+                    if ($devPosRev) { & $StyleMismatchCell $wsInfo.Cells["C$rowPosRev"] ('Avvikande flikar: ' + $devPosRev) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowPosRev"] }
+                }
+                if ($headerPos.Effective) {
+                    if ($devPosEff) { & $StyleMismatchCell $wsInfo.Cells["C$rowPosEff"] ('Avvikande flikar: ' + $devPosEff) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowPosEff"] }
+                }
+            } else {
+                # Fallback: om HeaderCheck saknas (√§ldre funktion), g√∂r inte falsk "match" ‚Äì bara l√§mna tomt
+                # (v√§rdena st√•r redan i B-kolumnen)
+            }
+        } else {
+            $wsInfo.Cells["B$rowPosDoc"].Value = ''
+            $wsInfo.Cells["B$rowPosRev"].Value = ''
+            $wsInfo.Cells["B$rowPosEff"].Value = ''
+        }
+
+        # NEG file + metadata + Match-kontroll
+        if ($selNeg) {
+            $wsInfo.Cells["B$rowNegFile"].Style.Numberformat.Format = '@'
+            $wsInfo.Cells["B$rowNegFile"].Value = (Split-Path $selNeg -Leaf)
+        } else { $wsInfo.Cells["B$rowNegFile"].Value = '' }
+
+        if ($headerNeg) {
+            $docNeg = $headerNeg.DocumentNumber
+            if ($docNeg) { $docNeg = ($docNeg -replace '(?i)\s+(?:Rev(?:ision)?|Effective|p\.)\b.*$','').Trim() }
+            $wsInfo.Cells["B$rowNegDoc"].Value = $docNeg
+            $wsInfo.Cells["B$rowNegRev"].Value = $headerNeg.Rev
+            $wsInfo.Cells["B$rowNegEff"].Value = $headerNeg.Effective
+            
+            # Visa Match/Mismatch f√∂r NEG-f√§lt (verifiera alla flikar i NEG-filen)
+            $negHeaderCheck = $null
+            try { $negHeaderCheck = $headerNeg.HeaderCheck } catch {}
+            $devNegDoc = $null; $devNegRev = $null; $devNegEff = $null
+
+            if ($negHeaderCheck -and $negHeaderCheck.Details) {
+                $linesDev = ($negHeaderCheck.Details -split "`r?`n")
+                foreach ($ln in $linesDev) {
+                    if ($ln -match '^-\s*DocumentNumber[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devNegDoc = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*Rev[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devNegRev = $matches[1].Trim() }
+                    elseif ($ln -match '^-\s*Effective[^|]*\|\s*avvikande flikar:\s*(.+)$') { $devNegEff = $matches[1].Trim() }
+                }
+            }
+
+            if ($negHeaderCheck) {
+                if ($docNeg) {
+                    if ($devNegDoc) { & $StyleMismatchCell $wsInfo.Cells["C$rowNegDoc"] ('Avvikande flikar: ' + $devNegDoc) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowNegDoc"] }
+                }
+                if ($headerNeg.Rev) {
+                    if ($devNegRev) { & $StyleMismatchCell $wsInfo.Cells["C$rowNegRev"] ('Avvikande flikar: ' + $devNegRev) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowNegRev"] }
+                }
+                if ($headerNeg.Effective) {
+                    if ($devNegEff) { & $StyleMismatchCell $wsInfo.Cells["C$rowNegEff"] ('Avvikande flikar: ' + $devNegEff) }
+                    else { & $StyleMatchCell $wsInfo.Cells["C$rowNegEff"] }
+                }
+            } else {
+                # Fallback: om HeaderCheck saknas (√§ldre funktion), g√∂r inte falsk "match" ‚Äì bara l√§mna tomt
+            }
+        } else {
+            $wsInfo.Cells["B$rowNegDoc"].Value = ''
+            $wsInfo.Cells["B$rowNegRev"].Value = ''
+            $wsInfo.Cells["B$rowNegEff"].Value = ''
+        }
+
+    } catch {
+        Gui-Log ("‚ö†Ô∏è Header summary fel: " + $_.Exception.Message) 'Warn'
+    }
+
+} catch {
+    Gui-Log "‚ö†Ô∏è Information-blad fel: $($_.Exception.Message)" 'Warn'
+}
+
+# ============================
+# === SharePoint / Equipment / Control / Watermark / Tabs / Save & Audit
+# ============================
+
+# ============================
+# === Equipment-blad       ===
+# ============================
+# OBS: Endast mall kopieras - ingen automatisk ifyllning av pipetter/instrument.
+# Anv√§ndaren fyller i manuellt i output-filen.
+if ($Config -and $Config.Contains('EnableEquipmentSheet') -and -not $Config.EnableEquipmentSheet) {
+    Gui-Log '‚ÑπÔ∏è Equipment-blad avst√§ngt. Hoppar √∂ver Infinity/GX.' 'Info'
+} else {
+    try {
+        if (Test-Path -LiteralPath $UtrustningListPath) {
+            $srcPkg = $null
+            try {
+                $srcPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($UtrustningListPath))
+
+                $srcWs = $srcPkg.Workbook.Worksheets['Sheet1']
+                if (-not $srcWs) { $srcWs = $srcPkg.Workbook.Worksheets[1] }
+
+                if ($srcWs) {
+                    # Ta bort befintlig flik om den finns
+                    $wsEq = $pkgOut.Workbook.Worksheets['Infinity/GX']
+                    if ($wsEq) { $pkgOut.Workbook.Worksheets.Delete($wsEq) }
+
+                    # Kopiera mallen som en ny flik
+                    $wsEq = $pkgOut.Workbook.Worksheets.Add('Infinity/GX', $srcWs)
+
+                    # Ta bort formler och beh√•ll bara v√§rden
+                    if ($wsEq.Dimension) {
+                        foreach ($cell in $wsEq.Cells[$wsEq.Dimension.Address]) {
+                            if ($cell.Formula -or $cell.FormulaR1C1) {
+                                $val = $cell.Value
+                                $cell.Formula     = $null
+                                $cell.FormulaR1C1 = $null
+                                $cell.Value       = $val
+                            }
+                        }
+                        # Kopiera kolumnbredder
+                        $colCount = $srcWs.Dimension.End.Column
+                        for ($c = 1; $c -le $colCount; $c++) {
+                            try { $wsEq.Column($c).Width = $srcWs.Column($c).Width } catch {}
+                        }
+                    }
+                    Gui-Log "‚úÖ Utrustningslista kopierad." 'Info'
+                }
+            } finally {
+                if ($srcPkg) { try { $srcPkg.Dispose() } catch {} }
+            }
+        } else {
+            Gui-Log ("‚ÑπÔ∏è Utrustningslista saknas: $UtrustningListPath") 'Info'
+        }
+    } catch {
+        Gui-Log "‚ö†Ô∏è Kunde inte skapa Utrustningslista-flik: $($_.Exception.Message)" 'Warn'
+    }
+}
+
+# === Control Material     ===
+# ============================
+try {
+    if ($controlTab -and (Test-Path -LiteralPath $RawDataPath)) {
+        $srcPkg = $null
+        try {
+            $srcPkg = New-Object OfficeOpenXml.ExcelPackage (New-Object IO.FileInfo($RawDataPath))
+            try { $srcPkg.Workbook.Calculate() } catch {}
+
+            $candidates = if ($controlTab -match '\|') {
+                $controlTab -split '\|' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
+            } else { @($controlTab) }
+
+            $srcWs = $null
+            foreach ($cand in $candidates) {
+                $srcWs = $srcPkg.Workbook.Worksheets | Where-Object { $_.Name -eq $cand } | Select-Object -First 1
+                if ($srcWs) { break }
+                $srcWs = $srcPkg.Workbook.Worksheets | Where-Object { $_.Name -like "*$cand*" } | Select-Object -First 1
+                if ($srcWs) { break }
+            }
+
+            if ($srcWs) {
+                $safeName = if ($srcWs.Name.Length -gt 31) { $srcWs.Name.Substring(0,31) } else { $srcWs.Name }
+                $destName = $safeName; $n = 1
+                while ($pkgOut.Workbook.Worksheets[$destName]) {
+                    $base = if ($safeName.Length -gt 27) { $safeName.Substring(0,27) } else { $safeName }
+                    $destName = "$base($n)"; $n++
+                }
+
+                $wsCM = $pkgOut.Workbook.Worksheets.Add($destName, $srcWs)
+                if ($wsCM.Dimension) {
+                    foreach ($cell in $wsCM.Cells[$wsCM.Dimension.Address]) {
+                        if ($cell.Formula -or $cell.FormulaR1C1) {
+                            $v = $cell.Value
+                            $cell.Formula = $null
+                            $cell.FormulaR1C1 = $null
+                            $cell.Value = $v
+                        }
+                    }
+                    try {
+                        if (Get-Command Safe-AutoFitColumns -ErrorAction SilentlyContinue) {
+                            Safe-AutoFitColumns -Ws $wsCM -Context 'ControlMaterial'
+                        } else {
+                            $wsCM.Cells[$wsCM.Dimension.Address].AutoFitColumns() | Out-Null
+                        }
+                    } catch {}
+                }
+
+                Gui-Log "‚úÖ Kontrollmaterial: '$($srcWs.Name)' ‚Üí '$destName'" 'Info'
+            } else {
+                Gui-Log "‚ÑπÔ∏è Hittade inget blad i kontrollfilen som matchar '$controlTab'." 'Info'
+            }
+        } finally {
+            if ($srcPkg) { try { $srcPkg.Dispose() } catch {} }
+        }
+    } else {
+        Gui-Log "‚ÑπÔ∏è Ingen Control-flik skapad (saknar mappning eller kontrollfil)." 'Info'
+    }
+} catch {
+    Gui-Log "‚ö†Ô∏è Control Material-fel: $($_.Exception.Message)" 'Warn'
+}
+
+# ============================
+# === SharePoint Info      ===
+# ============================
+try {
+    $skipSpInfo = -not $global:SpEnabled  # Always include SharePoint Info unless disabled in config
+
+    if ($skipSpInfo) {
+        Gui-Log "‚ÑπÔ∏è SharePoint Info avst√§ngt i konfigurationen ‚Äì hoppar √∂ver." 'Info'
+        try {
+            $old = $pkgOut.Workbook.Worksheets["SharePoint Info"]
+            if ($old) { $pkgOut.Workbook.Worksheets.Delete($old) }
+        } catch {}
+    } else {
+
+        $spOk = $false
+        if ($global:SpConnected) { $spOk = $true }
+        elseif (Get-Command Get-PnPConnection -ErrorAction SilentlyContinue) {
+            try { $null = Get-PnPConnection; $spOk = $true } catch { $spOk = $false }
+        }
+
+        if (-not $spOk) {
+            $errMsg = if ($global:SpError) { $global:SpError } else { 'Ok√§nt fel' }
+            Gui-Log ("‚ö†Ô∏è SharePoint ej tillg√§ngligt: $errMsg") 'Warn'
+        }
+
+        $batchInfo = Get-BatchLinkInfo -SealPosPath $selPos -SealNegPath $selNeg -Lsp $lspForLinks
+        $batch = $batchInfo.Batch
+
+        if (-not $batch) {
+            Gui-Log "‚ÑπÔ∏è Inget Batch # i POS/NEG ‚Äì skriver SharePoint Info i 'Information'." 'Info'
+
+            # Skriv tomt block (1:1 layout) in i Information (till h√∂ger)
+            [void](Write-SPBlockIntoInformation -Pkg $pkgOut -Rows @() -Batch '‚Äî' -TargetSheetName 'Information' -StartRow 1 -StartCol 5)
+
+            # S√§kerst√§ll att separat flik inte finns kvar (banta rapporten)
+            try {
+                $old = $pkgOut.Workbook.Worksheets["SharePoint Info"]
+                if ($old) { $pkgOut.Workbook.Worksheets.Delete($old) }
+            } catch {}
+        } else {
+            Gui-Log "üîé Batch hittad: $batch" 'Info'
+
+            $fields = @(
+                'Work_x0020_Center','Title','Batch_x0023_','SAP_x0020_Batch_x0023__x0020_2',
+                'LSP','Material','BBD_x002f_SLED','Actual_x0020_startdate_x002f__x0',
+                'PAL_x0020__x002d__x0020_Sample_x','Sample_x0020_Reagent_x0020_P_x00',
+                'Order_x0020_quantity','Total_x0020_good','ITP_x0020_Test_x0020_results',
+                'IPT_x0020__x002d__x0020_Testing_0','MES_x0020__x002d__x0020_Order_x0'
+            )
+            $renameMap = @{
+                'Work Center'            = 'Work Center'
+                'Title'                  = 'Order#'
+                'Batch#'                 = 'SAP Batch#'
+                'SAP Batch# 2'           = 'SAP Batch# 2'
+                'LSP'                    = 'LSP'
+                'Material'               = 'Material'
+                'BBD/SLED'               = 'BBD/SLED'
+                'Actual startdate/_x0'   = 'ROBAL - Actual start date/time'
+                'PAL - Sample_x'         = 'Sample Reagent use'
+                'Sample Reagent P'       = 'Sample Reagent P/N'
+                'Order quantity'         = 'Order quantity'
+                'Total good'             = 'ROBAL - Till Packning'
+                'IPT Test results'       = 'IPT Test results'
+                'IPT - Testing_0'        = 'IPT - Testing Finalized'
+                'MES - Order_x0'         = 'MES Order'
+            }
+
+            $desiredOrder = @(
+                'Work Center','Order#','SAP Batch#','SAP Batch# 2','LSP','Material','BBD/SLED',
+                'ROBAL - Actual start date/time','Sample Reagent use','Sample Reagent P/N',
+                'Order quantity','ROBAL - Till Packning','IPT Test results',
+                'IPT - Testing Finalized','MES Order'
+            )
+
+            $dateFields      = @('BBD/SLED','ROBAL - Actual start date/time','IPT - Testing Finalized')
+            $shortDateFields = @('BBD/SLED')
+
+            $rows = @()
+            if ($spOk) {
+                try {
+                    $items = Get-PnPListItem -List "Cepheid | Production orders" -Fields $fields -PageSize 2000 -ErrorAction Stop
+                    $match = $items | Where-Object {
+                        $v1 = $_['Batch_x0023_']; $v2 = $_['SAP_x0020_Batch_x0023__x0020_2']
+                        $s1 = if ($null -ne $v1) { ([string]$v1).Trim() } else { '' }
+                        $s2 = if ($null -ne $v2) { ([string]$v2).Trim() } else { '' }
+                        $s1 -eq $batch -or $s2 -eq $batch
+                    } | Select-Object -First 1
+
+                    if ($match) {
+                        foreach ($f in $fields) {
+                            $val = $match[$f]
+                            $label = $f -replace '_x0020_', ' ' `
+                                         -replace '_x002d_', '-' `
+                                         -replace '_x0023_', '#' `
+                                         -replace '_x002f_', '/' `
+                                         -replace '_x2013_', '‚Äì' `
+                                         -replace '_x00',''
+                            $label = $label.Trim()
+                            if ($renameMap.ContainsKey($label)) { $label = $renameMap[$label] }
+
+                            if ($null -ne $val -and $val -ne '') {
+                                if ($val -eq $true) { $val = 'JA' }
+                                elseif ($val -eq $false) { $val = 'NEJ' }
+
+                                $dt = $null
+                                if ($val -is [datetime]) { $dt = [datetime]$val }
+                                else { try { $dt = [datetime]::Parse($val) } catch { $dt = $null } }
+
+                                if ($dt -ne $null -and ($dateFields -contains $label)) {
+                                    $fmt = if ($shortDateFields -contains $label) { 'yyyy-MM-dd' } else { 'yyyy-MM-dd HH:mm' }
+                                    $val = $dt.ToString($fmt)
+                                }
+
+                                $rows += [pscustomobject]@{ Rubrik = $label; 'V√§rde' = $val }
+                            }
+                        }
+
+                        if ($rows.Count -gt 0) {
+                            $ordered = @()
+                            foreach ($label in $desiredOrder) {
+                                $hit = $rows | Where-Object { $_.Rubrik -eq $label } | Select-Object -First 1
+                                if ($hit) { $ordered += $hit }
+                            }
+                            if ($ordered.Count -gt 0) { $rows = $ordered }
+                        }
+
+                        Gui-Log "üìÑ SharePoint-post hittad ‚Äì skriver blad." 'Info'
+                    } else {
+                        Gui-Log "‚ÑπÔ∏è Ingen post i SharePoint f√∂r Batch=$batch." 'Info'
+                    }
+                } catch {
+                    Gui-Log "‚ö†Ô∏è SP: Get-PnPListItem misslyckades: $($_.Exception.Message)" 'Warn'
+                }
+            }
+
+            # Skriv SharePoint Info i 'Information' (till h√∂ger), 1:1 rubrik/v√§rde
+            [void](Write-SPBlockIntoInformation -Pkg $pkgOut -Rows $rows -Batch $batch -TargetSheetName 'Information' -StartRow 1 -StartCol 5)
+
+            # S√§kerst√§ll att separat flik inte finns kvar (banta rapporten)
+            try {
+                $old = $pkgOut.Workbook.Worksheets["SharePoint Info"]
+                if ($old) { $pkgOut.Workbook.Worksheets.Delete($old) }
+            } catch {}
+
+            try {
+                if ($slBatchLink -and $batch) {
+                    $slBatchLink.Text = "SharePoint: $batch"
+                    $slBatchLink.Tag  = $batchInfo.Url
+                    $slBatchLink.Enabled = $true
+                }
+            } catch {}
+
+            try {
+                $wsSP = $pkgOut.Workbook.Worksheets['Information']
+                if ($wsSP) {
+                    $labelCol = 5; $valueCol = 6  # SharePoint-blocken ligger i E:F
+                    for ($r = 1; $r -le 120; $r++) {
+                        if ((Normalize-HeaderText (($wsSP.Cells[$r,$labelCol].Text + '')).Trim()) -ieq 'Sample Reagent use') {
+                            $wsSP.Cells[$r,$valueCol].Style.WrapText = $true
+                            $wsSP.Cells[$r,$valueCol].Style.VerticalAlignment = [OfficeOpenXml.Style.ExcelVerticalAlignment]::Top
+                            try { $wsSP.Column($valueCol).Width = 55 } catch {}
+                            $wsSP.Row($r).CustomHeight = $true
+                            break
+                        }
+                    }
+                }
+            } catch {
+                Gui-Log "‚ö†Ô∏è WrapText p√• 'Sample Reagent use' misslyckades: $($_.Exception.Message)" 'Warn'
+            }
+        }
+    }
+} catch {
+    Gui-Log "‚ö†Ô∏è SP-blad: $($_.Exception.Message)" 'Warn'
+}
+
+# ============================
+# === Header watermark     ===
+# ============================
+try {
+    foreach ($ws in $pkgOut.Workbook.Worksheets) {
+        try {
+            $ws.HeaderFooter.OddHeader.CenteredText   = '&"Arial,Bold"&14 UNCONTROLLED'
+            $ws.HeaderFooter.EvenHeader.CenteredText  = '&"Arial,Bold"&14 UNCONTROLLED'
+            $ws.HeaderFooter.FirstHeader.CenteredText = '&"Arial,Bold"&14 UNCONTROLLED'
+        } catch {
+            Gui-Log ("‚ö†Ô∏è Kunde inte s√§tta header p√• blad: " + $ws.Name) 'Warn'
+        }
+    }
+} catch {
+    Gui-Log "‚ö†Ô∏è Fel vid vattenst√§mpling av rapporten." 'Warn'
+}
+
+# ============================
+# === Tab-f√§rger (innan Save)
+# ============================
+try {
+    $wsT = $pkgOut.Workbook.Worksheets['Information'];     if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 52, 152, 219) }
+    $wsT = $pkgOut.Workbook.Worksheets['Infinity/GX'];     if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 33, 115, 70) }
+    $wsT = $pkgOut.Workbook.Worksheets['SharePoint Info']; if ($wsT) { $wsT.TabColor = [System.Drawing.Color]::FromArgb(255, 0, 120, 212) }
+} catch {
+    Gui-Log "‚ö†Ô∏è Kunde inte s√§tta tab-f√§rg: $($_.Exception.Message)" 'Warn'
+}
+
+        # ============================
+        # === Spara & Audit        ===
+        # ============================
+
+        $nowTs    = Get-Date -Format "yyyyMMdd_HHmmss"
+        $baseName = "$($env:USERNAME)_output_${lsp}_$nowTs.xlsx"# (GUI-val borttaget) Spara alltid i tempor√§r katalog
+$saveDir  = $env:TEMP
+$SavePath = Join-Path $saveDir $baseName
+Gui-Log "üíæ Sparl√§ge: Tempor√§rt ‚Üí $SavePath"
+try {
+            $pkgOut.Workbook.View.ActiveTab = 0
+            $wsInitial = $pkgOut.Workbook.Worksheets["Information"]
+            if ($wsInitial) { $wsInitial.View.TabSelected = $true }
+
+            # ============================
+            # === RuleEngine Debug Sheet ==
+            # ============================
+            try {
+                if ((Get-ConfigFlag -Name 'EnableRuleEngine' -Default $false -ConfigOverride $Config) -and
+                    (Get-ConfigFlag -Name 'EnableRuleEngineDebugSheet' -Default $false -ConfigOverride $Config) -and
+                    $selCsv -and (Test-Path -LiteralPath $selCsv)) {
+
+                    # Om shadow saknas/tom: bygg fr√•n cache i f√∂rsta hand
+                    if (-not $script:RuleEngineShadow -or -not $script:RuleEngineShadow.Rows -or $script:RuleEngineShadow.Rows.Count -eq 0) {
+
+                        Gui-Log "üß† Regelbank: saknas vid Save ‚Üí bygger nu..." 'Warn'
+
+                        $rb2 = $script:RuleBankCache
+                        if (-not $rb2) {
+                            $rb2 = Load-RuleBank -RuleBankDir $Config.RuleBankDir
+                            try { $rb2 = Compile-RuleBank -RuleBank $rb2 } catch {}
+                        }
+
+                        $csvObjs2 = $script:RuleEngineCsvObjs
+                        if (-not $csvObjs2 -or $csvObjs2.Count -eq 0) {
+                            $csvObjs2 = @()
+                            if ($csvRows -and $csvRows.Count -gt 0) {
+                                $csvObjs2 = @($csvRows)
+                            } else {
+                                try {
+                                    $all = Get-Content -LiteralPath $selCsv
+                                    if ($all -and $all.Count -gt 9) {
+                                        $hdr = ConvertTo-CsvFields $all[7]
+                                        $dl  = $all[9..($all.Count-1)] | Where-Object { $_ -and $_.Trim() }
+                                        $del = Get-CsvDelimiter -Path $selCsv
+                                        $csvObjs2 = @(ConvertFrom-Csv -InputObject ($dl -join "`n") -Delimiter $del -Header $hdr)
+                                    }
+                                } catch { $csvObjs2 = @() }
+                            }
+                        }
+
+                        if ($csvObjs2 -and $csvObjs2.Count -gt 0) {
+                            $script:RuleEngineShadow = Invoke-RuleEngine -CsvObjects $csvObjs2 -RuleBank $rb2 -CsvPath $selCsv
+                        } else {
+                            Gui-Log "‚ö†Ô∏è Regelbank: kunde inte bygga vid Save (0 rader)." 'Warn'
+                        }
+                    }
+
+                    if ($script:RuleEngineShadow -and $script:RuleEngineShadow.Rows -and $script:RuleEngineShadow.Rows.Count -gt 0) {
+                        Gui-Log "üß† Skriver Sammanfattning av CSV..." 'Info'
+                        $includeAll = Get-ConfigFlag -Name 'RuleEngineDebugIncludeAllRows' -Default $false -ConfigOverride $Config
+                        [void](Write-RuleEngineDebugSheet -Pkg $pkgOut -RuleEngineResult $script:RuleEngineShadow -IncludeAllRows $includeAll)
+                    } else {
+                        Gui-Log "‚ö†Ô∏è RuleEngine_Debug hoppar √∂ver: inget RuleEngine-resultat." 'Warn'
+                    }
+                }
+            } catch {
+                Gui-Log ("‚ö†Ô∏è Kunde inte skriva RuleEngine_Debug: " + $_.Exception.Message) 'Warn'
+            }
+
+            Set-UiStep 90 'Sparar rapport‚Ä¶'
+            $pkgOut.SaveAs($SavePath)
+            Set-UiStep 100 'Klar ‚úÖ'
+            Gui-Log -Text ("‚úÖ Rapport sparad: {0}" -f $SavePath) -Severity Info -Category RESULT
+            $global:LastReportPath = $SavePath
+
+            # Audit (beh√•ll din befintliga audit-logik; den funkar som den √§r)
+            try {
+                $auditDir = Join-Path $PSScriptRoot 'audit'
+                if (-not (Test-Path $auditDir)) { New-Item -ItemType Directory -Path $auditDir -Force | Out-Null }
+
+                $auditObj = [pscustomobject]@{
+                    DatumTid        = (Get-Date).ToString('yyyy-MM-dd HH:mm:ss')
+                    Anv√§ndare       = $env:USERNAME
+                    LSP             = $lsp
+                    ValdCSV         = if ($selCsv) { Split-Path $selCsv -Leaf } else { '' }
+                    ValdSealNEG     = Split-Path $selNeg -Leaf
+                    ValdSealPOS     = Split-Path $selPos -Leaf
+                    SignaturSkriven = if ($chkWriteSign.Checked) { 'Ja' } else { 'Nej' }
+                    OverwroteSign   = if ($chkOverwriteSign.Checked) { 'Ja' } else { 'Nej' }
+                    SigMismatch     = if ($sigMismatch) { 'Ja' } else { 'Nej' }
+                    MismatchSheets  = if ($mismatchSheets -and $mismatchSheets.Count -gt 0) { ($mismatchSheets -join ';') } else { '' }
+                    ViolationsNEG   = $violationsNeg.Count
+                    ViolationsPOS   = $violationsPos.Count
+                    Violations      = ($violationsNeg.Count + $violationsPos.Count)
+                    Sparl√§ge        = 'Tempor√§rt'
+                    OutputFile      = $SavePath
+                    Kommentar       = 'UNCONTROLLED rapport, ingen k√§llfil √§ndrades automatiskt.'
+                    ScriptVersion   = $ScriptVersion
+                }
+
+                $auditFile = Join-Path $auditDir ("$($env:USERNAME)_audit_${nowTs}.csv")
+                $auditObj | Export-Csv -Path $auditFile -NoTypeInformation -Encoding UTF8
+
+                try {
+                    $statusText = 'OK'
+                    if (($violationsNeg.Count + $violationsPos.Count) -gt 0 -or $sigMismatch -or ($mismatchSheets -and $mismatchSheets.Count -gt 0)) {
+                        $statusText = 'Warnings'
+                    }
+                    $auditTests = $null
+                    try { if ($csvStats) { $auditTests = $csvStats.TestCount } } catch {}
+                    Add-AuditEntry -Lsp $lsp -Assay $runAssay -BatchNumber $batch -TestCount $auditTests -Status $statusText -ReportPath $SavePath
+                } catch {
+                    Gui-Log "‚ö†Ô∏è Kunde inte skriva audit-CSV: $($_.Exception.Message)" 'Warn'
+                }
+            } catch {
+                Gui-Log "‚ö†Ô∏è Kunde inte skriva revisionsfil: $($_.Exception.Message)" 'Warn'
+            }
+
+            try { Start-Process -FilePath "excel.exe" -ArgumentList "`"$SavePath`"" } catch {}
+        }
+        catch {
+            Gui-Log "‚ö†Ô∏è Kunde inte spara/√∂ppna: $($_.Exception.Message)" 'Warn'
+        }
+
+    } finally {
+        try { if ($pkgNeg) { $pkgNeg.Dispose() } } catch {}
+        try { if ($pkgPos) { $pkgPos.Dispose() } } catch {}
+        try { if ($pkgOut) { $pkgOut.Dispose() } } catch {}
+        Set-UiBusy -Busy $false
+        $script:BuildInProgress = $false
+    }
+})
+
+#endregion Event Handlers
+
+# === Tooltip-inst√§llningar ===
+$toolTip = New-Object System.Windows.Forms.ToolTip
+$toolTip.AutoPopDelay = 8000
+$toolTip.InitialDelay = 500
+$toolTip.ReshowDelay  = 500
+$toolTip.ShowAlways   = $true
+$toolTip.SetToolTip($txtLSP, 'Ange LSP-numret utan "#" och klicka p√• S√∂k filer.')
+$toolTip.SetToolTip($btnScan, 'S√∂k efter LSP och lista tillg√§ngliga filer.')
+$toolTip.SetToolTip($clbCsv,  'V√§lj CSV-fil.')
+$toolTip.SetToolTip($clbNeg,  'V√§lj Seal Test Neg-fil.')
+$toolTip.SetToolTip($clbPos,  'V√§lj Seal Test Pos-fil.')
+$toolTip.SetToolTip($btnCsvBrowse, 'Bl√§ddra efter en CSV-fil manuellt.')
+$toolTip.SetToolTip($btnNegBrowse, 'Bl√§ddra efter Seal Test Neg-fil manuellt.')
+$toolTip.SetToolTip($btnPosBrowse, 'Bl√§ddra efter Seal Test Pos-fil manuellt.')
+$toolTip.SetToolTip($txtSigner, 'Skriv fullst√§ndigt namn, signatur och datum (separerat med kommatecken).')
+$toolTip.SetToolTip($chkWriteSign, 'Signatur appliceras p√• flikar.')
+$toolTip.SetToolTip($chkOverwriteSign, 'Dubbelkontroll f√∂r att aktivera signering')
+$miToggleSign.ToolTipText = 'Visa eller d√∂lj panelen f√∂r att l√§gga till signatur.'
+if ($rbSaveInLsp) { $toolTip.SetToolTip($rbSaveInLsp, 'Spara rapporten i mappen f√∂r ditt LSP.') }
+if ($rbTempOnly) { $toolTip.SetToolTip($rbTempOnly, 'Skapa rapporten tempor√§r utan att spara.') }
+$toolTip.SetToolTip($btnBuild, 'Skapa och √∂ppna rapporten baserat p√• de valda filerna.')
+if ($chkSharePointInfo) { $toolTip.SetToolTip($chkSharePointInfo, 'Exportera med SharePoint Info.') }
+$txtLSP.add_TextChanged({ Update-BatchLink })
+
+#region Main Run / Orchestration
+# =============== SLUT ===============
+function Enable-DoubleBuffer {
+    $pi = [Windows.Forms.Control].GetProperty('DoubleBuffered',[Reflection.BindingFlags]'NonPublic,Instance')
+    foreach($c in @($content,$pLog,$grpPick,$grpSign,$grpSave)) { if ($c) { $pi.SetValue($c,$true,$null) } }
+}
+try { Set-Theme 'light' } catch {}
+Enable-DoubleBuffer
+Update-BatchLink
+[System.Windows.Forms.Application]::Run($form)
+
+try{ Stop-Transcript | Out-Null }catch{}
+#endregion Main Run / Orchestration
--- /mnt/data/IPTCompile_orig/IPTCompile/zz_IPTCompile/Modules/Config.ps1	2026-02-03 22:18:17.000000000 +0000
+++ /mnt/data/IPTCompile_ex/IPTCompile/zz_IPTCompile/Modules/Config.ps1	2026-02-10 12:06:58.184238432 +0000
@@ -86,7 +86,7 @@
     return (Resolve-IptPath $NetworkPath)
 }
 
-$ScriptVersion = "v80.01"
+$ScriptVersion = "v89.01"
 
 $RootPaths = @(
     (Join-Path $script:DefaultIptRoot 'Skiftspecifika dokument\PQC analyst\JESPER\Scripts\Tests'),
@@ -106,7 +106,7 @@
 $OtherScriptPath = ''
 
 $Script1Path = (Join-Path $script:DefaultIptRoot '8. IPT - WR + Rework\1. PQC - Kontrollprovsfil - R√ñR EJ -\Script Raw Data\Kontrollprovsfil_EPPlus_2025_ver3.ps1')
-$Script2Path = Resolve-IptPath (Join-Path $script:DefaultIptRoot 'N:\QC\QC-1\IPT\8. IPT - WR + Rework\1. PQC - Kontrollprovsfil - R√ñR EJ -\Script Raw Data\aktivera_makro.ps1')
+$Script2Path = Resolve-IptPath (Join-Path $script:DefaultIptRoot '8. IPT - WR + Rework\1. PQC - Kontrollprovsfil - R√ñR EJ -\Script Raw Data\aktivera_makro.ps1')
 $Script3Path = Resolve-IptPath (Join-Path $script:DefaultIptRoot 'Skiftspecifika dokument\PQC analyst\JESPER\Scripts\zz_IPTCompile_Shortcut\rename-GUI.bat')
 
 $env:PNPPOWERSHELL_UPDATECHECK = "Off"
@@ -118,6 +118,7 @@
 $Config = [ordered]@{
     AppName               = 'IPTCompile'
     EntryPointFolderName  = 'zz_IPTCompile'
+    HelpFeedbackDir = (Resolve-IptPath (Join-Path $script:DefaultIptRoot 'Skiftspecifika dokument\PQC analyst\JESPER\zz_IPTCompile\help'))
 
     EnableEquipmentSheet          = $true
     EnableEquipmentScan           = $true
@@ -153,9 +154,18 @@
     EpplusDllPath = (Join-Path $ScriptRoot 'Modules\EPPlus.dll')
     EpplusVersion = '4.5.3.3'
     AllowNuGetDownload = $false
-
+    
     NetworkOnlyFileNames = @('KONTROLLPROVSFIL - Version 2.5.xlsm')
 
+
+
+    # P/N som gul-highlightas i SharePoint Info-blocket (Sample Reagent P/N + Sample Reagent use)
+    SampleReagentChecklistPNs = @(
+        '700-6052','700-6609','700-8870','700-6822',
+        '700-5280','700-5197','700-6787','700-5375',
+        '700-4521','700-4383','700-5194','700-5666',
+        '700-5667','700-5196','700-5662','700-6379'
+    )
 ShortcutGroups = [ordered]@{
     'üóÇÔ∏è IPT-mappar' = @(
         @{ Text='üìÇ IPT - P√ÖG√ÖENDE K√ñRNINGAR';        Target=(Resolve-IptPath (Join-Path $script:DefaultIptRoot '2. IPT - P√ÖG√ÖENDE K√ñRNINGAR')) },
